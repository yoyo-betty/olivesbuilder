<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Olives Builder</title>
<link href="https://fonts.googleapis.com/css2?family=IBM+Plex+Mono:wght@400;500&family=Outfit:wght@300;400;500;600;700&display=swap" rel="stylesheet">
<style>
*,*::before,*::after{box-sizing:border-box;margin:0;padding:0}
:root{
  --bg:#0e1017;--surface:#161921;--surface2:#1c2030;--surface3:#222638;
  --border:#252a3a;--border2:#2e3448;
  --text:#e2e6f0;--text2:#8892aa;--text3:#4a5270;
  --accent:#4ade80;--accent2:#22c55e;

  /* Grid constants */
  --col-w:170px;   /* horizontal step between columns */
  --row-h:190px;   /* vertical step between branch rows ‚Äî generous spacing */
  --node-w:96px;   /* node card width */
  --node-h:96px;   /* node card height */
}
html,body{height:100%;overflow:hidden;font-family:'Outfit',sans-serif;background:var(--bg);color:var(--text)}

/* ‚îÄ‚îÄ LAYOUT: canvas takes maximum space ‚îÄ‚îÄ */
.app{display:grid;grid-template-rows:44px 1fr 32px;grid-template-columns:260px 1fr;height:100vh}

/* ‚îÄ‚îÄ TOPBAR ‚îÄ‚îÄ */
.topbar{
  grid-column:1/-1;grid-row:1;
  background:var(--surface);border-bottom:1px solid var(--border);
  display:flex;align-items:center;padding:0 14px;gap:0;z-index:200;
}
.logo{display:flex;align-items:center;gap:7px;margin-right:18px;flex-shrink:0}
.logo-mark{width:26px;height:26px;border-radius:7px;background:linear-gradient(135deg,#22c55e,#16a34a);display:flex;align-items:center;justify-content:center;font-size:13px;font-weight:700;color:#fff;box-shadow:0 0 10px rgba(34,197,94,0.3)}
.logo-text{font-size:13px;font-weight:600;color:var(--text)}
.vsep{width:1px;height:24px;background:var(--border);margin:0 12px}
.campaign-name{font-size:13px;font-weight:500;color:var(--text);background:transparent;border:none;outline:none;border-bottom:1px solid transparent;padding:2px 4px;transition:border-color 0.2s;min-width:200px}
.campaign-name:focus{border-bottom-color:var(--accent)}
.topbar-status{display:flex;align-items:center;gap:5px;font-size:10px;font-family:'IBM Plex Mono',monospace;color:var(--text3);margin-left:8px}
.status-dot{width:6px;height:6px;border-radius:50%;background:#f59e0b;animation:pulse 2s infinite}
@keyframes pulse{0%,100%{opacity:1}50%{opacity:0.4}}
.topbar-actions{margin-left:auto;display:flex;align-items:center;gap:6px}
.btn{display:flex;align-items:center;gap:5px;padding:5px 11px;border-radius:6px;font-size:11px;font-weight:500;font-family:'Outfit',sans-serif;cursor:pointer;border:1px solid transparent;transition:all 0.15s;white-space:nowrap}
.btn-ghost{background:transparent;border-color:var(--border2);color:var(--text2)}
.btn-ghost:hover{background:var(--surface2);color:var(--text)}
.btn-primary{background:var(--accent2);border-color:var(--accent2);color:#fff;font-weight:600;box-shadow:0 0 14px rgba(34,197,94,0.2)}
.btn-primary:hover{background:#16a34a}
.btn-danger{background:transparent;border-color:var(--border2);color:#f87171}
.btn-danger:hover{background:rgba(239,68,68,0.08);border-color:#ef4444}
.icon-btn{width:30px;height:30px;border-radius:6px;background:transparent;border:1px solid var(--border2);color:var(--text2);cursor:pointer;display:flex;align-items:center;justify-content:center;font-size:13px;transition:all 0.15s}
.icon-btn:hover{background:var(--surface2);color:var(--text)}

/* ‚îÄ‚îÄ LEFT PANEL ‚îÄ‚îÄ */
.left-panel{grid-column:1;grid-row:2;background:var(--surface);border-right:1px solid var(--border);overflow-y:auto;overflow-x:hidden;display:flex;flex-direction:column}
.left-panel::-webkit-scrollbar{width:3px}
.left-panel::-webkit-scrollbar-thumb{background:var(--border2);border-radius:2px}
.panel-search{padding:10px 10px 6px}
.search-box{display:flex;align-items:center;gap:7px;background:var(--surface2);border:1px solid var(--border);border-radius:7px;padding:6px 9px}
.search-box input{background:transparent;border:none;outline:none;font-size:11px;color:var(--text);width:100%;font-family:'Outfit',sans-serif}
.search-box input::placeholder{color:var(--text3)}
.palette-section{padding:0 6px 4px}
.section-toggle{display:flex;align-items:center;gap:5px;padding:10px 6px 6px;cursor:pointer;font-size:11px;font-weight:700;letter-spacing:0.07em;text-transform:uppercase;color:var(--text3);user-select:none;transition:color 0.15s}
.section-toggle:hover{color:var(--text2)}
.section-arrow{font-size:9px;transition:transform 0.2s}
.section-arrow.open{transform:rotate(90deg)}
.node-item{display:flex;align-items:center;gap:12px;padding:11px 12px;border-radius:9px;margin-bottom:4px;cursor:grab;border:1px solid transparent;transition:all 0.15s;user-select:none}
.node-item:hover{background:var(--surface2);border-color:var(--border)}
.node-item:active{cursor:grabbing}
.ni-icon{width:42px;height:42px;border-radius:10px;display:flex;align-items:center;justify-content:center;font-size:20px;flex-shrink:0}
.ni-label{font-size:13px;font-weight:600;color:var(--text2);line-height:1.35}
.node-item:hover .ni-label{color:var(--text)}
.section-items.collapsed{display:none}

/* ‚îÄ‚îÄ CANVAS AREA ‚îÄ‚îÄ */
.canvas-wrap{
  grid-column:2;grid-row:2;
  position:relative;overflow:hidden;
  background:var(--bg);
  background-image:radial-gradient(circle at 1px 1px,rgba(255,255,255,0.035) 1px,transparent 0);
  background-size:24px 24px;
  cursor:default;
}
.canvas-viewport{position:absolute;inset:0;transform-origin:0 0}
.connections-svg{position:absolute;inset:0;width:100%;height:100%;pointer-events:none;overflow:visible}

/* ‚îÄ‚îÄ NODE CARDS ‚îÄ‚îÄ */
.canvas-node{position:absolute;display:flex;flex-direction:column;align-items:center;cursor:pointer;user-select:none;z-index:10}
.node-card{
  width:150px;
  border-radius:16px;border:2px solid rgba(255,255,255,0.06);
  display:flex;flex-direction:column;align-items:center;
  padding:18px 12px 14px;transition:all 0.18s;position:relative;
  box-shadow:0 4px 18px rgba(0,0,0,0.4);
}
.node-card:hover{border-color:rgba(255,255,255,0.16);transform:translateY(-2px);box-shadow:0 8px 28px rgba(0,0,0,0.5)}
.node-card.selected{border-color:rgba(255,255,255,0.5)!important;box-shadow:0 0 0 3px rgba(255,255,255,0.07),0 8px 28px rgba(0,0,0,0.5)}
/* Highlight when a connection wire is dragged over this node */
.canvas-node.connect-hover .node-card{
  border-color:var(--accent)!important;
  box-shadow:0 0 0 3px rgba(74,222,128,0.2), 0 8px 28px rgba(0,0,0,0.5)!important;
}
.node-card-icon{width:112px;height:112px;border-radius:22px;display:flex;align-items:center;justify-content:center;font-size:56px;margin-bottom:10px}
.node-card-label{font-size:13px;font-weight:700;text-align:center;line-height:1.35;color:rgba(255,255,255,0.95);max-width:110px;letter-spacing:0.01em}

/* Heat badge */
.heat-badge{position:absolute;top:-7px;right:-7px;background:var(--accent2);color:#fff;font-size:8px;font-weight:700;font-family:'IBM Plex Mono',monospace;padding:2px 5px;border-radius:9px;box-shadow:0 0 7px rgba(34,197,94,0.45);white-space:nowrap;z-index:20}

/* Node actions */
.node-actions{display:none;gap:3px;margin-top:5px}
.canvas-node:hover .node-actions{display:flex}
.na-btn{width:20px;height:20px;border-radius:4px;background:var(--surface2);border:1px solid var(--border2);color:var(--text3);font-size:9px;cursor:pointer;display:flex;align-items:center;justify-content:center;transition:all 0.15s}
.na-btn:hover{color:var(--text);background:var(--surface3)}
.na-btn.del:hover{color:#f87171;border-color:#ef4444;background:rgba(239,68,68,0.1)}

/* Output port ‚Äî click to start connection */
.out-port{
  position:absolute;right:-10px;top:50%;transform:translateY(-50%);
  width:12px;height:12px;border-radius:50%;
  border:2px solid rgba(255,255,255,0.25);background:var(--surface2);
  cursor:crosshair;transition:all 0.15s;z-index:20;
  display:none;
}
.canvas-node:hover .out-port{display:block}
.out-port:hover{border-color:var(--accent);background:var(--accent);transform:translateY(-50%) scale(1.3)}
.out-port.connecting{display:block;border-color:var(--accent);background:var(--accent);animation:portPulse 0.8s infinite}
@keyframes portPulse{0%,100%{box-shadow:0 0 0 0 rgba(74,222,128,0.5)}50%{box-shadow:0 0 0 5px rgba(74,222,128,0)}}

/* Input port */
.in-port{
  position:absolute;left:-10px;top:50%;transform:translateY(-50%);
  width:12px;height:12px;border-radius:50%;
  border:2px solid rgba(255,255,255,0.1);background:var(--surface2);
  z-index:20;display:none;cursor:crosshair;transition:all 0.15s;
}
.canvas-node:hover .in-port{display:block}
.in-port.accepting{display:block;border-color:var(--accent)!important;background:rgba(74,222,128,0.2);animation:portPulse 0.6s infinite}

/* Placeholder node ‚Äî base (fresh slot after fork) */
.placeholder-node{
  position:absolute;width:var(--node-w);height:var(--node-h);
  border-radius:13px;border:2px dashed rgba(255,255,255,0.1);
  display:flex;flex-direction:column;align-items:center;justify-content:center;
  gap:4px;cursor:pointer;transition:all 0.22s;z-index:5;
  background:transparent;
}
.placeholder-node:hover{
  border-color:var(--accent);
  background:rgba(74,222,128,0.04);
  box-shadow:0 0 0 1px rgba(74,222,128,0.12), 0 0 18px rgba(74,222,128,0.08);
}
.ph-plus{font-size:20px;color:var(--text3);transition:color 0.2s;line-height:1}
.ph-label{font-size:9px;color:var(--text3);font-family:'IBM Plex Mono',monospace;letter-spacing:0.05em;transition:color 0.2s;text-align:center;padding:0 4px}
.placeholder-node:hover .ph-plus,.placeholder-node:hover .ph-label{color:var(--accent)}

/* Ghost placeholder ‚Äî left behind after deleting a node. More visible border, node-shaped */
.placeholder-node.ghost{
  border:2px dashed rgba(255,255,255,0.22);
  background:rgba(255,255,255,0.02);
}
.placeholder-node.ghost:hover{
  border-color:var(--accent);
  background:rgba(74,222,128,0.05);
}
/* Drag-over highlight ‚Äî when dragging a palette node over a placeholder */
.placeholder-node.drag-over{
  border-color:var(--accent)!important;
  background:rgba(74,222,128,0.09)!important;
  box-shadow:0 0 0 2px rgba(74,222,128,0.25), 0 0 24px rgba(74,222,128,0.15)!important;
  transform:scale(1.04);
}

/* Drag ghost ‚Äî the floating preview node following the cursor */
#dragGhost{
  position:fixed;pointer-events:none;z-index:1000;
  width:88px;display:flex;flex-direction:column;align-items:center;
  opacity:0.88;transform:translate(-50%,-50%);
  transition:none;display:none;
}
#dragGhost .dg-card{
  width:88px;border-radius:13px;border:2px solid rgba(255,255,255,0.18);
  display:flex;flex-direction:column;align-items:center;
  padding:13px 7px 9px;box-shadow:0 8px 32px rgba(0,0,0,0.6);
}
#dragGhost .dg-icon{width:34px;height:34px;border-radius:9px;display:flex;align-items:center;justify-content:center;font-size:17px;margin-bottom:7px}
#dragGhost .dg-label{font-size:9px;font-weight:600;text-align:center;color:rgba(255,255,255,0.9);max-width:72px;line-height:1.3}

/* ‚îÄ‚îÄ TRIGGER GATE ‚îÄ‚îÄ */
.trigger-gate{position:absolute;inset:0;display:flex;align-items:center;justify-content:center;background:rgba(14,16,23,0.88);backdrop-filter:blur(4px);z-index:150;transition:opacity 0.3s}
.trigger-card{background:var(--surface);border:1px solid var(--border2);border-radius:16px;padding:32px 40px;text-align:center;max-width:340px;box-shadow:0 20px 60px rgba(0,0,0,0.6)}
.trigger-card h2{font-size:16px;font-weight:600;color:var(--text);margin-bottom:6px}
.trigger-card p{font-size:11px;color:var(--text3);margin-bottom:26px;line-height:1.6}
.trigger-options{display:flex;gap:14px;justify-content:center}
.trigger-opt{display:flex;flex-direction:column;align-items:center;gap:9px;padding:18px 22px;border-radius:11px;border:2px solid var(--border2);background:var(--surface2);cursor:pointer;transition:all 0.2s;min-width:105px}
.trigger-opt:hover{transform:translateY(-3px);box-shadow:0 8px 22px rgba(0,0,0,0.4)}
.trigger-opt.realtime:hover{border-color:#22c55e;box-shadow:0 8px 22px rgba(34,197,94,0.18)}
.trigger-opt.schedule:hover{border-color:#3b82f6;box-shadow:0 8px 22px rgba(59,130,246,0.18)}
.trigger-opt-icon{width:48px;height:48px;border-radius:13px;display:flex;align-items:center;justify-content:center;font-size:22px}
.trigger-opt-label{font-size:12px;font-weight:600;color:var(--text)}
.trigger-opt-sub{font-size:9px;color:var(--text3)}

/* ‚îÄ‚îÄ RIGHT PANEL (overlay, not grid column) ‚îÄ‚îÄ */
.right-panel{
  position:fixed;top:44px;right:0;bottom:32px;
  width:268px;
  background:var(--surface);
  border-left:1px solid var(--border);
  display:flex;flex-direction:column;
  z-index:150;
  transform:translateX(100%);
  transition:transform 0.22s cubic-bezier(0.4,0,0.2,1);
  box-shadow:-8px 0 32px rgba(0,0,0,0.4);
}
.right-panel.open{transform:translateX(0)}
.rpanel-header{padding:13px 14px 10px;border-bottom:1px solid var(--border);display:flex;align-items:flex-start;justify-content:space-between;flex-shrink:0}
.rpanel-title{font-size:12px;font-weight:600;color:var(--text)}
.rpanel-subtitle{font-size:10px;color:var(--text3);margin-top:2px}
.rpanel-close{width:22px;height:22px;border-radius:4px;background:transparent;border:1px solid var(--border2);color:var(--text3);font-size:11px;cursor:pointer;display:flex;align-items:center;justify-content:center;transition:all 0.15s;flex-shrink:0;margin-top:1px}
.rpanel-close:hover{color:var(--text);background:var(--surface2)}
.rpanel-body{flex:1;overflow-y:auto;padding:14px}
.rpanel-body::-webkit-scrollbar{width:3px}
.rpanel-body::-webkit-scrollbar-thumb{background:var(--border2);border-radius:2px}
.field-group{margin-bottom:16px}
.field-label{font-size:9px;font-weight:600;letter-spacing:0.1em;text-transform:uppercase;color:var(--text3);margin-bottom:5px;display:block}
.field-input{width:100%;background:var(--surface2);border:1px solid var(--border2);border-radius:7px;padding:7px 10px;font-size:11px;color:var(--text);font-family:'Outfit',sans-serif;outline:none;transition:border-color 0.15s}
.field-input:focus{border-color:var(--accent)}
.field-input::placeholder{color:var(--text3)}
.field-textarea{resize:none;min-height:56px;line-height:1.5}
.field-select{width:100%;background:var(--surface2);border:1px solid var(--border2);border-radius:7px;padding:7px 10px;font-size:11px;color:var(--text);font-family:'Outfit',sans-serif;outline:none;cursor:pointer;appearance:none;background-image:url("data:image/svg+xml,%3Csvg width='10' height='6' viewBox='0 0 10 6' fill='none' xmlns='http://www.w3.org/2000/svg'%3E%3Cpath d='M1 1l4 4 4-4' stroke='%234a5270' stroke-width='1.5' stroke-linecap='round' stroke-linejoin='round'/%3E%3C/svg%3E");background-repeat:no-repeat;background-position:right 9px center}
.field-select:focus{border-color:var(--accent)}
.divider{height:1px;background:var(--border);margin:14px 0}

/* Event checkboxes */
.event-list{display:flex;flex-direction:column;gap:3px}
.event-check{display:flex;align-items:center;gap:8px;padding:7px 9px;border-radius:6px;cursor:pointer;transition:background 0.15s;border:1px solid transparent}
.event-check:hover{background:var(--surface2)}
.event-check.checked{background:rgba(34,197,94,0.06);border-color:rgba(34,197,94,0.18)}
.event-check input{accent-color:var(--accent);width:13px;height:13px;cursor:pointer}
.event-check-label{font-size:11px;color:var(--text2)}
.event-check.checked .event-check-label{color:var(--accent)}
.event-summary{margin-top:7px;padding:7px 9px;background:rgba(34,197,94,0.05);border:1px solid rgba(34,197,94,0.13);border-radius:7px;display:none}
.es-title{font-size:9px;color:var(--accent);font-weight:600;text-transform:uppercase;letter-spacing:0.08em;margin-bottom:4px}
.es-tags{display:flex;flex-wrap:wrap;gap:3px}
.es-tag{font-size:9px;padding:2px 7px;border-radius:4px;background:rgba(34,197,94,0.13);color:var(--accent);font-family:'IBM Plex Mono',monospace}

/* Condition builder */
.cond-row{background:var(--surface2);border:1px solid var(--border);border-radius:7px;padding:9px;margin-bottom:6px}
.cond-fields{display:flex;gap:5px;margin-bottom:5px;flex-wrap:wrap}
.cond-sel{flex:1;min-width:0;background:var(--surface3);border:1px solid var(--border2);border-radius:5px;padding:5px 7px;font-size:10px;color:var(--text);font-family:'Outfit',sans-serif;outline:none;appearance:none;cursor:pointer;min-width:60px}
.cond-footer{display:flex;justify-content:space-between;align-items:center}
.logic-tag{font-size:9px;font-weight:700;font-family:'IBM Plex Mono',monospace;padding:2px 7px;border-radius:4px;background:rgba(249,115,22,0.12);color:#fb923c;border:1px solid rgba(249,115,22,0.2);cursor:pointer}
.logic-tag:hover{background:rgba(249,115,22,0.22)}
.cond-remove{background:transparent;border:none;color:var(--text3);cursor:pointer;font-size:10px;transition:color 0.15s}
.cond-remove:hover{color:#f87171}
.add-cond-btn{display:flex;align-items:center;justify-content:center;gap:5px;padding:6px;border-radius:6px;background:transparent;border:1px dashed var(--border2);color:var(--text3);font-size:10px;cursor:pointer;width:100%;transition:all 0.15s;font-family:'Outfit',sans-serif}
.add-cond-btn:hover{border-color:var(--accent);color:var(--accent);background:rgba(74,222,128,0.04)}

/* Sub-fields for smart conditions */
.sub-field{margin-top:5px;padding-top:5px;border-top:1px solid var(--border)}

.rpanel-footer{padding:10px 14px;border-top:1px solid var(--border);flex-shrink:0}
.save-btn{width:100%;padding:9px;border-radius:8px;background:var(--accent2);border:none;font-size:12px;font-weight:600;color:#fff;cursor:pointer;font-family:'Outfit',sans-serif;box-shadow:0 0 14px rgba(34,197,94,0.2);transition:all 0.18s}
.save-btn:hover{background:#16a34a;box-shadow:0 0 22px rgba(34,197,94,0.35)}

/* ‚îÄ‚îÄ CONTEXT MENU (placeholder click) ‚îÄ‚îÄ */
.ctx-menu{
  position:fixed;z-index:500;
  background:var(--surface);border:1px solid var(--border2);
  border-radius:10px;padding:6px;
  box-shadow:0 8px 32px rgba(0,0,0,0.6);
  min-width:180px;display:none;
  animation:ctxIn 0.12s ease;
}
@keyframes ctxIn{from{opacity:0;transform:scale(0.95)}to{opacity:1;transform:scale(1)}}
.ctx-section{font-size:9px;color:var(--text3);font-weight:600;letter-spacing:0.1em;text-transform:uppercase;padding:4px 8px 3px;margin-top:3px}
.ctx-section:first-child{margin-top:0}
.ctx-item{display:flex;align-items:center;gap:8px;padding:7px 9px;border-radius:6px;cursor:pointer;transition:background 0.12s}
.ctx-item:hover{background:var(--surface2)}
.ctx-item-icon{width:24px;height:24px;border-radius:6px;display:flex;align-items:center;justify-content:center;font-size:12px;flex-shrink:0}
.ctx-item-label{font-size:11px;font-weight:500;color:var(--text2)}
.ctx-item:hover .ctx-item-label{color:var(--text)}

/* ‚îÄ‚îÄ VALIDATION TOAST ‚îÄ‚îÄ */
.val-toast{
  position:fixed;top:54px;left:50%;transform:translateX(-50%);
  background:var(--surface2);border:1px solid var(--border2);
  border-radius:8px;padding:0;min-width:300px;max-width:460px;
  box-shadow:0 8px 32px rgba(0,0,0,0.6);z-index:600;display:none;
  animation:toastIn 0.18s ease;
}
@keyframes toastIn{from{opacity:0;transform:translateX(-50%) translateY(-8px)}to{opacity:1;transform:translateX(-50%) translateY(0)}}
.val-toast-header{display:flex;align-items:center;gap:8px;padding:10px 14px;border-bottom:1px solid var(--border)}
.val-toast-title{font-size:12px;font-weight:600;color:var(--text);flex:1}
.val-toast-close{background:transparent;border:none;color:var(--text3);cursor:pointer;font-size:13px;line-height:1}
.val-toast-body{padding:10px 14px;display:flex;flex-direction:column;gap:5px}
.val-item{display:flex;align-items:center;gap:7px;font-size:11px;color:var(--text2)}
.val-item.error .val-dot{background:#f87171}
.val-item.warn .val-dot{background:#f59e0b}
.val-item.ok .val-dot{background:#4ade80}
.val-dot{width:6px;height:6px;border-radius:50%;flex-shrink:0}

/* ‚îÄ‚îÄ CONNECTING LINE (live drag) ‚îÄ‚îÄ */
#connectingSvg{position:fixed;inset:0;pointer-events:none;z-index:400;display:none}

/* ‚îÄ‚îÄ ZOOM + MINIMAP ‚îÄ‚îÄ */
.zoom-controls{position:absolute;right:14px;bottom:14px;display:flex;flex-direction:column;gap:3px;z-index:20}
.zoom-btn{width:28px;height:28px;border-radius:7px;background:var(--surface);border:1px solid var(--border2);color:var(--text2);font-size:13px;cursor:pointer;display:flex;align-items:center;justify-content:center;transition:all 0.15s}
.zoom-btn:hover{background:var(--surface2);color:var(--text)}
.zoom-level{background:var(--surface);border:1px solid var(--border2);border-radius:5px;padding:3px 5px;font-size:9px;font-family:'IBM Plex Mono',monospace;color:var(--text3);text-align:center}

.minimap{position:absolute;right:14px;top:14px;width:130px;height:82px;background:var(--surface);border:1px solid var(--border2);border-radius:9px;overflow:hidden;z-index:20}
.minimap-label{position:absolute;bottom:4px;left:7px;font-size:8px;font-family:'IBM Plex Mono',monospace;color:var(--text3);letter-spacing:0.06em;text-transform:uppercase}
.minimap-inner{width:100%;height:100%;position:relative;padding:7px}
.mm-node{position:absolute;border-radius:2px;width:8px;height:8px;transition:all 0.3s}
.mm-viewport{position:absolute;border:1px solid rgba(74,222,128,0.4);background:rgba(74,222,128,0.04);border-radius:2px;top:12%;left:6%;width:55%;height:55%;pointer-events:none}

/* ‚îÄ‚îÄ BOTTOM BAR ‚îÄ‚îÄ */
.bottom-bar{grid-column:1/-1;grid-row:3;background:var(--surface);border-top:1px solid var(--border);display:flex;align-items:center;padding:0 14px;z-index:100}
.bbar-seg{display:flex;align-items:center;gap:10px;padding:0 12px;border-right:1px solid var(--border)}
.bbar-seg:first-child{padding-left:0}
.bbar-seg:last-child{border-right:none;margin-left:auto;padding-right:0}
.bbar-stat{display:flex;align-items:center;gap:5px}
.bbar-dot{width:5px;height:5px;border-radius:50%}
.bbar-lbl{font-size:9px;font-family:'IBM Plex Mono',monospace;color:var(--text3)}
.bbar-val{font-size:10px;font-family:'IBM Plex Mono',monospace;color:var(--text);font-weight:500}
.hm-toggle{display:flex;align-items:center;gap:6px;font-size:9px;font-family:'IBM Plex Mono',monospace;color:var(--text3);cursor:pointer}
.toggle-sw{width:26px;height:14px;border-radius:7px;background:var(--accent2);position:relative;transition:background 0.2s}
.toggle-sw::after{content:'';position:absolute;top:2px;right:2px;width:10px;height:10px;border-radius:50%;background:#fff;transition:right 0.2s,left 0.2s}
.toggle-sw.off{background:var(--surface3)}
.toggle-sw.off::after{right:auto;left:2px}

/* ‚îÄ‚îÄ ALERT ‚îÄ‚îÄ */
.alert-bar{position:fixed;bottom:44px;left:50%;transform:translateX(-50%);background:var(--surface2);border:1px solid var(--border2);border-left:2px solid var(--accent);border-radius:7px;padding:7px 14px;font-size:11px;font-family:'IBM Plex Mono',monospace;color:var(--text);box-shadow:0 4px 18px rgba(0,0,0,0.5);z-index:700;display:none;white-space:nowrap}

/* ‚îÄ‚îÄ CONFIRM DIALOG ‚îÄ‚îÄ */
.confirm-overlay{position:fixed;inset:0;background:rgba(0,0,0,0.65);backdrop-filter:blur(4px);z-index:900;display:none;align-items:center;justify-content:center}
.confirm-overlay.open{display:flex}
.confirm-card{background:var(--surface);border:1px solid var(--border2);border-radius:14px;padding:28px 32px;max-width:380px;width:90%;box-shadow:0 24px 60px rgba(0,0,0,0.7);animation:ctxIn 0.15s ease}
.confirm-icon{font-size:28px;margin-bottom:12px}
.confirm-title{font-size:15px;font-weight:700;color:var(--text);margin-bottom:8px}
.confirm-body{font-size:12px;color:var(--text2);line-height:1.6;margin-bottom:24px}
.confirm-actions{display:flex;gap:10px;justify-content:flex-end}
.confirm-cancel{padding:8px 18px;border-radius:7px;background:transparent;border:1px solid var(--border2);color:var(--text2);font-size:12px;font-family:'Outfit',sans-serif;cursor:pointer;transition:all 0.15s}
.confirm-cancel:hover{background:var(--surface2);color:var(--text)}
.confirm-delete{padding:8px 18px;border-radius:7px;background:#dc2626;border:none;color:#fff;font-size:12px;font-weight:600;font-family:'Outfit',sans-serif;cursor:pointer;transition:all 0.15s}
.confirm-delete:hover{background:#b91c1c}

/* Node color classes */
.nc-trigger{background:linear-gradient(135deg,#15803d,#166534)!important;border-color:rgba(34,197,94,0.25)!important}
.nc-schedule{background:linear-gradient(135deg,#1d4ed8,#1e40af)!important;border-color:rgba(59,130,246,0.25)!important}
.nc-flow{background:linear-gradient(135deg,#ea580c,#c2410c)!important;border-color:rgba(249,115,22,0.25)!important}
.nc-split{background:linear-gradient(135deg,#d97706,#b45309)!important;border-color:rgba(245,158,11,0.25)!important}
.nc-activity{background:linear-gradient(135deg,#9333ea,#7e22ce)!important;border-color:rgba(168,85,247,0.25)!important}
.nc-comms{background:linear-gradient(135deg,#7c3aed,#6d28d9)!important;border-color:rgba(139,92,246,0.25)!important}
.nc-data{background:linear-gradient(135deg,#0e7490,#0c4a6e)!important;border-color:rgba(6,182,212,0.25)!important}
.nc-wait{background:linear-gradient(135deg,#0369a1,#0c4a6e)!important;border-color:rgba(56,189,248,0.25)!important}
.nc-end{background:linear-gradient(135deg,#dc2626,#991b1b)!important;border-color:rgba(239,68,68,0.25)!important}
.nc-pull{background:linear-gradient(135deg,#0f766e,#065f46)!important;border-color:rgba(20,184,166,0.25)!important}
.nc-cond{background:linear-gradient(135deg,#6d28d9,#5b21b6)!important;border-color:rgba(139,92,246,0.25)!important}
</style>
</head>
<body>

<div class="app" id="app">
<!-- TOPBAR -->
<header class="topbar">
  <div class="logo"><div class="logo-mark">ü´í</div><div class="logo-text">Olives Builder</div></div>
  <div class="vsep"></div>
  <input class="campaign-name" id="campaignName" value="Tournament Re-engagement Q3" />
  <div class="topbar-status"><div class="status-dot" id="statusDot"></div><span id="statusLabel">Draft</span></div>
  <div class="topbar-actions">
    <button class="icon-btn" title="Undo (Ctrl+Z)" onclick="undo()">‚Ü©</button>
    <button class="icon-btn" title="Redo (Ctrl+Y)" onclick="redo()">‚Ü™</button>
    <div class="vsep"></div>
    <button class="btn btn-ghost" onclick="showAlert('üì• Import ready')">üì• Import</button>
    <button class="btn btn-danger" onclick="clearCanvas()">üóë Clear</button>
    <button class="btn btn-ghost" onclick="validateJourney()">‚úì Validate</button>
    <button class="btn btn-primary" onclick="publishJourney()">‚ñ∂ Publish</button>
  </div>
</header>

<!-- LEFT PANEL -->
<aside class="left-panel">
  <div class="panel-search">
    <div class="search-box">
      <span style="color:var(--text3);font-size:11px">üîç</span>
      <input type="text" placeholder="Search nodes‚Ä¶" oninput="filterNodes(this.value)"/>
    </div>
  </div>
  <div class="palette-section">
    <div class="section-toggle" onclick="toggleSec('flow')"><span class="section-arrow open" id="arr-flow">‚Ä∫</span> Flow</div>
    <div class="section-items" id="sec-flow">
      <div class="node-item" onmousedown="startPaletteDrag(event,'wait')"><div class="ni-icon nc-wait">üïê</div><span class="ni-label">Wait</span></div>
      <div class="node-item" onmousedown="startPaletteDrag(event,'random')"><div class="ni-icon nc-split">‚ö°</div><span class="ni-label">Random Split</span></div>
      <div class="node-item" onmousedown="startPaletteDrag(event,'event-split')"><div class="ni-icon nc-flow">‚ëÇ</div><span class="ni-label">Event Split</span></div>
      <div class="node-item" onmousedown="startPaletteDrag(event,'condition')"><div class="ni-icon nc-cond">‚óá</div><span class="ni-label">Condition Split</span></div>
      <div class="node-item" onmousedown="startPaletteDrag(event,'end')"><div class="ni-icon nc-end">‚äó</div><span class="ni-label">End</span></div>
      <div class="node-item" onmousedown="startPaletteDrag(event,'pull')"><div class="ni-icon nc-pull">‚¨á</div><span class="ni-label">Pull Data</span></div>
    </div>
  </div>
  <div class="palette-section">
    <div class="section-toggle" onclick="toggleSec('act')"><span class="section-arrow open" id="arr-act">‚Ä∫</span> Activities</div>
    <div class="section-items" id="sec-act">
      <div class="node-item" onmousedown="startPaletteDrag(event,'bonus')"><div class="ni-icon nc-activity">üéÅ</div><span class="ni-label">Add Bonus</span></div>
      <div class="node-item" onmousedown="startPaletteDrag(event,'leaderboard')"><div class="ni-icon nc-activity">üèÜ</div><span class="ni-label">Add/Remove from Leaderboard</span></div>
      <div class="node-item" onmousedown="startPaletteDrag(event,'mission')"><div class="ni-icon nc-activity">üéØ</div><span class="ni-label">Add/Remove from Mission</span></div>
      <div class="node-item" onmousedown="startPaletteDrag(event,'tournament')"><div class="ni-icon nc-activity">ü•á</div><span class="ni-label">Add/Remove from Tournament</span></div>
      <div class="node-item" onmousedown="startPaletteDrag(event,'skin')"><div class="ni-icon nc-activity">üéÆ</div><span class="ni-label">Game Skin On/Off</span></div>
      <div class="node-item" onmousedown="startPaletteDrag(event,'coins')"><div class="ni-icon nc-activity">ü™ô</div><span class="ni-label">Add Betty Coins</span></div>
      <div class="node-item" onmousedown="startPaletteDrag(event,'shop')"><div class="ni-icon nc-activity">üõç</div><span class="ni-label">Go to Shop</span></div>
      <div class="node-item" onmousedown="startPaletteDrag(event,'esb')"><div class="ni-icon nc-activity">üåê</div><span class="ni-label">ESB Engagement Tools</span></div>
    </div>
  </div>
  <div class="palette-section">
    <div class="section-toggle" onclick="toggleSec('comms')"><span class="section-arrow open" id="arr-comms">‚Ä∫</span> Communications</div>
    <div class="section-items" id="sec-comms">
      <div class="node-item" onmousedown="startPaletteDrag(event,'rtmsg')"><div class="ni-icon nc-comms">üí¨</div><span class="ni-label">Player Real-Time Message</span></div>
      <div class="node-item" onmousedown="startPaletteDrag(event,'email')"><div class="ni-icon nc-comms">üìß</div><span class="ni-label">Email</span></div>
      <div class="node-item" onmousedown="startPaletteDrag(event,'sms')"><div class="ni-icon nc-comms">üì±</div><span class="ni-label">SMS</span></div>
      <div class="node-item" onmousedown="startPaletteDrag(event,'push')"><div class="ni-icon nc-comms">üîî</div><span class="ni-label">Push Notification</span></div>
      <div class="node-item" onmousedown="startPaletteDrag(event,'slack')"><div class="ni-icon nc-comms">üíº</div><span class="ni-label">Slack (Internal)</span></div>
    </div>
  </div>
  <div class="palette-section">
    <div class="section-toggle" onclick="toggleSec('pdata')"><span class="section-arrow open" id="arr-pdata">‚Ä∫</span> Player Data</div>
    <div class="section-items" id="sec-pdata">
      <div class="node-item" onmousedown="startPaletteDrag(event,'tag')"><div class="ni-icon nc-data">üè∑</div><span class="ni-label">Add/Remove Tag</span></div>
      <div class="node-item" onmousedown="startPaletteDrag(event,'vip')"><div class="ni-icon nc-data">‚≠ê</div><span class="ni-label">Change VIP Level</span></div>
      <div class="node-item" onmousedown="startPaletteDrag(event,'status')"><div class="ni-icon nc-data">üìä</div><span class="ni-label">Change Status Level</span></div>
    </div>
  </div>
</aside>

<!-- CANVAS -->
<main class="canvas-wrap" id="canvasWrap">
  <div class="canvas-viewport" id="viewport">
    <svg class="connections-svg" id="connSvg"></svg>
  </div>

  <!-- TRIGGER GATE -->
  <div class="trigger-gate" id="triggerGate">
    <div class="trigger-card">
      <h2>Choose your trigger type</h2>
      <p>Every journey starts with a trigger. Pick the type that matches your campaign goal ‚Äî this determines the flow rules available to you.</p>
      <div class="trigger-options">
        <div class="trigger-opt realtime" onclick="selectTrigger('realtime')">
          <div class="trigger-opt-icon nc-trigger">‚ö°</div>
          <div class="trigger-opt-label">Real-time</div>
          <div class="trigger-opt-sub">Event-driven</div>
        </div>
        <div class="trigger-opt schedule" onclick="selectTrigger('schedule')">
          <div class="trigger-opt-icon nc-schedule">üìÖ</div>
          <div class="trigger-opt-label">Schedule</div>
          <div class="trigger-opt-sub">Time-based</div>
        </div>
      </div>
    </div>
  </div>

  <!-- ZOOM -->
  <div class="zoom-controls">
    <button class="zoom-btn" onclick="doZoom(1.15)">+</button>
    <div class="zoom-level" id="zoomLbl">100%</div>
    <button class="zoom-btn" onclick="doZoom(0.87)">‚àí</button>
    <button class="zoom-btn" title="Fit" onclick="fitCanvas()">‚äû</button>
  </div>

  <!-- MINIMAP -->
  <div class="minimap">
    <div class="minimap-inner" id="mmInner"><div class="mm-viewport"></div></div>
    <div class="minimap-label">Minimap</div>
  </div>
</main>
</div>

<!-- RIGHT PANEL (overlay) -->
<aside class="right-panel" id="rightPanel">
  <div class="rpanel-header">
    <div><div class="rpanel-title" id="rpTitle">Properties</div><div class="rpanel-subtitle" id="rpSub"></div></div>
    <button class="rpanel-close" onclick="closePanel()">‚úï</button>
  </div>
  <div class="rpanel-body" id="rpBody"></div>
  <div class="rpanel-footer"><button class="save-btn" onclick="saveNode()">Save Changes</button></div>
</aside>

<!-- BOTTOM BAR -->
<footer class="bottom-bar">
  <div class="bbar-seg">
    <div class="bbar-stat"><div class="bbar-dot" style="background:#4ade80"></div><span class="bbar-lbl">Active</span><span class="bbar-val" id="bActive">1,247</span></div>
  </div>
  <div class="bbar-seg">
    <div class="bbar-stat"><div class="bbar-dot" style="background:#f97316"></div><span class="bbar-lbl">In journey</span><span class="bbar-val" id="bJourney">342</span></div>
  </div>
  <div class="bbar-seg">
    <div class="bbar-stat"><div class="bbar-dot" style="background:#38bdf8"></div><span class="bbar-lbl">Completed</span><span class="bbar-val" id="bDone">89</span></div>
  </div>
  <div class="bbar-seg">
    <div class="bbar-stat"><div class="bbar-dot" style="background:#a855f7"></div><span class="bbar-lbl">Nodes</span><span class="bbar-val" id="bNodes">0</span></div>
  </div>
  <div class="bbar-seg">
    <div class="hm-toggle" onclick="toggleHeatmap()">
      <div class="toggle-sw" id="hmSwitch"></div><span>Live Heatmap</span>
    </div>
  </div>
  <div class="bbar-seg"><span class="bbar-lbl" id="bStatus">Draft ‚Äî unsaved</span></div>
</footer>

<!-- CONNECTING SVG (live drag line) -->
<svg id="connectingSvg"><line id="connectingLine" stroke="#4ade80" stroke-width="2" stroke-dasharray="6,3" opacity="0.7"/></svg>

<!-- CONTEXT MENU -->
<div class="ctx-menu" id="ctxMenu"></div>

<!-- VALIDATION TOAST -->
<div class="val-toast" id="valToast">
  <div class="val-toast-header">
    <span style="font-size:14px">üîç</span>
    <span class="val-toast-title">Journey Validation</span>
    <button class="val-toast-close" onclick="document.getElementById('valToast').style.display='none'">‚úï</button>
  </div>
  <div class="val-toast-body" id="valBody"></div>
</div>

<!-- CONFIRM DIALOG -->
<div class="confirm-overlay" id="confirmOverlay">
  <div class="confirm-card">
    <div class="confirm-icon">‚ö†Ô∏è</div>
    <div class="confirm-title" id="confirmTitle">Delete branch?</div>
    <div class="confirm-body" id="confirmBody">This will remove the node and all downstream nodes connected to this branch. This cannot be undone.</div>
    <div class="confirm-actions">
      <button class="confirm-cancel" onclick="hideConfirm()">Cancel</button>
      <button class="confirm-delete" id="confirmBtn" onclick="confirmDeleteExecute()">Delete Branch</button>
    </div>
  </div>
</div>

<!-- ALERT -->
<div class="alert-bar" id="alertBar"></div>

<script>
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  CONSTANTS ‚Äî canvas grid
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
const COL_W = 170;   // px between column centres
const ROW_H = 140;   // px between branch row centres
const NODE_W = 88;
const NODE_H = 88;
const START_X = 60;
const START_Y = 300;

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  STATE
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
let nodes = [];         // {id, type, col, row, label, config, branchLabel}
let edges = [];         // {from, to, label, color}
let selectedId = null;
let triggerType = null;
let heatmapOn = true;
let scale = 1;
let pan = {x:0, y:0};
let nc = 0;

// ‚îÄ‚îÄ UNDO STACK ‚îÄ‚îÄ
const UNDO_LIMIT = 40;
let undoStack = [];   // array of snapshots {nodes, edges, nc}
let redoStack = [];

function snapshot() {
  undoStack.push({
    nodes: JSON.parse(JSON.stringify(nodes)),
    edges: JSON.parse(JSON.stringify(edges)),
    nc
  });
  if (undoStack.length > UNDO_LIMIT) undoStack.shift();
  redoStack = [];  // any new action clears redo
}

function undo() {
  if (undoStack.length === 0) { showAlert('Nothing to undo'); return; }
  // Save current state to redo
  redoStack.push({
    nodes: JSON.parse(JSON.stringify(nodes)),
    edges: JSON.parse(JSON.stringify(edges)),
    nc
  });
  const prev = undoStack.pop();
  nodes = prev.nodes; edges = prev.edges; nc = prev.nc;
  closePanel();
  render(); updateStats();
  showAlert('‚Ü© Undone');
}

function redo() {
  if (redoStack.length === 0) { showAlert('Nothing to redo'); return; }
  undoStack.push({
    nodes: JSON.parse(JSON.stringify(nodes)),
    edges: JSON.parse(JSON.stringify(edges)),
    nc
  });
  const next = redoStack.pop();
  nodes = next.nodes; edges = next.edges; nc = next.nc;
  closePanel();
  render(); updateStats();
  showAlert('‚Ü™ Redone');
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  NODE DEFINITIONS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
const DEFS = {
  trigger:    {label:'Real-time Trigger', icon:'‚ö°', cls:'nc-trigger',  color:'#22c55e', fork:true},
  schedule:   {label:'Schedule Trigger',  icon:'üìÖ', cls:'nc-schedule', color:'#3b82f6', fork:false},
  wait:       {label:'Wait',              icon:'üïê', cls:'nc-wait',     color:'#38bdf8', fork:false},
  random:     {label:'Random Split',      icon:'‚ö°', cls:'nc-split',    color:'#f59e0b', fork:true},
  'event-split':{label:'Event Split',     icon:'‚ëÇ', cls:'nc-flow',     color:'#f97316', fork:true},
  condition:  {label:'Condition Split',   icon:'‚óá', cls:'nc-cond',     color:'#8b5cf6', fork:true},
  end:        {label:'End',               icon:'‚äó', cls:'nc-end',      color:'#ef4444', fork:false},
  pull:       {label:'Pull Data',         icon:'‚¨á', cls:'nc-pull',     color:'#06b6d4', fork:false},
  bonus:      {label:'Add Bonus',         icon:'üéÅ', cls:'nc-activity', color:'#a855f7', fork:false},
  leaderboard:{label:'Leaderboard',       icon:'üèÜ', cls:'nc-activity', color:'#a855f7', fork:false},
  mission:    {label:'Mission',           icon:'üéØ', cls:'nc-activity', color:'#a855f7', fork:false},
  tournament: {label:'Tournament',        icon:'ü•á', cls:'nc-activity', color:'#a855f7', fork:false},
  skin:       {label:'Game Skin',         icon:'üéÆ', cls:'nc-activity', color:'#a855f7', fork:false},
  coins:      {label:'Betty Coins',       icon:'ü™ô', cls:'nc-activity', color:'#a855f7', fork:false},
  shop:       {label:'Go to Shop',        icon:'üõç', cls:'nc-activity', color:'#a855f7', fork:false},
  esb:        {label:'ESB Tools',         icon:'üåê', cls:'nc-activity', color:'#a855f7', fork:false},
  rtmsg:      {label:'Real-Time Msg',     icon:'üí¨', cls:'nc-comms',    color:'#8b5cf6', fork:false},
  email:      {label:'Email',             icon:'üìß', cls:'nc-comms',    color:'#8b5cf6', fork:false},
  sms:        {label:'SMS',               icon:'üì±', cls:'nc-comms',    color:'#8b5cf6', fork:false},
  push:       {label:'Push',              icon:'üîî', cls:'nc-comms',    color:'#8b5cf6', fork:false},
  slack:      {label:'Slack (Internal)',  icon:'üíº', cls:'nc-comms',    color:'#8b5cf6', fork:false},
  tag:        {label:'Add/Remove Tag',    icon:'üè∑', cls:'nc-data',     color:'#06b6d4', fork:false},
  vip:        {label:'Change VIP',        icon:'‚≠ê', cls:'nc-data',     color:'#06b6d4', fork:false},
  status:     {label:'Change Status',     icon:'üìä', cls:'nc-data',     color:'#06b6d4', fork:false},
  placeholder:{label:'Add node',          icon:'+',  cls:'',            color:'#2e3448', fork:false},
};

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  COORDINATE HELPERS (col/row ‚Üí px)
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function colRowToXY(col, row) {
  return {
    x: START_X + col * COL_W,
    y: START_Y + row * ROW_H - ROW_H/2
  };
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  TRIGGER SELECTION
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function selectTrigger(type) {
  triggerType = type;
  const gate = document.getElementById('triggerGate');
  gate.style.opacity = '0'; gate.style.pointerEvents = 'none';

  const nodeType = type === 'realtime' ? 'trigger' : 'schedule';
  const id = newId();
  nodes.push({id, type:nodeType, col:0, row:0, label:DEFS[nodeType].label, config:{events:[]}, branchLabel:''});

  // Single placeholder to the right
  const phId = newId();
  nodes.push({id:phId, type:'placeholder', col:1, row:0, label:'', config:{}, branchLabel:'', parentId:id});
  edges.push({from:id, to:phId, label:'', color:DEFS[nodeType].color});

  render(); openProperties(nodes[0]);
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  PALETTE DRAG-AND-DROP
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
let paletteDrag = null;   // { type, ghost }
let hoveredPhId = null;   // placeholder we're hovering over

function startPaletteDrag(e, type) {
  if (!triggerType) { showAlert('‚ö° Choose a trigger type first'); return; }
  e.preventDefault();

  const def = DEFS[type];
  const ghost = document.getElementById('dragGhost');
  ghost.querySelector('.dg-card').className = 'dg-card ' + def.cls;
  ghost.querySelector('.dg-icon').textContent = def.icon;
  ghost.querySelector('.dg-label').textContent = def.label;
  ghost.style.display = 'block';
  ghost.style.left = e.clientX + 'px';
  ghost.style.top  = e.clientY + 'px';

  paletteDrag = { type };
  document.body.style.userSelect = 'none';
  document.body.style.cursor = 'grabbing';
}

document.addEventListener('mousemove', e => {
  if (!paletteDrag) return;

  // Move ghost
  const ghost = document.getElementById('dragGhost');
  ghost.style.left = e.clientX + 'px';
  ghost.style.top  = e.clientY + 'px';

  // Hit-test placeholder nodes
  const prev = hoveredPhId;
  hoveredPhId = null;

  // Temporarily hide ghost so elementFromPoint sees what's underneath
  ghost.style.display = 'none';
  const el = document.elementFromPoint(e.clientX, e.clientY);
  ghost.style.display = 'block';

  const phEl = el?.closest('.placeholder-node');
  if (phEl) hoveredPhId = phEl.dataset.phid;

  // Update highlight classes
  document.querySelectorAll('.placeholder-node').forEach(p => p.classList.remove('drag-over'));
  if (hoveredPhId) {
    document.querySelector(`.placeholder-node[data-phid="${hoveredPhId}"]`)?.classList.add('drag-over');
  }
}, true);

document.addEventListener('mouseup', e => {
  if (!paletteDrag) return;
  const type = paletteDrag.type;

  // Cleanup
  document.getElementById('dragGhost').style.display = 'none';
  document.querySelectorAll('.placeholder-node').forEach(p => p.classList.remove('drag-over'));
  document.body.style.userSelect = '';
  document.body.style.cursor = '';
  paletteDrag = null;

  if (hoveredPhId) {
    // Dropped onto a placeholder ‚Äî fill it
    fillPlaceholder(hoveredPhId, type);
    hoveredPhId = null;
  } else {
    // Dropped on canvas ‚Äî check if we're over the canvas area
    const canvasRect = document.getElementById('canvasWrap').getBoundingClientRect();
    const onCanvas = e.clientX >= canvasRect.left && e.clientX <= canvasRect.right &&
                     e.clientY >= canvasRect.top  && e.clientY <= canvasRect.bottom;
    if (onCanvas) {
      // Find nearest placeholder (within 80px in canvas coords)
      const cx = (e.clientX - canvasRect.left - pan.x) / scale;
      const cy = (e.clientY - canvasRect.top  - pan.y) / scale;
      const phs = nodes.filter(n => n.type === 'placeholder');
      let nearest = null, nearestDist = 80;
      phs.forEach(ph => {
        const {x, y} = colRowToXY(ph.col, ph.row);
        const pcx = x + NODE_W / 2;
        const pcy = y + NODE_H / 2;
        const dist = Math.hypot(cx - pcx, cy - pcy);
        if (dist < nearestDist) { nearestDist = dist; nearest = ph; }
      });
      if (nearest) {
        fillPlaceholder(nearest.id, type);
      } else {
        showAlert('‚Üñ Drop onto a + placeholder to place the node');
      }
    }
  }
}, true);

// Keep clickAddNode as fallback (shouldn't be called now but kept for safety)
function clickAddNode(type) {
  if (!triggerType) { showAlert('‚ö° Choose a trigger type first'); return; }
  const ph = nodes.find(n => n.type === 'placeholder');
  if (ph) { fillPlaceholder(ph.id, type); return; }
  showAlert('‚Ñπ No available slot.');
}

function fillPlaceholder(phId, type) {
  const ph = getNode(phId);
  if (!ph) return;
  snapshot();  // save before mutation

  ph.type = type;
  ph.label = DEFS[type].label;
  ph.config = {};
  delete ph.ghost;  // no longer a ghost slot

  // Remove parentId reference
  delete ph.parentId;

  // Update edge colour
  const inEdge = edges.find(e => e.to === phId);
  if (inEdge) inEdge.color = DEFS[type].color;

  // If fork node ‚Üí add branch placeholders; else add one placeholder
  if (DEFS[type].fork && type !== 'trigger' && type !== 'schedule') {
    addForkBranches(ph);
  } else if (type !== 'end') {
    addPlaceholderAfter(ph);
  }

  render(); selectNode(phId); updateStats(); showAlert('‚úì ' + DEFS[type].label + ' added');
}

function addPlaceholderAfter(node) {
  const phId = newId();
  nodes.push({id:phId, type:'placeholder', col:node.col+1, row:node.row, label:'', config:{}, branchLabel:'', parentId:node.id});
  edges.push({from:node.id, to:phId, label:'', color:'#2e3448'});
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  FORK BRANCH LAYOUT
//  When a fork node is placed, its branches spread
//  above and below it.  Any existing nodes that would
//  collide are pushed downward to make room.
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
const BRANCH_GAP = 2;   // row-slots between sibling branches

function addForkBranches(forkNode) {
  let branches = [];
  if (forkNode.type === 'condition')
    branches = [{l:'Yes', c:'#4ade80'}, {l:'No', c:'#f87171'}];
  else if (forkNode.type === 'event-split')
    branches = [{l:'Event', c:'#4ade80'}, {l:'Timeout', c:'#f87171'}];
  else if (forkNode.type === 'random')
    branches = [{l:'33%', c:'#fb923c'}, {l:'33%', c:'#fb923c'}, {l:'33%', c:'#fb923c'}];
  else
    branches = [{l:'', c:'#4ade80'}, {l:'', c:'#4ade80'}];

  const n      = branches.length;
  const span   = (n - 1) * BRANCH_GAP;          // total rows needed
  const anchorRow = forkNode.row;
  const firstRow  = anchorRow - Math.floor(span / 2);  // centre branches on the fork node

  // Collect rows we WANT to use
  const desiredRows = branches.map((_, i) => firstRow + i * BRANCH_GAP);

  // Push down any existing nodes in cols > forkNode.col that would overlap
  pushDownConflicts(forkNode.col + 1, desiredRows);

  // Place the placeholder branches
  branches.forEach((b, i) => {
    const phId = newId();
    nodes.push({
      id: phId, type: 'placeholder',
      col: forkNode.col + 1,
      row: desiredRows[i],
      label: '', config: {}, branchLabel: b.l, parentId: forkNode.id
    });
    edges.push({from: forkNode.id, to: phId, label: b.l, color: b.c});
  });
}

/**
 * For all nodes in columns >= startCol whose row falls within
 * any of the desiredRows or between them, shift them down
 * enough to open up exactly those rows.
 */
function pushDownConflicts(startCol, desiredRows) {
  if (desiredRows.length === 0) return;
  const minRow = Math.min(...desiredRows);
  const maxRow = Math.max(...desiredRows);

  // How many slots are needed in this row range?
  const slotsNeeded = desiredRows.length;
  // How many slots currently exist in [minRow..maxRow] for startCol?
  const existing = nodes.filter(n => n.col >= startCol && n.row >= minRow && n.row <= maxRow);

  if (existing.length === 0) return; // no conflict

  // Push every node at col>=startCol and row>=minRow down by the overflow amount
  const overflow = slotsNeeded; // shift down by one full branch-set worth
  nodes.forEach(n => {
    if (n.col >= startCol && n.row >= minRow) {
      n.row += overflow * BRANCH_GAP;
    }
  });
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  REPACK ‚Äî only used as a safety net to eliminate
//  exact row duplicates within the same column.
//  Does NOT collapse the intentional spacing.
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function repack() {
  // Group by col
  const byCol = {};
  nodes.forEach(n => {
    if (!byCol[n.col]) byCol[n.col] = [];
    byCol[n.col].push(n);
  });

  Object.values(byCol).forEach(colNodes => {
    colNodes.sort((a, b) => a.row - b.row);
    // Walk through and ensure no two nodes share the same row.
    // If they do, bump the later one down by BRANCH_GAP.
    for (let i = 1; i < colNodes.length; i++) {
      if (colNodes[i].row <= colNodes[i-1].row) {
        const bump = colNodes[i-1].row + BRANCH_GAP;
        const diff = bump - colNodes[i].row;
        // Shift this node AND all downstream nodes in same branch
        shiftSubtree(colNodes[i].id, diff);
        colNodes[i].row = bump;
      }
    }
  });
}

/**
 * Recursively shift a node and all nodes reachable from it
 * downward by `delta` rows, staying in columns > node.col.
 */
function shiftSubtree(nodeId, delta) {
  const visited = new Set();
  const queue = [nodeId];
  while (queue.length) {
    const id = queue.shift();
    if (visited.has(id)) continue;
    visited.add(id);
    const n = getNode(id);
    if (n) n.row += delta;
    edges.filter(e => e.from === id).forEach(e => queue.push(e.to));
  }
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  CONTEXT MENU on placeholder click
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function showCtxMenu(phId, screenX, screenY) {
  const menu = document.getElementById('ctxMenu');

  const sections = [
    {title:'Flow', items:['wait','event-split','condition','random','end','pull']},
    {title:'Activities', items:['bonus','leaderboard','mission','tournament','skin','coins']},
    {title:'Communications', items:['rtmsg','email','sms','push','slack']},
    {title:'Player Data', items:['tag','vip','status']},
  ];

  let html = '';
  sections.forEach(s => {
    html += `<div class="ctx-section">${s.title}</div>`;
    s.items.forEach(t => {
      const d = DEFS[t];
      html += `<div class="ctx-item" onclick="fillPlaceholder('${phId}','${t}');hideCtx()">
        <div class="ctx-item-icon ${d.cls}">${d.icon}</div>
        <span class="ctx-item-label">${d.label}</span>
      </div>`;
    });
  });

  menu.innerHTML = html;
  menu.style.display = 'block';
  // Position, keep in viewport
  const vw = window.innerWidth, vh = window.innerHeight;
  let x = screenX + 8, y = screenY - 10;
  menu.style.left = x + 'px'; menu.style.top = y + 'px';
  // Check overflow
  requestAnimationFrame(() => {
    const r = menu.getBoundingClientRect();
    if (r.right > vw) menu.style.left = (x - r.width - 16) + 'px';
    if (r.bottom > vh) menu.style.top = (y - r.height + 20) + 'px';
  });
}

function hideCtx() { document.getElementById('ctxMenu').style.display = 'none'; }
document.addEventListener('click', e => {
  if (!e.target.closest('#ctxMenu')) hideCtx();
});

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  DRAG-TO-CONNECT (port ‚Üí node)
//  Drag from right-side output port to any other node
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
let connectingFrom = null;
let mousePos = {x:0, y:0};

function startConnect(e, fromId) {
  // Don't start if palette drag is active
  if (paletteDrag) return;
  e.stopPropagation();
  e.preventDefault();
  connectingFrom = fromId;
  document.getElementById('connectingSvg').style.display = 'block';
  // Show all input ports glowing
  document.querySelectorAll('.in-port').forEach(p => p.classList.add('accepting'));
}

// Single mousemove handler (not capture, avoids palette conflict)
document.addEventListener('mousemove', e => {
  mousePos = {x: e.clientX, y: e.clientY};
  if (!connectingFrom) return;

  // Draw the live line from the out-port position
  const portEl = document.querySelector(`#cn-${connectingFrom} .out-port`);
  if (!portEl) { cancelConnect(); return; }
  const r = portEl.getBoundingClientRect();
  const line = document.getElementById('connectingLine');
  line.setAttribute('x1', r.left + r.width / 2);
  line.setAttribute('y1', r.top  + r.height / 2);
  line.setAttribute('x2', e.clientX);
  line.setAttribute('y2', e.clientY);

  // Highlight the node we're hovering ‚Äî hide svg overlay first so it doesn't intercept
  const svg = document.getElementById('connectingSvg');
  svg.style.pointerEvents = 'none';   // already none but be explicit
  const ghost = document.getElementById('dragGhost');
  const gDisp = ghost.style.display;
  ghost.style.display = 'none';
  const el = document.elementFromPoint(e.clientX, e.clientY);
  ghost.style.display = gDisp;

  // Clear previous hover
  document.querySelectorAll('.canvas-node.connect-hover').forEach(n => n.classList.remove('connect-hover'));
  const targetWrap = el?.closest('.canvas-node');
  if (targetWrap && targetWrap.id !== `cn-${connectingFrom}`) {
    targetWrap.classList.add('connect-hover');
  }
});

document.addEventListener('mouseup', e => {
  if (!connectingFrom) return;

  // Find target ‚Äî hide ghost to allow clean hit test
  const ghost = document.getElementById('dragGhost');
  const gDisp = ghost.style.display;
  ghost.style.display = 'none';
  const el = document.elementFromPoint(e.clientX, e.clientY);
  ghost.style.display = gDisp;

  const targetWrap = el?.closest('.canvas-node');
  if (targetWrap) {
    const toId = targetWrap.id.replace('cn-', '');
    if (toId && toId !== connectingFrom) connectNodes(connectingFrom, toId);
  }

  cancelConnect();
});

function cancelConnect() {
  connectingFrom = null;
  document.getElementById('connectingSvg').style.display = 'none';
  document.querySelectorAll('.in-port').forEach(p => p.classList.remove('accepting'));
  document.querySelectorAll('.canvas-node.connect-hover').forEach(n => n.classList.remove('connect-hover'));
}

function connectNodes(fromId, toId) {
  const fromNode = getNode(fromId);
  const toNode   = getNode(toId);
  if (!fromNode || !toNode) return;
  if (toNode.type === 'placeholder') return;
  if (toNode.type === 'trigger' || toNode.type === 'schedule') {
    showAlert('‚õî Cannot connect into a trigger node'); return;
  }
  if (toNode.col <= fromNode.col) {
    showAlert('‚õî Connections must flow left ‚Üí right'); return;
  }
  if (edges.find(e => e.from === fromId && e.to === toId)) return;
  snapshot();
  edges.push({from: fromId, to: toId, label: '', color: DEFS[fromNode.type]?.color || '#60a5fa'});
  render();
  showAlert('‚úì Nodes connected');
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  TRIGGER multi-event branch update
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function updateTriggerBranches(trigNode) {
  const events = trigNode.config.events || [];

  // ‚îÄ‚îÄ Step 1: Remove ONLY placeholder branches off the trigger
  //    Real nodes (already placed by user) are kept untouched
  const phEdges = edges.filter(e => e.from === trigNode.id && getNode(e.to)?.type === 'placeholder');
  phEdges.forEach(e => {
    nodes = nodes.filter(n => n.id !== e.to);
  });
  edges = edges.filter(e => !(e.from === trigNode.id && getNode(e.to) === undefined));
  // Clean up any dangling edges to removed nodes
  edges = edges.filter(e => getNode(e.from) && getNode(e.to));

  // ‚îÄ‚îÄ Step 2: Count existing real branches (non-placeholder) off trigger
  const existingRealEdges = edges.filter(e => e.from === trigNode.id);
  const existingCount = existingRealEdges.length;

  // ‚îÄ‚îÄ Step 3: Add a placeholder per event that doesn't already have a real branch
  //    Use rows spread BELOW existingCount to avoid collision
  const STEP = 2;
  const newEvents = events.slice(existingCount); // only add for events beyond what's already built

  // All events ‚Üí one placeholder per event not already connected
  // We rebuild ALL placeholder branches to match current event list
  const totalNeeded = events.length;
  const placeholdersNeeded = Math.max(0, totalNeeded - existingCount);

  // Place new placeholders below all existing nodes
  const usedRows = new Set(nodes.map(n => n.row));
  let nextRow = trigNode.row;
  for (let i = 0; i < placeholdersNeeded; i++) {
    // Find a free row
    while (usedRows.has(nextRow)) nextRow++;
    const phId = newId();
    const ev = events[existingCount + i] || '';
    nodes.push({
      id: phId, type: 'placeholder',
      col: trigNode.col + 1, row: nextRow,
      label: '', config: {}, branchLabel: ev, parentId: trigNode.id
    });
    edges.push({from: trigNode.id, to: phId, label: ev, color: '#4ade80'});
    usedRows.add(nextRow);
    nextRow += STEP;
  }

  // Update labels on existing real branch edges to match event names
  existingRealEdges.forEach((e, i) => {
    e.label = events[i] || e.label;
  });

  render();
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  RENDER
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function render() {
  renderNodes();
  renderEdges();
  renderMinimap();
}

function nodeXY(node) {
  return colRowToXY(node.col, node.row);
}

function renderNodes() {
  const vp = document.getElementById('viewport');
  vp.querySelectorAll('.canvas-node,.placeholder-node').forEach(el => el.remove());

  nodes.forEach(node => {
    const {x, y} = nodeXY(node);

    if (node.type === 'placeholder') {
      const el = document.createElement('div');
      // ghost = slot left behind after deleting a real node (has no parentId but has an incoming edge)
      const isGhost = !!node.ghost;
      el.className = 'placeholder-node' + (isGhost ? ' ghost' : '');
      el.style.left = x + 'px'; el.style.top = y + 'px';
      el.dataset.phid = node.id;   // needed for palette drag hit-test
      el.innerHTML = `<div class="ph-plus">+</div><div class="ph-label">${node.branchLabel || 'Add node'}</div>`;
      el.onclick = ev => { ev.stopPropagation(); showCtxMenu(node.id, ev.clientX, ev.clientY); };
      vp.appendChild(el);
      return;
    }

    const def = DEFS[node.type];
    if (!def) return;

    const wrap = document.createElement('div');
    wrap.className = 'canvas-node';
    wrap.id = 'cn-' + node.id;
    wrap.style.left = x + 'px'; wrap.style.top = y + 'px';
    wrap.onclick = ev => { ev.stopPropagation(); selectNode(node.id); };

    // Input port (left side)
    if (node.type !== 'trigger' && node.type !== 'schedule') {
      const inp = document.createElement('div');
      inp.className = 'in-port';
      inp.title = 'Input';
      wrap.appendChild(inp);
    }

    // Card
    const card = document.createElement('div');
    card.className = 'node-card ' + def.cls;
    if (node.id === selectedId) card.classList.add('selected');

    if (heatmapOn && node.type !== 'end' && node.type !== 'placeholder') {
      const badge = document.createElement('div');
      badge.className = 'heat-badge';
      badge.textContent = Math.floor(Math.random()*200+5).toLocaleString();
      card.appendChild(badge);
    }

    card.innerHTML += `<div class="node-card-icon">${def.icon}</div><div class="node-card-label">${node.label||def.label}</div>`;
    wrap.appendChild(card);

    // Output port (right side)
    if (node.type !== 'end') {
      const outp = document.createElement('div');
      outp.className = 'out-port';
      outp.title = 'Drag to connect';
      outp.onmousedown = ev => startConnect(ev, node.id);
      wrap.appendChild(outp);
    }

    // Actions
    const acts = document.createElement('div');
    acts.className = 'node-actions';
    acts.innerHTML = `
      <button class="na-btn" title="Edit" onclick="event.stopPropagation();selectNode('${node.id}')">‚úè</button>
      <button class="na-btn del" title="Delete" onclick="event.stopPropagation();deleteNode('${node.id}')">üóë</button>
    `;
    wrap.appendChild(acts);
    vp.appendChild(wrap);
  });
}

function renderEdges() {
  const svg = document.getElementById('connSvg');
  svg.innerHTML = '';

  edges.forEach(edge => {
    const fn = getNode(edge.from);
    const tn = getNode(edge.to);
    if (!fn || !tn) return;

    const fp = nodeXY(fn);
    const tp = nodeXY(tn);

    // Source: right-center of from node
    const fx = fp.x + NODE_W;
    const fy = fp.y + NODE_H/2;
    // Target: left-center of to node
    const tx = tp.x;
    const ty = tp.y + NODE_H/2;

    const color = edge.color || '#60a5fa';
    const isPlaceholder = tn.type === 'placeholder';

    // Orthogonal routing for fork edges (same row vs different row)
    let pathD;
    if (fn.row === tn.row) {
      // Same row ‚Äî simple bezier
      const cx = fx + (tx-fx)*0.5;
      pathD = `M${fx},${fy} C${cx},${fy} ${cx},${ty} ${tx},${ty}`;
    } else {
      // Fork ‚Äî route with 90¬∞ elbows
      const midX = fx + COL_W * 0.45;
      pathD = `M${fx},${fy} H${midX} V${ty} H${tx}`;
    }

    const path = document.createElementNS('http://www.w3.org/2000/svg','path');
    path.setAttribute('d', pathD);
    path.setAttribute('stroke', color);
    path.setAttribute('stroke-width', isPlaceholder ? '1.5' : '2');
    path.setAttribute('fill','none');
    path.setAttribute('opacity', isPlaceholder ? '0.35' : '0.8');
    if (isPlaceholder) path.setAttribute('stroke-dasharray','5,4');
    svg.appendChild(path);

    // Dots
    [{ cx:fx, cy:fy, r:3 },{ cx:tx, cy:ty, r:3.5 }].forEach(({cx,cy,r})=>{
      const c = document.createElementNS('http://www.w3.org/2000/svg','circle');
      c.setAttribute('cx',cx); c.setAttribute('cy',cy);
      c.setAttribute('r',r); c.setAttribute('fill',color);
      c.setAttribute('opacity', isPlaceholder ? '0.3' : '0.85');
      svg.appendChild(c);
    });

    // Edge label
    if (edge.label) {
      const mx = (fx + tx) / 2;
      const my = Math.min(fy,ty) - 9;
      const lbl = document.createElementNS('http://www.w3.org/2000/svg','text');
      lbl.setAttribute('x',mx); lbl.setAttribute('y',my);
      lbl.setAttribute('text-anchor','middle');
      lbl.setAttribute('fill',color); lbl.setAttribute('font-size','9');
      lbl.setAttribute('font-family','IBM Plex Mono, monospace');
      lbl.setAttribute('font-weight','600');
      lbl.setAttribute('opacity','0.85');
      lbl.textContent = edge.label;
      svg.appendChild(lbl);
    }
  });
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  MINIMAP
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function renderMinimap() {
  const inner = document.getElementById('mmInner');
  inner.querySelectorAll('.mm-node').forEach(el => el.remove());
  if (nodes.length === 0) return;

  const xs = nodes.map(n => colRowToXY(n.col,n.row).x);
  const ys = nodes.map(n => colRowToXY(n.col,n.row).y);
  const minX = Math.min(...xs), maxX = Math.max(...xs)+NODE_W;
  const minY = Math.min(...ys), maxY = Math.max(...ys)+NODE_H;
  const rangeX = maxX-minX || 400, rangeY = maxY-minY || 300;

  nodes.forEach(n => {
    if (n.type === 'placeholder') return;
    const def = DEFS[n.type];
    const {x,y} = colRowToXY(n.col,n.row);
    const dot = document.createElement('div');
    dot.className = 'mm-node';
    dot.style.background = def?.color || '#4a5270';
    dot.style.left = ((x-minX)/rangeX * 110 + 7) + 'px';
    dot.style.top  = ((y-minY)/rangeY * 62 + 7) + 'px';
    inner.appendChild(dot);
  });
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  PROPERTIES PANEL
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function selectNode(id) {
  selectedId = id;
  const node = getNode(id);
  if (!node || node.type === 'placeholder') { closePanel(); return; }
  render();
  openProperties(node);
}

function openProperties(node) {
  const panel = document.getElementById('rightPanel');
  panel.classList.add('open');
  const def = DEFS[node.type];
  document.getElementById('rpTitle').textContent = node.label || def?.label || 'Node';
  document.getElementById('rpSub').textContent = getCat(node.type);
  document.getElementById('rpBody').innerHTML = buildProps(node);
}

function closePanel() {
  document.getElementById('rightPanel').classList.remove('open');
  selectedId = null;
  render();
}

function getCat(type) {
  if (['trigger','schedule'].includes(type)) return 'Trigger Node';
  if (['wait','random','event-split','condition','end','pull'].includes(type)) return 'Flow Control';
  if (['bonus','leaderboard','mission','tournament','skin','coins','shop','esb'].includes(type)) return 'Activity Node';
  if (['rtmsg','email','sms','push','slack'].includes(type)) return 'Communication Node';
  return 'Player Data Node';
}

function buildProps(node) {
  let h = `
    <div class="field-group">
      <label class="field-label">Label</label>
      <input class="field-input" id="pLabel" value="${node.label||''}" oninput="liveLabel(this.value)"/>
    </div>
    <div class="field-group">
      <label class="field-label">Description</label>
      <textarea class="field-input field-textarea" id="pDesc" placeholder="Notes for your team‚Ä¶">${node.config.description||''}</textarea>
    </div>
    <div class="divider"></div>
  `;

  if (node.type === 'trigger') {
    const evs = ['Login','Deposit','Game Round Complete','Level Up','Daily Check-in','Page Move','Tournament Start','Near Miss','Achievement Unlocked','Balance Low'];
    h += `
      <div class="field-group">
        <label class="field-label">Trigger Events <span style="color:var(--text3)">(max 3 ‚Äî each creates a branch)</span></label>
        <div class="event-list">
          ${evs.map(ev => {
            const chk = (node.config.events||[]).includes(ev);
            return `<label class="event-check ${chk?'checked':''}" id="evl_${ev.replace(/\W/g,'_')}">
              <input type="checkbox" ${chk?'checked':''} onchange="toggleEv('${ev}',this)"/>
              <span class="event-check-label">${ev}</span>
            </label>`;
          }).join('')}
        </div>
        <div class="event-summary" id="evSummary" style="${(node.config.events||[]).length?'display:block':''}">
          <div class="es-title">Creates ${(node.config.events||[]).length} branch${(node.config.events||[]).length!==1?'es':''}</div>
          <div class="es-tags" id="esTags">${(node.config.events||[]).map(e=>`<span class="es-tag">${e}</span>`).join('')}</div>
        </div>
      </div>
      <div class="divider"></div>
      <div class="field-group">
        <label class="field-label">Entry Conditions</label>
        <div id="condList"></div>
        <button class="add-cond-btn" onclick="addCond()">+ Add Condition</button>
      </div>
    `;
  }

  if (node.type === 'schedule') {
    h += `
      <div class="field-group"><label class="field-label">Start Date & Time</label><input type="datetime-local" class="field-input"/></div>
      <div class="field-group"><label class="field-label">Recurrence</label>
        <select class="field-select"><option>One-time</option><option>Daily</option><option>Weekly</option><option>Monthly</option></select>
      </div>
    `;
  }

  if (node.type === 'wait') {
    h += `
      <div class="field-group"><label class="field-label">Duration</label>
        <div style="display:flex;gap:6px">
          <input class="field-input" type="number" value="24" style="width:72px"/>
          <select class="field-select"><option>Minutes</option><option selected>Hours</option><option>Days</option></select>
        </div>
      </div>
      <div class="field-group"><label class="field-label">Or Wait For Event</label>
        <select class="field-select"><option value="">Time only</option><option>Next Login</option><option>Next Deposit</option><option>Game Round Complete</option></select>
      </div>
    `;
  }

  if (node.type === 'condition') {
    h += `
      <div class="field-group">
        <label class="field-label">Condition Rules</label>
        <div id="condList">
          ${buildCondRow()}
        </div>
        <button class="add-cond-btn" onclick="addCond()">+ Add Condition</button>
      </div>
    `;
  }

  if (node.type === 'event-split') {
    h += `
      <div class="field-group"><label class="field-label">Listen For Event</label>
        <select class="field-select"><option>Next Login</option><option>Next Deposit</option><option>Game Round Complete</option><option>Tournament Rank Change</option></select>
      </div>
      <div class="field-group"><label class="field-label">Timeout</label>
        <div style="display:flex;gap:6px">
          <input class="field-input" type="number" value="48" style="width:72px"/>
          <select class="field-select"><option>Minutes</option><option selected>Hours</option><option>Days</option></select>
        </div>
      </div>
    `;
  }

  if (node.type === 'random') {
    h += `
      <div class="field-group"><label class="field-label">Branch Weights</label>
        <div style="display:flex;flex-direction:column;gap:5px">
          ${['Branch A','Branch B','Branch C'].map((b,i)=>`
            <div style="display:flex;align-items:center;gap:7px">
              <span style="font-size:10px;color:var(--text3);min-width:56px">${b}</span>
              <input class="field-input" type="number" value="33" style="width:56px" min="0" max="100"/>
              <span style="font-size:10px;color:var(--text3)">%</span>
            </div>`).join('')}
        </div>
      </div>
    `;
  }

  if (['rtmsg','email','sms','push'].includes(node.type)) {
    h += `
      <div class="field-group"><label class="field-label">Template</label>
        <select class="field-select"><option>Welcome Email</option><option>Deposit Confirmation</option><option>Tournament Invite</option><option>Bonus Awarded</option><option>VIP Upgrade</option><option>Re-engagement</option></select>
      </div>
    `;
    if (node.type === 'rtmsg') {
      h += `
        <div class="field-group"><label class="field-label">Presentation Type</label>
          <select class="field-select"><option>Overlay</option><option>Big Toast</option><option>Small Toast</option><option>Pic in Pic</option><option>Lobby Banner</option></select>
        </div>
        <div class="field-group"><label class="field-label">Priority</label>
          <select class="field-select"><option>Sales (P1)</option><option>Compliance (P1)</option><option>Campaign Update (P2)</option><option>Follow-up (P3)</option></select>
        </div>
      `;
    }
    if (node.type === 'sms' || node.type === 'email') {
      h += `<div class="field-group"><label class="field-label">Send Timing</label>
        <select class="field-select"><option>Immediately</option><option>After 10 min</option><option>After 1 hour</option><option>Next day 10am</option></select>
      </div>`;
    }
  }

  if (node.type === 'bonus') {
    h += `
      <div class="field-group"><label class="field-label">Bonus Type</label>
        <select class="field-select"><option>Free Spins</option><option>Deposit Match</option><option>Cash Bonus</option><option>Loyalty Points</option></select>
      </div>
      <div class="field-group"><label class="field-label">Amount</label><input class="field-input" type="number" placeholder="e.g. 20"/></div>
      <div class="field-group"><label class="field-label">Expiry (hours)</label><input class="field-input" type="number" placeholder="e.g. 72"/></div>
    `;
  }

  if (node.type === 'pull') {
    h += `
      <div class="field-group"><label class="field-label">Data Source</label>
        <select class="field-select"><option>Real-time event stream</option><option>Historical DWH</option><option>Player profile</option></select>
      </div>
      <div class="field-group"><label class="field-label">Field to Pull</label>
        <select class="field-select"><option>Total Bets Amount</option><option>Last Login Date</option><option>VIP Level</option><option>Current Balance</option><option>Tournament Rank</option></select>
      </div>
    `;
  }

  if (['leaderboard','mission','tournament'].includes(node.type)) {
    h += `
      <div class="field-group"><label class="field-label">Action</label>
        <select class="field-select"><option>Add to</option><option>Remove from</option></select>
      </div>
      <div class="field-group"><label class="field-label">${DEFS[node.type].label} Name</label>
        <select class="field-select"><option>Spring Tournament</option><option>Weekend Warriors</option><option>VIP Exclusive</option></select>
      </div>
    `;
  }

  if (node.type === 'tag') {
    h += `
      <div class="field-group"><label class="field-label">Action</label>
        <select class="field-select"><option>Add Tag</option><option>Remove Tag</option></select>
      </div>
      <div class="field-group"><label class="field-label">Tag Name</label><input class="field-input" placeholder="e.g. high_value_churned"/></div>
      <div class="field-group"><label class="field-label">Tag Value (optional)</label><input class="field-input" placeholder="e.g. true"/></div>
    `;
  }

  if (node.type === 'vip' || node.type === 'status') {
    h += `
      <div class="field-group"><label class="field-label">New Level</label>
        <select class="field-select"><option>Level 1 ‚Äî Bronze</option><option>Level 2 ‚Äî Silver</option><option>Level 3 ‚Äî Gold</option><option>Level 4 ‚Äî Platinum</option><option>Level 5 ‚Äî Diamond</option></select>
      </div>
    `;
  }

  return h;
}

function buildCondRow(label) {
  return `<div class="cond-row">
    <div class="cond-fields">
      <select class="cond-sel" onchange="condFieldChange(this)">
        <option>VIP Level</option><option>Balance</option><option>Country</option>
        <option>Opted In</option><option>Tournament Rank Position</option>
        <option>Message Sent</option><option>Player Tag</option>
      </select>
      <select class="cond-sel" style="max-width:76px"><option>= Equals</option><option>&gt; Greater</option><option>&lt; Less</option><option>Has</option></select>
      <input class="cond-sel" placeholder="Value" style="border:1px solid var(--border2);background:var(--surface3);color:var(--text);border-radius:5px;padding:5px 7px;font-family:Outfit,sans-serif;outline:none"/>
    </div>
    <div class="sub-field" id="condSubField" style="display:none"></div>
    <div class="cond-footer">
      <span class="logic-tag" onclick="toggleLogic(this)">AND</span>
      <button class="cond-remove" onclick="this.closest('.cond-row').remove()">‚úï remove</button>
    </div>
  </div>`;
}

function condFieldChange(sel) {
  const row = sel.closest('.cond-row');
  const sub = row.querySelector('.sub-field');
  const val = sel.value;
  if (val === 'Opted In') {
    sub.style.display='block';
    sub.innerHTML=`
      <select class="cond-sel" style="width:100%;margin-bottom:4px"><option>Opted In</option><option>Not Opted In</option></select>
      <select class="cond-sel" style="width:100%"><option>Spring Promotion 2024</option><option>Summer Bonus</option><option>VIP Exclusive</option><option>Welcome Series</option><option>Weekend Warriors</option></select>
    `;
  } else if (val === 'Tournament Rank Position') {
    sub.style.display='block';
    sub.innerHTML=`<input class="cond-sel" type="number" placeholder="Rank position e.g. 10" style="width:100%;border:1px solid var(--border2);background:var(--surface3);color:var(--text);border-radius:5px;padding:5px 7px;font-family:Outfit,sans-serif;outline:none"/>`;
  } else if (val === 'Message Sent') {
    sub.style.display='block';
    sub.innerHTML=`
      <select class="cond-sel" style="width:100%;margin-bottom:4px"><option>Message Sent</option><option>Message Not Sent</option></select>
      <select class="cond-sel" style="width:100%"><option>Welcome Email</option><option>Deposit Confirmation</option><option>Withdrawal Notification</option><option>Bonus Awarded</option><option>VIP Upgrade</option><option>Re-engagement</option></select>
    `;
  } else {
    sub.style.display='none'; sub.innerHTML='';
  }
}

function addCond() {
  const list = document.getElementById('condList');
  if (!list) return;
  list.insertAdjacentHTML('beforeend', buildCondRow());
}

function toggleLogic(el) {
  el.textContent = el.textContent === 'AND' ? 'OR' : 'AND';
}

function liveLabel(val) {
  if (!selectedId) return;
  const node = getNode(selectedId);
  if (node) { node.label = val; renderNodes(); }
}

function saveNode() {
  if (!selectedId) return;
  const node = getNode(selectedId);
  if (!node) return;
  const lbl = document.getElementById('pLabel');
  const desc = document.getElementById('pDesc');
  if (lbl) node.label = lbl.value;
  if (desc) node.config.description = desc.value;
  render(); showAlert('‚úì Node saved');
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  EVENT CHECKBOXES (trigger)
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function toggleEv(ev, cb) {
  const node = getNode(selectedId);
  if (!node) return;
  if (!node.config.events) node.config.events = [];
  if (cb.checked) {
    if (node.config.events.length >= 3) { cb.checked=false; showAlert('‚ö† Max 3 events'); return; }
    node.config.events.push(ev);
    cb.closest('.event-check').classList.add('checked');
  } else {
    node.config.events = node.config.events.filter(e => e !== ev);
    cb.closest('.event-check').classList.remove('checked');
  }
  const sum = document.getElementById('evSummary');
  const tags = document.getElementById('esTags');
  const count = node.config.events.length;
  if (count > 0) {
    sum.style.display='block';
    sum.querySelector('.es-title').textContent = `Creates ${count} branch${count!==1?'es':''}`;
    tags.innerHTML = node.config.events.map(e=>`<span class="es-tag">${e}</span>`).join('');
  } else { sum.style.display='none'; }
  updateTriggerBranches(node);
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  DELETE NODE ‚Äî confirm for fork nodes, soft-delete others
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
let pendingDeleteId = null;

function deleteNode(id) {
  const node = getNode(id);
  if (!node) return;
  snapshot();  // save before any mutation

  const isTrigger = node.type === 'trigger' || node.type === 'schedule';
  const isFork    = DEFS[node.type]?.fork;

  if (isTrigger || isFork) {
    const downstream = getDownstream(id);
    const count = downstream.filter(n => n.type !== 'placeholder').length;
    pendingDeleteId = id;

    if (isTrigger) {
      document.getElementById('confirmTitle').textContent = `Delete the trigger and reset journey?`;
      document.getElementById('confirmBody').textContent =
        `This will remove the trigger node and all ${count} connected nodes, clearing the entire canvas. You'll be able to choose a new trigger type.`;
      document.getElementById('confirmBtn').textContent = `Reset Journey`;
    } else {
      document.getElementById('confirmTitle').textContent = `Delete "${node.label}" and its branch?`;
      document.getElementById('confirmBody').textContent =
        `This will remove this node${count > 0 ? ` and ${count} downstream node${count !== 1 ? 's' : ''}` : ''} on this branch. ` +
        `To swap the event type instead, use the event selector in the properties panel.`;
      document.getElementById('confirmBtn').textContent = count > 0 ? `Delete Branch (${count + 1} nodes)` : 'Delete Node';
    }
    document.getElementById('confirmOverlay').classList.add('open');
    return;
  }

  // All other nodes: soft-delete ‚Äî convert to placeholder in same slot
  executeSoftDelete(id);
}

function confirmDeleteExecute() {
  if (!pendingDeleteId) return;
  const node = getNode(pendingDeleteId);
  const isTrigger = node?.type === 'trigger' || node?.type === 'schedule';
  hideConfirm();
  executeHardDelete(pendingDeleteId);
  pendingDeleteId = null;
  // If it was the trigger, reset to gate so user picks a new trigger type
  if (isTrigger) {
    nodes = []; edges = []; nc = 0; triggerType = null;
    closePanel();
    const gate = document.getElementById('triggerGate');
    gate.style.opacity = '1'; gate.style.pointerEvents = 'all';
    render(); updateStats();
    showAlert('Canvas reset ‚Äî choose a new trigger');
  }
}

function hideConfirm() {
  document.getElementById('confirmOverlay').classList.remove('open');
  pendingDeleteId = null;
}

function executeSoftDelete(id) {
  const node = getNode(id);
  if (!node) return;
  if (node.type === 'end') {
    nodes = nodes.filter(n => n.id !== id);
    edges = edges.filter(e => e.from !== id && e.to !== id);
    if (selectedId === id) closePanel();
    render(); updateStats(); showAlert('üóë End node removed');
    return;
  }
  const inEdge = edges.find(e => e.to === id);
  const branchLabel = inEdge?.label || '';
  const outEdges = edges.filter(e => e.from === id);
  outEdges.forEach(e => {
    if (getNode(e.to)?.type === 'placeholder') nodes = nodes.filter(n => n.id !== e.to);
  });
  edges = edges.filter(e => e.from !== id);
  if (inEdge) inEdge.color = '#2e3448';
  node.type = 'placeholder';
  node.label = '';
  node.config = {};
  node.branchLabel = branchLabel;
  node.ghost = true;   // marks this as a deleted-node slot, not a fresh branch placeholder
  if (selectedId === id) closePanel();
  render(); updateStats(); showAlert('üóë Node removed ‚Äî slot kept open');
}

function executeHardDelete(id) {
  const downstream = getDownstream(id);
  const toRemove = new Set([id, ...downstream.map(n => n.id)]);
  nodes = nodes.filter(n => !toRemove.has(n.id));
  edges = edges.filter(e => !toRemove.has(e.from) && !toRemove.has(e.to));
  if (selectedId && toRemove.has(selectedId)) closePanel();
  render(); updateStats();
  showAlert(`üóë Branch deleted ‚Äî ${toRemove.size} node${toRemove.size !== 1 ? 's' : ''} removed`);
}

function getDownstream(startId) {
  const visited = new Set();
  const queue = [startId];
  while (queue.length) {
    const cur = queue.shift();
    edges.filter(e => e.from === cur).forEach(e => {
      if (!visited.has(e.to)) { visited.add(e.to); queue.push(e.to); }
    });
  }
  return nodes.filter(n => visited.has(n.id));
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  CLEAR
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function clearCanvas() {
  snapshot();
  nodes=[]; edges=[]; selectedId=null; triggerType=null; nc=0;
  closePanel();
  const gate = document.getElementById('triggerGate');
  gate.style.opacity='1'; gate.style.pointerEvents='all';
  render(); updateStats(); showAlert('üóë Canvas cleared');
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  VALIDATE
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function validateJourney() {
  const issues = [];
  const real = nodes.filter(n => n.type !== 'placeholder');

  if (real.length < 2) { issues.push({t:'error', msg:'Journey needs at least 2 nodes'}); }

  // Disconnected non-trigger, non-placeholder nodes
  real.forEach(n => {
    if (n.type === 'trigger' || n.type === 'schedule') return;
    const hasIncoming = edges.some(e => e.to === n.id);
    if (!hasIncoming) issues.push({t:'warn', msg:`"${n.label}" has no incoming connection`});
  });

  // Fork nodes with no outgoing real connections
  real.filter(n => DEFS[n.type]?.fork).forEach(n => {
    const realOut = edges.filter(e => e.from === n.id && getNode(e.to)?.type !== 'placeholder');
    if (realOut.length === 0) issues.push({t:'warn', msg:`"${n.label}" has no connected branches yet`});
  });

  // No End node
  if (!real.some(n => n.type === 'end')) issues.push({t:'warn', msg:'No End node ‚Äî some branches may be open-ended'});

  const body = document.getElementById('valBody');
  if (issues.length === 0) {
    body.innerHTML = `<div class="val-item ok"><div class="val-dot"></div>Journey looks good ‚Äî ready to publish</div>`;
  } else {
    body.innerHTML = issues.map(i => `<div class="val-item ${i.t}"><div class="val-dot"></div>${i.msg}</div>`).join('');
  }
  document.getElementById('valToast').style.display = 'block';
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  PUBLISH
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function publishJourney() {
  validateJourney();
  const toast = document.getElementById('valToast');
  const hasErrors = document.querySelectorAll('.val-item.error').length > 0;
  if (hasErrors) { showAlert('‚õî Fix errors before publishing'); return; }
  document.getElementById('statusDot').style.background = '#22c55e';
  document.getElementById('statusLabel').textContent = 'Live';
  document.getElementById('bStatus').textContent = 'Published ‚Äî live';
  toast.style.display = 'none';
  showAlert('üöÄ Journey published!');
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  CANVAS INTERACTION ‚Äî pan + zoom
//  Pan: click+drag on background OR hold Space + drag anywhere
//  Zoom: scroll wheel (toward cursor)
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
const canvasWrap = document.getElementById('canvasWrap');
let isPanning = false;
let panStart = {x:0, y:0};
let panOrigin = {x:0, y:0};
let spaceDown = false;
let didPan = false;  // track if we actually moved (to suppress click)

// Space bar enables pan mode anywhere on canvas
document.addEventListener('keydown', e => {
  // Undo / Redo
  if ((e.ctrlKey || e.metaKey) && e.code === 'KeyZ' && !e.shiftKey) {
    e.preventDefault(); undo(); return;
  }
  if ((e.ctrlKey || e.metaKey) && (e.code === 'KeyY' || (e.code === 'KeyZ' && e.shiftKey))) {
    e.preventDefault(); redo(); return;
  }
  if (e.code === 'Space' && !e.target.closest('input,textarea,select')) {
    e.preventDefault();
    spaceDown = true;
    canvasWrap.style.cursor = 'grab';
  }
  // Delete selected node with Delete/Backspace key
  if ((e.code === 'Delete' || e.code === 'Backspace') && selectedId && !e.target.closest('input,textarea,select')) {
    deleteNode(selectedId);
  }
});
document.addEventListener('keyup', e => {
  if (e.code === 'Space') {
    spaceDown = false;
    if (!isPanning) canvasWrap.style.cursor = 'default';
  }
});

// Mousedown ‚Äî start pan if: space held, middle button, or clicking empty canvas
canvasWrap.addEventListener('mousedown', e => {
  // Middle mouse button always pans
  const isMiddle = e.button === 1;
  // Left click on empty canvas (not on a node/placeholder/button)
  const onEmpty = e.button === 0 && (
    e.target === canvasWrap ||
    e.target === document.getElementById('viewport') ||
    e.target === document.getElementById('connSvg') ||
    e.target.classList.contains('connections-svg')
  );
  // Left click anywhere when space is held
  const spaceClick = e.button === 0 && spaceDown;

  if (isMiddle || onEmpty || spaceClick) {
    e.preventDefault();
    isPanning = true;
    didPan = false;
    panStart = {x: e.clientX, y: e.clientY};
    panOrigin = {x: pan.x, y: pan.y};
    canvasWrap.style.cursor = 'grabbing';
  }
});

document.addEventListener('mousemove', e => {
  if (!isPanning) return;
  const dx = e.clientX - panStart.x;
  const dy = e.clientY - panStart.y;
  // Only flag as "did pan" if moved more than 3px (prevents accidental deselect)
  if (Math.abs(dx) > 3 || Math.abs(dy) > 3) didPan = true;
  pan.x = panOrigin.x + dx;
  pan.y = panOrigin.y + dy;
  applyTransform();
});

document.addEventListener('mouseup', e => {
  if (!isPanning) return;
  isPanning = false;
  canvasWrap.style.cursor = spaceDown ? 'grab' : 'default';
  // If we barely moved ‚Äî treat as a deselect click on empty canvas
  if (!didPan && (
    e.target === canvasWrap ||
    e.target === document.getElementById('viewport') ||
    e.target === document.getElementById('connSvg') ||
    e.target.classList.contains('connections-svg')
  )) {
    closePanel();
  }
});

// ‚îÄ‚îÄ ZOOM ‚Äî wheel toward cursor ‚îÄ‚îÄ
canvasWrap.addEventListener('wheel', e => {
  e.preventDefault();
  // Normalise delta across devices (trackpad sends small floats, mouse wheel sends 100+)
  const rawDelta = e.deltaY;
  // Map to a consistent zoom factor regardless of device speed
  const zoomSpeed = 0.001;
  const factor = Math.pow(2, -rawDelta * zoomSpeed);  // smooth exponential
  const clampedFactor = Math.min(Math.max(factor, 0.85), 1.2); // max 20% per event

  const rect = canvasWrap.getBoundingClientRect();
  const mx = e.clientX - rect.left;
  const my = e.clientY - rect.top;

  const newScale = Math.min(Math.max(scale * clampedFactor, 0.15), 4);
  const actualFactor = newScale / scale;

  pan.x = mx - (mx - pan.x) * actualFactor;
  pan.y = my - (my - pan.y) * actualFactor;
  scale = newScale;
  applyTransform();
}, {passive: false});

function doZoom(f) {
  const rect = canvasWrap.getBoundingClientRect();
  const mx = rect.width / 2, my = rect.height / 2;
  const newScale = Math.min(Math.max(scale * f, 0.15), 4);
  const actual = newScale / scale;
  pan.x = mx - (mx - pan.x) * actual;
  pan.y = my - (my - pan.y) * actual;
  scale = newScale;
  applyTransform();
}

function fitCanvas() {
  const allNodes = nodes.filter(n => n.type !== 'placeholder' || edges.some(e => e.to === n.id));
  if (allNodes.length === 0) { scale = 1; pan = {x: 120, y: 80}; applyTransform(); return; }

  // Get actual pixel positions of all nodes
  const positions = allNodes.map(n => colRowToXY(n.col, n.row));
  const PADDING = 60;

  const minX = Math.min(...positions.map(p => p.x)) - PADDING;
  const minY = Math.min(...positions.map(p => p.y)) - PADDING;
  const maxX = Math.max(...positions.map(p => p.x)) + NODE_W + PADDING;
  const maxY = Math.max(...positions.map(p => p.y)) + NODE_H + PADDING;

  const contentW = maxX - minX;
  const contentH = maxY - minY;

  const rect = document.getElementById('canvasWrap').getBoundingClientRect();
  const scaleX = rect.width  / contentW;
  const scaleY = rect.height / contentH;
  const newScale = Math.min(scaleX, scaleY, 1.2);  // never zoom in beyond 120%

  // Centre the content in the viewport
  const newPanX = (rect.width  - contentW * newScale) / 2 - minX * newScale;
  const newPanY = (rect.height - contentH * newScale) / 2 - minY * newScale;

  scale = newScale;
  pan = {x: newPanX, y: newPanY};
  applyTransform();
}

function applyTransform() {
  document.getElementById('viewport').style.transform =
    `translate(${pan.x}px, ${pan.y}px) scale(${scale})`;
  document.getElementById('zoomLbl').textContent = Math.round(scale * 100) + '%';
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  SECTION TOGGLE
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function toggleSec(id) {
  const el = document.getElementById('sec-'+id);
  const arr = document.getElementById('arr-'+id);
  el.classList.toggle('collapsed');
  arr.classList.toggle('open');
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  SEARCH FILTER
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function filterNodes(q) {
  document.querySelectorAll('.node-item').forEach(el => {
    el.style.display = el.querySelector('.ni-label').textContent.toLowerCase().includes(q.toLowerCase()) ? '' : 'none';
  });
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  HEATMAP
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function toggleHeatmap() {
  heatmapOn = !heatmapOn;
  document.getElementById('hmSwitch').className = 'toggle-sw' + (heatmapOn ? '' : ' off');
  render(); showAlert(heatmapOn ? 'üü¢ Heatmap on' : '‚≠ï Heatmap off');
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  UTILS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function newId() { return 'n' + (++nc); }
function getNode(id) { return nodes.find(n => n.id === id); }
function updateStats() { document.getElementById('bNodes').textContent = nodes.filter(n=>n.type!=='placeholder').length; }

let alertTimer;
function showAlert(msg) {
  const bar = document.getElementById('alertBar');
  bar.textContent = msg; bar.style.display = 'block';
  clearTimeout(alertTimer);
  alertTimer = setTimeout(()=>bar.style.display='none', 2600);
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  DEMO LOAD
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function loadDemo() {
  triggerType = 'realtime';
  const gate = document.getElementById('triggerGate');
  gate.style.opacity='0'; gate.style.pointerEvents='none';

  // Layout: BRANCH_GAP=2 between every sibling branch
  // Trigger at row 5 (midpoint between deposit-branch rows 2 and game-branch rows 8)
  // Deposit branch centred at row 2: event-split forks to rows 1 (Yes) and 3 (No)
  // Game round branch centred at row 8: random splits to rows 6, 8, 10
  const demoNodes = [
    {id:'n1',  type:'trigger',     col:0, row:5,  label:'Real-time Trigger',  config:{events:['Deposit','Game Round']}},
    // ‚îÄ‚îÄ Deposit branch ‚îÄ‚îÄ
    {id:'n2',  type:'rtmsg',       col:1, row:2,  label:'Player Message',     config:{}},
    {id:'n3',  type:'event-split', col:2, row:2,  label:'Event Split',        config:{}},
    {id:'n4',  type:'bonus',       col:3, row:1,  label:'Add Bonus',          config:{}},
    {id:'n5',  type:'wait',        col:4, row:1,  label:'Wait 24h',           config:{}},
    {id:'n6',  type:'end',         col:5, row:1,  label:'End',                config:{}},
    {id:'n7',  type:'end',         col:3, row:3,  label:'End',                config:{}},
    // ‚îÄ‚îÄ Game Round branch ‚îÄ‚îÄ
    {id:'n8',  type:'rtmsg',       col:1, row:8,  label:'Player Message',     config:{}},
    {id:'n9',  type:'random',      col:2, row:8,  label:'Random Split',       config:{}},
    {id:'n10', type:'pull',        col:3, row:6,  label:'Pull Data',          config:{}},
    {id:'n11', type:'rtmsg',       col:4, row:6,  label:'Player Message',     config:{}},
    {id:'n12', type:'end',         col:5, row:6,  label:'End',                config:{}},
    {id:'n13', type:'bonus',       col:3, row:8,  label:'Add Bonus',          config:{}},
    {id:'n14', type:'wait',        col:4, row:8,  label:'Wait',               config:{}},
    {id:'n15', type:'end',         col:5, row:8,  label:'End',                config:{}},
    {id:'n16', type:'skin',        col:3, row:10, label:'Game Skin On',       config:{}},
    {id:'n17', type:'rtmsg',       col:4, row:10, label:'Player Message',     config:{}},
    {id:'n18', type:'end',         col:5, row:10, label:'End',                config:{}},
  ];

  const demoEdges = [
    {from:'n1', to:'n2',  label:'Deposit',     color:'#4ade80'},
    {from:'n1', to:'n8',  label:'Game Round',  color:'#4ade80'},
    {from:'n2', to:'n3',  label:'',            color:'#60a5fa'},
    {from:'n3', to:'n4',  label:'Yes',         color:'#4ade80'},
    {from:'n3', to:'n7',  label:'No',          color:'#f87171'},
    {from:'n4', to:'n5',  label:'',            color:'#60a5fa'},
    {from:'n5', to:'n6',  label:'',            color:'#60a5fa'},
    {from:'n8', to:'n9',  label:'',            color:'#60a5fa'},
    {from:'n9', to:'n10', label:'33%',         color:'#fb923c'},
    {from:'n9', to:'n13', label:'33%',         color:'#fb923c'},
    {from:'n9', to:'n16', label:'33%',         color:'#fb923c'},
    {from:'n10',to:'n11', label:'',            color:'#60a5fa'},
    {from:'n11',to:'n12', label:'',            color:'#60a5fa'},
    {from:'n13',to:'n14', label:'',            color:'#60a5fa'},
    {from:'n14',to:'n15', label:'',            color:'#60a5fa'},
    {from:'n16',to:'n17', label:'',            color:'#60a5fa'},
    {from:'n17',to:'n18', label:'',            color:'#60a5fa'},
  ];

  nodes = demoNodes; edges = demoEdges; nc = 20;
  pan = {x:30, y:30}; scale = 0.9;
  applyTransform(); render(); updateStats();
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  INIT
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
window.onload = () => {
  loadDemo();
  setInterval(() => {
    if (!triggerType) return;
    document.getElementById('bActive').textContent = (1200+Math.floor(Math.random()*100)).toLocaleString();
    document.getElementById('bJourney').textContent = (300+Math.floor(Math.random()*80)).toLocaleString();
    document.getElementById('bDone').textContent = (80+Math.floor(Math.random()*20)).toLocaleString();
  }, 3500);
};
</script>
<!-- DRAG GHOST -->
<div id="dragGhost"><div class="dg-card"><div class="dg-icon"></div><div class="dg-label"></div></div></div>

</body>
</html>
