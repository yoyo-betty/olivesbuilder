<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Olives Builder</title>
<link href="https://fonts.googleapis.com/css2?family=IBM+Plex+Mono:wght@400;500&family=Outfit:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">

<!-- ══ SHARED VARS ══ -->
<style>
*,*::before,*::after{box-sizing:border-box;margin:0;padding:0}
:root{
  --bg:#0e1017;--surface:#161921;--surface2:#1c2030;--surface3:#222638;
  --border:#252a3a;--border2:#2e3448;--border3:#3a4060;
  --text:#e2e6f0;--text2:#8892aa;--text3:#4a5270;
  --accent:#4ade80;--accent2:#22c55e;--accent-dim:rgba(74,222,128,0.08);
  --red:#f87171;--amber:#f59e0b;--blue:#60a5fa;--purple:#a78bfa;
  --pink:#d4748f;
}

/* ── PAGE SWITCHER ── */
.page-view { display: none; height: 100%; }
.page-view.active { display: block; }

/* ── LAUNCHER (hub screen) ── */
#page-launcher {
  position: fixed; inset: 0;
  background: var(--bg);
  display: flex; flex-direction: column;
  font-family: 'Outfit', sans-serif; color: var(--text);
}
#page-launcher::before {
  content:''; position:fixed; inset:0;
  background-image:radial-gradient(circle at 1px 1px,rgba(255,255,255,0.028) 1px,transparent 0);
  background-size:28px 28px; pointer-events:none; z-index:0;
}
.launcher-topbar {
  height:52px; display:flex; align-items:center; padding:0 28px; gap:10px;
  background:rgba(22,25,33,0.95); backdrop-filter:blur(12px);
  border-bottom:1px solid var(--border); position:relative; z-index:1;
}
.launcher-logo-mark {
  width:28px;height:28px;border-radius:8px;
  background:linear-gradient(135deg,#22c55e,#16a34a);
  display:flex;align-items:center;justify-content:center;
  font-size:14px;color:#fff;box-shadow:0 0 12px rgba(34,197,94,0.3);
}
.launcher-body {
  flex:1; display:flex; align-items:center; justify-content:center;
  position:relative; z-index:1;
}
.launcher-grid {
  display:grid; grid-template-columns:repeat(3,1fr);
  gap:14px; padding:32px; width:100%; max-width:900px;
}
.lcard {
  background:var(--surface); border:1px solid var(--border);
  border-radius:16px; padding:26px 22px;
  cursor:pointer; transition:all 0.2s;
  display:flex; flex-direction:column; gap:12px;
  position:relative; overflow:hidden; text-decoration:none; color:inherit;
}
.lcard:hover { border-color:var(--lc-color,var(--accent)); transform:translateY(-2px); box-shadow:0 8px 32px rgba(0,0,0,0.4); }
.lcard-icon { width:44px;height:44px;border-radius:11px;display:flex;align-items:center;justify-content:center;font-size:20px; }
.lcard-eye { font-size:9px;font-weight:700;letter-spacing:0.12em;text-transform:uppercase;font-family:'IBM Plex Mono',monospace; }
.lcard-title { font-size:17px;font-weight:800;color:var(--text);letter-spacing:-0.01em; }
.lcard-desc { font-size:12px;color:var(--text2);line-height:1.6;flex:1; }
.lcard-arrow { font-size:11px;font-weight:600;font-family:'IBM Plex Mono',monospace; }
.lcard-wide { grid-column:span 2; }

.lcard-green  { --lc-color:var(--accent);  }
.lcard-green  .lcard-eye,.lcard-green  .lcard-arrow { color:var(--accent); }
.lcard-green  .lcard-icon { background:rgba(74,222,128,0.1); }

.lcard-blue   { --lc-color:#60a5fa; }
.lcard-blue   .lcard-eye,.lcard-blue   .lcard-arrow { color:#60a5fa; }
.lcard-blue   .lcard-icon { background:rgba(96,165,250,0.1); }

.lcard-cyan   { --lc-color:#22d3ee; }
.lcard-cyan   .lcard-eye,.lcard-cyan   .lcard-arrow { color:#22d3ee; }
.lcard-cyan   .lcard-icon { background:rgba(34,211,238,0.1); }

.lcard-pink   { --lc-color:var(--pink); }
.lcard-pink   .lcard-eye,.lcard-pink   .lcard-arrow { color:var(--pink); }
.lcard-pink   .lcard-icon { background:rgba(212,116,143,0.1); }

@keyframes fadeUp{from{opacity:0;transform:translateY(14px)}to{opacity:1;transform:translateY(0)}}
.lcard { animation:fadeUp 0.3s ease both; }
.lcard:nth-child(1){animation-delay:0.04s}.lcard:nth-child(2){animation-delay:0.08s}
.lcard:nth-child(3){animation-delay:0.12s}.lcard:nth-child(4){animation-delay:0.16s}
.lcard:nth-child(5){animation-delay:0.20s}

/* ── FULLSCREEN WRAPPERS ── */
#page-home, #page-canvas, #page-features {
  position: fixed; inset: 0; overflow: hidden;
  display: none;
}
#page-home.active, #page-canvas.active, #page-features.active { display: block; }
#page-features { overflow-y: auto; background: var(--bg); }
</style>

<!-- ══ HOME CSS ══ -->
<style>
*,*::before,*::after{box-sizing:border-box;margin:0;padding:0}
:root{
  --bg:#0e1017;
  --surface:#161921;
  --surface2:#1c2030;
  --surface3:#222638;
  --border:#252a3a;
  --border2:#2e3448;
  --border3:#3a4060;
  --text:#e2e6f0;
  --text2:#8892aa;
  --text3:#4a5270;
  --accent:#4ade80;
  --accent2:#22c55e;
  --red:#f87171;
  --amber:#f59e0b;
  --blue:#60a5fa;
  --purple:#a78bfa;
}

html,body{height:100%;font-family:'Outfit',sans-serif;background:var(--bg);color:var(--text);overflow-x:hidden}

body::before{
  content:'';position:fixed;inset:0;
  background-image:radial-gradient(circle at 1px 1px,rgba(255,255,255,0.026) 1px,transparent 0);
  background-size:28px 28px;pointer-events:none;z-index:0;
}

/* ── TOPBAR ── */
.topbar{
  position:sticky;top:0;height:54px;
  background:rgba(22,25,33,0.95);backdrop-filter:blur(14px);
  border-bottom:1px solid var(--border);
  display:flex;align-items:center;padding:0 32px;
  z-index:200;gap:0;
}
.logo{display:flex;align-items:center;gap:9px}
.logo-mark{
  width:30px;height:30px;border-radius:8px;
  background:linear-gradient(135deg,#22c55e,#16a34a);
  display:flex;align-items:center;justify-content:center;
  font-size:15px;color:#fff;
  box-shadow:0 0 14px rgba(34,197,94,0.28);
}
.logo-text{font-size:15px;font-weight:700;color:var(--text)}
.logo-version{
  font-size:9px;font-family:'IBM Plex Mono',monospace;
  color:var(--text3);background:var(--surface2);
  border:1px solid var(--border);
  padding:2px 7px;border-radius:20px;margin-left:6px;
}
.vsep{width:1px;height:26px;background:var(--border);margin:0 20px}

.nav-links{display:flex;align-items:center;gap:2px}
.nav-link{
  padding:6px 14px;border-radius:7px;font-size:13px;font-weight:500;
  color:var(--text2);cursor:pointer;transition:all 0.15s;border:none;background:transparent;
  font-family:'Outfit',sans-serif;
}
.nav-link:hover{color:var(--text);background:var(--surface2)}
.nav-link.active{color:var(--text);background:var(--surface2)}

.topbar-right{margin-left:auto;display:flex;align-items:center;gap:8px}

.btn{
  display:flex;align-items:center;gap:6px;
  padding:8px 18px;border-radius:8px;
  font-size:13px;font-weight:600;font-family:'Outfit',sans-serif;
  cursor:pointer;border:1px solid transparent;
  transition:all 0.18s;white-space:nowrap;
}
.btn-ghost{background:transparent;border-color:var(--border2);color:var(--text2)}
.btn-ghost:hover{background:var(--surface2);color:var(--text);border-color:var(--border3)}
.btn-index{background:rgba(219,112,147,0.12);border-color:rgba(219,112,147,0.35);color:#d4748f;text-decoration:none;padding:4px 11px;font-size:11px;border-radius:6px}
.btn-index:hover{background:rgba(219,112,147,0.2);border-color:rgba(219,112,147,0.55);color:#e08da5}

  background:var(--accent2);border-color:var(--accent2);color:#fff;font-weight:700;
  box-shadow:0 0 18px rgba(34,197,94,0.2);
}
.btn-primary:hover{background:#16a34a;box-shadow:0 0 26px rgba(34,197,94,0.35)}

/* ── PAGE BODY ── */
.page{max-width:1200px;margin:0 auto;padding:40px 32px 80px;position:relative;z-index:1}

/* ── PAGE HEADER ── */
.page-header{
  display:flex;align-items:flex-start;justify-content:space-between;
  margin-bottom:40px;gap:24px;
}
.page-header-left{}
.page-eyebrow{
  font-size:10px;font-weight:700;letter-spacing:0.12em;
  text-transform:uppercase;color:var(--accent);
  margin-bottom:8px;display:flex;align-items:center;gap:8px;
}
.page-eyebrow::before{content:'';width:18px;height:2px;background:var(--accent);border-radius:1px}
.page-title{font-size:30px;font-weight:800;color:var(--text);letter-spacing:-0.025em;margin-bottom:6px}
.page-sub{font-size:14px;color:var(--text2);line-height:1.5}

.header-actions{display:flex;align-items:center;gap:10px;flex-shrink:0;padding-top:6px}

/* ── STATS ROW ── */
.stats-row{
  display:grid;grid-template-columns:repeat(4,1fr);
  gap:14px;margin-bottom:36px;
}
.stat-card{
  background:var(--surface);border:1px solid var(--border);
  border-radius:12px;padding:18px 20px;
  transition:border-color 0.2s;
}
.stat-card:hover{border-color:var(--border2)}
.stat-label{font-size:10px;font-weight:700;letter-spacing:0.08em;text-transform:uppercase;color:var(--text3);margin-bottom:8px}
.stat-value{font-size:26px;font-weight:800;color:var(--text);letter-spacing:-0.02em;margin-bottom:4px}
.stat-sub{font-size:11px;color:var(--text3);display:flex;align-items:center;gap:5px}
.stat-dot{width:6px;height:6px;border-radius:50%;flex-shrink:0}

/* ── SEARCH / FILTER BAR ── */
.toolbar{
  display:flex;align-items:center;gap:10px;
  margin-bottom:20px;flex-wrap:wrap;
}
.search-wrap{
  display:flex;align-items:center;gap:8px;
  background:var(--surface);border:1px solid var(--border);
  border-radius:9px;padding:9px 14px;flex:1;min-width:220px;
  max-width:340px;transition:border-color 0.18s;
}
.search-wrap:focus-within{border-color:var(--border3)}
.search-wrap input{
  background:transparent;border:none;outline:none;
  font-size:13px;font-family:'Outfit',sans-serif;
  color:var(--text);width:100%;
}
.search-wrap input::placeholder{color:var(--text3)}
.search-icon{font-size:13px;color:var(--text3)}

.filter-pills{display:flex;align-items:center;gap:6px;flex-wrap:wrap}
.filter-pill{
  padding:7px 14px;border-radius:7px;border:1px solid var(--border);
  background:var(--surface);font-size:12px;font-weight:500;
  color:var(--text2);cursor:pointer;transition:all 0.15s;
  font-family:'Outfit',sans-serif;
}
.filter-pill:hover{border-color:var(--border2);color:var(--text)}
.filter-pill.active{
  border-color:var(--border3);background:var(--surface2);
  color:var(--text);
}

.toolbar-right{margin-left:auto;display:flex;align-items:center;gap:8px}
.sort-select{
  background:var(--surface);border:1px solid var(--border);
  border-radius:8px;padding:8px 12px;
  font-size:12px;font-family:'Outfit',sans-serif;
  color:var(--text2);outline:none;cursor:pointer;
  appearance:none;padding-right:28px;
  background-image:url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='10' height='10' viewBox='0 0 10 10'%3E%3Cpath fill='%234a5270' d='M5 7L1 3h8z'/%3E%3C/svg%3E");
  background-repeat:no-repeat;background-position:right 10px center;
}

/* ── SECTION GROUPS ── */
.journey-section{margin-bottom:40px}
.section-header{
  display:flex;align-items:center;gap:12px;
  margin-bottom:14px;padding-bottom:14px;
  border-bottom:1px solid var(--border);
}
.section-title{font-size:13px;font-weight:700;color:var(--text);display:flex;align-items:center;gap:10px}
.section-badge{
  font-size:10px;font-weight:700;font-family:'IBM Plex Mono',monospace;
  padding:2px 8px;border-radius:20px;
}
.badge-active{background:rgba(74,222,128,0.12);color:var(--accent);border:1px solid rgba(74,222,128,0.2)}
.badge-design{background:rgba(96,165,250,0.1);color:var(--blue);border:1px solid rgba(96,165,250,0.18)}
.badge-done{background:rgba(74,85,104,0.3);color:var(--text3);border:1px solid var(--border2)}
.section-line{flex:1;height:1px;background:var(--border)}

/* ── JOURNEY TABLE ── */
.journey-table{width:100%;border-collapse:collapse}
.journey-table th{
  font-size:10px;font-weight:700;letter-spacing:0.08em;
  text-transform:uppercase;color:var(--text3);
  padding:0 16px 10px;text-align:left;
}
.journey-table th:last-child{text-align:right}

.journey-row{
  background:var(--surface);
  border:1px solid var(--border);
  border-radius:10px;
  transition:all 0.16s;
  cursor:default;
}
.journey-row:hover{border-color:var(--border2);background:var(--surface2)}
.journey-row td{padding:0}

/* spacer between rows */
.journey-row-spacer td{height:6px;background:transparent;border:none}

.row-cell{
  padding:15px 16px;
  display:flex;align-items:center;
  height:64px;
}

/* first/last cell rounding */
.journey-row td:first-child .row-cell{border-radius:10px 0 0 10px}
.journey-row td:last-child .row-cell{border-radius:0 10px 10px 0}

/* ── JOURNEY NAME CELL ── */
.journey-name-cell{display:flex;align-items:center;gap:12px}
.journey-type-icon{
  width:36px;height:36px;border-radius:9px;flex-shrink:0;
  display:flex;align-items:center;justify-content:center;font-size:16px;
}
.journey-info{}
.journey-name{
  font-size:14px;font-weight:600;color:var(--text);
  cursor:pointer;transition:color 0.15s;
  text-decoration:none;display:inline;
}
.journey-name:hover{color:var(--accent)}
.journey-meta{font-size:11px;color:var(--text3);margin-top:2px;display:flex;align-items:center;gap:8px}
.journey-cat{
  font-size:10px;font-weight:600;padding:2px 7px;border-radius:4px;
  background:var(--surface3);color:var(--text3);letter-spacing:0.04em;text-transform:uppercase;
}

/* ── STATUS BADGE ── */
.status-badge{
  display:inline-flex;align-items:center;gap:6px;
  font-size:11px;font-weight:600;
  padding:5px 11px;border-radius:6px;
  font-family:'IBM Plex Mono',monospace;
  white-space:nowrap;
}
.status-dot{width:6px;height:6px;border-radius:50%;flex-shrink:0}
.s-live{background:rgba(74,222,128,0.1);color:var(--accent);border:1px solid rgba(74,222,128,0.2)}
.s-live .status-dot{background:var(--accent);box-shadow:0 0 6px rgba(74,222,128,0.6);animation:blink 2s infinite}
.s-paused{background:rgba(245,158,11,0.08);color:var(--amber);border:1px solid rgba(245,158,11,0.18)}
.s-paused .status-dot{background:var(--amber)}
.s-design{background:rgba(96,165,250,0.08);color:var(--blue);border:1px solid rgba(96,165,250,0.18)}
.s-design .status-dot{background:var(--blue)}
.s-draft{background:rgba(74,85,104,0.2);color:var(--text3);border:1px solid var(--border2)}
.s-draft .status-dot{background:var(--text3)}
.s-done{background:rgba(167,139,250,0.08);color:var(--purple);border:1px solid rgba(167,139,250,0.15)}
.s-done .status-dot{background:var(--purple)}
.s-blocked{background:rgba(248,113,113,0.08);color:var(--red);border:1px solid rgba(248,113,113,0.15)}
.s-blocked .status-dot{background:var(--red)}

@keyframes blink{0%,100%{opacity:1}50%{opacity:0.4}}

/* ── STATS CELLS ── */
.stat-cell{
  font-size:13px;font-weight:600;color:var(--text);
  font-family:'IBM Plex Mono',monospace;
}
.stat-cell .sub{font-size:10px;font-weight:500;color:var(--text3);display:block;margin-top:1px;font-family:'Outfit',sans-serif}

/* ── MINI SPARKLINE ── */
.sparkline{display:flex;align-items:flex-end;gap:2px;height:24px}
.spark-bar{width:4px;border-radius:2px;background:var(--border2);transition:background 0.2s}
.journey-row:hover .spark-bar{background:var(--border3)}

/* ── 3-DOT MENU ── */
.dot-menu-wrap{position:relative}
.dot-btn{
  width:32px;height:32px;border-radius:7px;
  background:transparent;border:1px solid transparent;
  color:var(--text3);cursor:pointer;
  display:flex;align-items:center;justify-content:center;
  font-size:16px;transition:all 0.15s;letter-spacing:1px;
  font-family:'Outfit',sans-serif;
}
.dot-btn:hover{background:var(--surface3);border-color:var(--border2);color:var(--text2)}
.dot-btn.open{background:var(--surface3);border-color:var(--border2);color:var(--text)}

.dot-menu{
  position:absolute;right:0;top:calc(100% + 6px);
  background:var(--surface);border:1px solid var(--border2);
  border-radius:10px;padding:5px;
  min-width:180px;z-index:300;
  box-shadow:0 12px 40px rgba(0,0,0,0.6);
  display:none;
}
.dot-menu.open{display:block;animation:menuIn 0.12s ease}
@keyframes menuIn{from{opacity:0;transform:translateY(-6px)}to{opacity:1;transform:translateY(0)}}

.dot-menu-item{
  display:flex;align-items:center;gap:10px;
  padding:9px 12px;border-radius:7px;
  font-size:12px;font-weight:500;color:var(--text2);
  cursor:pointer;transition:all 0.12s;
  border:none;background:transparent;width:100%;
  font-family:'Outfit',sans-serif;text-align:left;
}
.dot-menu-item:hover{background:var(--surface2);color:var(--text)}
.dot-menu-item .mi-icon{width:20px;text-align:center;font-size:13px;flex-shrink:0}
.dot-menu-item.danger{color:var(--red)}
.dot-menu-item.danger:hover{background:rgba(248,113,113,0.08);color:var(--red)}
.dot-menu-sep{height:1px;background:var(--border);margin:4px 0}

/* ── EMPTY STATE ── */
.empty-state{
  text-align:center;padding:52px 24px;
  background:var(--surface);border:1px dashed var(--border2);
  border-radius:12px;margin-bottom:6px;
}
.empty-icon{font-size:32px;margin-bottom:12px}
.empty-title{font-size:15px;font-weight:700;color:var(--text2);margin-bottom:6px}
.empty-sub{font-size:13px;color:var(--text3);line-height:1.6}

/* ── TEMPLATE MODAL ── */
.modal-overlay{
  position:fixed;inset:0;background:rgba(0,0,0,0.72);
  backdrop-filter:blur(6px);z-index:500;
  display:none;align-items:center;justify-content:center;
}
.modal-overlay.open{display:flex;animation:overlayIn 0.2s ease}
@keyframes overlayIn{from{opacity:0}to{opacity:1}}

.modal{
  background:var(--surface);border:1px solid var(--border2);
  border-radius:16px;width:720px;max-width:95vw;max-height:85vh;
  overflow:hidden;display:flex;flex-direction:column;
  box-shadow:0 32px 80px rgba(0,0,0,0.7);
  animation:modalIn 0.22s ease;
}
@keyframes modalIn{from{opacity:0;transform:scale(0.96)}to{opacity:1;transform:scale(1)}}

.modal-header{
  display:flex;align-items:center;justify-content:space-between;
  padding:22px 26px;border-bottom:1px solid var(--border);flex-shrink:0;
}
.modal-title{font-size:17px;font-weight:700;color:var(--text)}
.modal-sub{font-size:12px;color:var(--text3);margin-top:3px}
.modal-close{
  width:32px;height:32px;border-radius:7px;
  background:transparent;border:1px solid var(--border2);
  color:var(--text3);cursor:pointer;font-size:14px;
  display:flex;align-items:center;justify-content:center;
  transition:all 0.15s;
}
.modal-close:hover{background:var(--surface2);color:var(--text)}

.modal-body{padding:24px 26px;overflow-y:auto;flex:1}
.modal-body::-webkit-scrollbar{width:4px}
.modal-body::-webkit-scrollbar-thumb{background:var(--border2);border-radius:2px}

.template-grid{display:grid;grid-template-columns:1fr 1fr;gap:12px}
.template-card{
  background:var(--surface2);border:1px solid var(--border);
  border-radius:11px;padding:18px;cursor:pointer;
  transition:all 0.18s;
}
.template-card:hover{border-color:var(--accent);background:rgba(74,222,128,0.04);transform:translateY(-1px)}
.tc-icon{font-size:24px;margin-bottom:10px}
.tc-name{font-size:13px;font-weight:700;color:var(--text);margin-bottom:4px}
.tc-desc{font-size:11px;color:var(--text3);line-height:1.5;margin-bottom:10px}
.tc-tags{display:flex;gap:5px;flex-wrap:wrap}
.tc-tag{
  font-size:10px;font-weight:600;padding:2px 8px;border-radius:4px;
  background:var(--surface3);color:var(--text3);
  text-transform:uppercase;letter-spacing:0.04em;
}

/* ── RESPONSIVE ── */
@media(max-width:900px){
  .stats-row{grid-template-columns:repeat(2,1fr)}
  .template-grid{grid-template-columns:1fr}
}


/* ── OVERLAY SHELL ── */
#setupOverlay{
  position:fixed;inset:0;z-index:400;
  background:var(--bg);
  display:none;flex-direction:column;
  animation:none;
}
#setupOverlay.open{display:flex;animation:suSlideIn 0.28s ease}
@keyframes suSlideIn{from{opacity:0;transform:translateY(18px)}to{opacity:1;transform:translateY(0)}}

/* ── SETUP TOPBAR ── */
.su-topbar{
  height:54px;flex-shrink:0;
  background:rgba(22,25,33,0.97);backdrop-filter:blur(14px);
  border-bottom:1px solid var(--border);
  display:flex;align-items:center;padding:0 28px;gap:0;z-index:10;
}
.su-breadcrumb-wrap{display:flex;align-items:center;gap:8px;font-size:12px;color:var(--text3)}
.su-bc-item{color:var(--text2);cursor:pointer}
.su-bc-item:hover{color:var(--text)}
.su-bc-sep{color:var(--text3)}
.su-bc-active{color:var(--text)}
.su-topbar-right{margin-left:auto;display:flex;align-items:center;gap:8px}

/* ── SETUP BODY ── */
.su-shell{display:flex;flex:1;overflow:hidden}

/* ── SETUP SIDEBAR ── */
.su-sidebar{
  width:256px;flex-shrink:0;
  background:var(--surface);border-right:1px solid var(--border);
  padding:32px 22px;display:flex;flex-direction:column;
}
.su-sidebar-heading{font-size:10px;font-weight:700;letter-spacing:0.1em;text-transform:uppercase;color:var(--text3);margin-bottom:26px}
.su-step-list{display:flex;flex-direction:column}
.su-step-item{display:flex;align-items:flex-start;gap:13px;padding:13px 0;position:relative;cursor:pointer}
.su-step-item:not(:last-child)::after{content:'';position:absolute;left:14px;top:42px;width:2px;height:calc(100% - 14px);background:var(--border2)}
.su-step-item.done:not(:last-child)::after{background:var(--accent2)}
.su-step-dot{
  width:28px;height:28px;flex-shrink:0;border-radius:50%;
  border:2px solid var(--border2);background:var(--surface2);
  display:flex;align-items:center;justify-content:center;
  font-size:11px;font-weight:700;color:var(--text3);position:relative;z-index:1;transition:all 0.22s;
}
.su-step-item.active .su-step-dot{border-color:var(--accent);background:rgba(74,222,128,0.1);color:var(--accent);box-shadow:0 0 0 4px rgba(74,222,128,0.07)}
.su-step-item.done   .su-step-dot{border-color:var(--accent2);background:var(--accent2);color:#fff}
.su-step-title{font-size:13px;font-weight:600;color:var(--text3);padding-top:4px;transition:color 0.18s}
.su-step-sub{font-size:11px;color:var(--text3);margin-top:2px;line-height:1.4}
.su-step-item.active .su-step-title{color:var(--text)}
.su-step-item.done   .su-step-title{color:var(--text2)}

.su-sidebar-footer{margin-top:auto;padding:14px;background:var(--surface2);border:1px solid var(--border);border-radius:10px}
.su-sf-label{font-size:10px;font-weight:700;letter-spacing:0.08em;text-transform:uppercase;color:var(--text3);margin-bottom:5px}
.su-sf-val{font-size:12px;font-weight:600;color:var(--text2);font-family:'IBM Plex Mono',monospace}
.su-progress-bar{height:3px;background:var(--border2);border-radius:2px;margin-top:10px;overflow:hidden}
.su-progress-fill{height:100%;background:linear-gradient(90deg,var(--accent2),var(--accent));border-radius:2px;transition:width 0.38s ease}

/* ── SETUP CONTENT ── */
.su-content{flex:1;overflow-y:auto;overflow-x:hidden;padding:44px 56px;scroll-behavior:smooth}
.su-content::-webkit-scrollbar{width:4px}
.su-content::-webkit-scrollbar-thumb{background:var(--border2);border-radius:2px}

/* ── SCREENS ── */
.su-screen{display:none}
.su-screen.active{display:block;animation:suFadeIn 0.24s ease}
@keyframes suFadeIn{from{opacity:0;transform:translateX(14px)}to{opacity:1;transform:translateX(0)}}

/* ── PAGE HEADER ── */
.su-page-header{margin-bottom:44px}
.su-eyebrow{font-size:10px;font-weight:700;letter-spacing:0.12em;text-transform:uppercase;color:var(--accent);margin-bottom:8px;display:flex;align-items:center;gap:8px}
.su-eyebrow::before{content:'';width:18px;height:2px;background:var(--accent);border-radius:1px}
.su-title{font-size:26px;font-weight:800;color:var(--text);letter-spacing:-0.02em;margin-bottom:8px}
.su-desc{font-size:14px;color:var(--text2);line-height:1.6;max-width:540px}

/* ── FORM ── */
.su-section{margin-bottom:38px}
.su-section-label{font-size:10px;font-weight:700;letter-spacing:0.1em;text-transform:uppercase;color:var(--text3);margin-bottom:18px;padding-bottom:10px;border-bottom:1px solid var(--border)}
.su-field-row{display:grid;gap:18px;margin-bottom:18px}
.su-field-row.c2{grid-template-columns:1fr 1fr}
.su-field-row.c1{grid-template-columns:1fr}
.su-field-group{display:flex;flex-direction:column;gap:7px}
.su-label{font-size:12px;font-weight:600;color:var(--text2);display:flex;align-items:center;gap:8px}
.su-req{color:var(--accent);font-size:10px}
.su-hint{font-size:11px;color:var(--text3);line-height:1.5;margin-top:3px}
.su-char-count{font-size:10px;font-family:'IBM Plex Mono',monospace;color:var(--text3);margin-left:auto}
.su-char-count.warn{color:var(--amber)}
.su-char-count.over{color:var(--red)}

.su-input{
  background:var(--surface2);border:1px solid var(--border2);border-radius:9px;
  padding:11px 14px;font-size:13px;font-family:'Outfit',sans-serif;
  color:var(--text);outline:none;transition:all 0.17s;width:100%;
}
.su-input:focus{border-color:var(--accent);box-shadow:0 0 0 3px rgba(74,222,128,0.08)}
.su-input::placeholder{color:var(--text3)}
.su-input:disabled{opacity:0.4;cursor:not-allowed}
textarea.su-input{resize:vertical;min-height:110px;line-height:1.6}

.su-select{
  background:var(--surface2);border:1px solid var(--border2);border-radius:9px;
  padding:11px 14px;font-size:13px;font-family:'Outfit',sans-serif;
  color:var(--text);outline:none;transition:all 0.17s;width:100%;cursor:pointer;
  appearance:none;padding-right:36px;
  background-image:url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' viewBox='0 0 12 12'%3E%3Cpath fill='%234a5270' d='M6 8L1 3h10z'/%3E%3C/svg%3E");
  background-repeat:no-repeat;background-position:right 13px center;
}
.su-select:focus{border-color:var(--accent);box-shadow:0 0 0 3px rgba(74,222,128,0.08)}
.su-select option{background:var(--surface2)}

/* ── TOGGLE PILL ── */
.su-tp{display:inline-flex;background:var(--surface2);border:1px solid var(--border2);border-radius:9px;padding:3px;gap:2px}
.su-tpbtn{padding:8px 18px;border-radius:7px;font-size:12px;font-weight:600;font-family:'Outfit',sans-serif;border:none;cursor:pointer;color:var(--text3);background:transparent;transition:all 0.17s}
.su-tpbtn.active{background:var(--surface3);color:var(--text);box-shadow:0 1px 4px rgba(0,0,0,0.3)}
.su-tpbtn.active.yes{background:rgba(74,222,128,0.12);color:var(--accent)}
.su-tpbtn.active.no{background:rgba(248,113,113,0.1);color:var(--red)}

/* ── SEGMENT ── */
.su-seg{display:inline-flex;flex-wrap:wrap;background:var(--surface2);border:1px solid var(--border2);border-radius:9px;padding:3px;gap:2px}
.su-segbtn{padding:8px 14px;border-radius:7px;font-size:12px;font-weight:600;font-family:'Outfit',sans-serif;border:none;cursor:pointer;color:var(--text3);background:transparent;transition:all 0.17s;white-space:nowrap}
.su-segbtn.active{background:rgba(74,222,128,0.12);color:var(--accent);box-shadow:0 1px 4px rgba(0,0,0,0.25)}

/* ── DATE ROW ── */
.su-date-row{display:flex;align-items:flex-end;gap:12px;flex-wrap:wrap}
.su-date-col{display:flex;flex-direction:column;gap:5px;flex:1;min-width:150px}
.su-date-sublabel{font-size:10px;font-weight:700;letter-spacing:0.07em;text-transform:uppercase;color:var(--text3)}
.su-date-sep{font-size:13px;color:var(--text3);padding-bottom:12px}

/* ── ONGOING ── */
.su-ongoing{display:flex;align-items:center;gap:9px;padding:9px 13px;background:var(--surface2);border:1px solid var(--border2);border-radius:9px;cursor:pointer;user-select:none;transition:all 0.16s;align-self:flex-end;margin-bottom:0}
.su-ongoing:hover{border-color:var(--border3)}
.su-ongoing.active{border-color:var(--accent);background:rgba(74,222,128,0.06)}
.su-ot-sw{width:30px;height:17px;border-radius:9px;background:var(--surface3);position:relative;transition:background 0.2s;flex-shrink:0}
.su-ongoing.active .su-ot-sw{background:var(--accent2)}
.su-ot-sw::after{content:'';position:absolute;top:2.5px;left:2.5px;width:12px;height:12px;border-radius:50%;background:#fff;transition:left 0.2s}
.su-ongoing.active .su-ot-sw::after{left:15.5px}
.su-ot-lbl{font-size:12px;font-weight:600;color:var(--text2)}
.su-ongoing.active .su-ot-lbl{color:var(--accent)}

/* ── RULE CARD ── */
.su-rule-card{background:var(--surface);border:1px solid var(--border);border-radius:12px;padding:22px;margin-bottom:14px}
.su-rule-header{display:flex;align-items:center;justify-content:space-between;gap:16px;flex-wrap:wrap;gap:12px}
.su-rule-title{font-size:14px;font-weight:700;color:var(--text);display:flex;align-items:center;gap:9px}
.su-rule-icon{width:30px;height:30px;border-radius:8px;display:flex;align-items:center;justify-content:center;font-size:14px}
.su-rule-desc{font-size:11px;color:var(--text3);margin-top:3px;line-height:1.5}
.su-rule-body{margin-top:18px;padding-top:18px;border-top:1px solid var(--border);display:none}
.su-rule-body.open{display:block;animation:suFadeIn 0.18s ease}

/* ── NUM INPUT ── */
.su-num-wrap{display:flex;align-items:center;background:var(--surface2);border:1px solid var(--border2);border-radius:9px;overflow:hidden;transition:border-color 0.17s}
.su-num-wrap:focus-within{border-color:var(--accent);box-shadow:0 0 0 3px rgba(74,222,128,0.08)}
.su-num-wrap input{background:transparent;border:none;outline:none;padding:11px 13px;font-size:13px;font-family:'Outfit',sans-serif;color:var(--text);width:100%}
.su-num-wrap input::placeholder{color:var(--text3)}
.su-num-suffix{padding:0 13px;font-size:12px;font-weight:600;color:var(--text3);border-left:1px solid var(--border);background:var(--surface3);min-height:42px;display:flex;align-items:center;white-space:nowrap}

/* ── DAY PICKER ── */
.su-day-picker{display:flex;gap:5px;flex-wrap:wrap}
.su-daybtn{width:42px;height:42px;border-radius:9px;font-size:11px;font-weight:700;border:1px solid var(--border2);background:var(--surface2);color:var(--text3);cursor:pointer;transition:all 0.14s;font-family:'Outfit',sans-serif}
.su-daybtn:hover{border-color:var(--border3);color:var(--text2)}
.su-daybtn.active{border-color:var(--accent);background:rgba(74,222,128,0.1);color:var(--accent)}

.su-presets{display:flex;gap:7px;flex-wrap:wrap;margin-top:10px}
.su-presetbtn{padding:6px 13px;border-radius:7px;font-size:11px;font-weight:600;border:1px solid var(--border2);background:var(--surface2);color:var(--text3);cursor:pointer;transition:all 0.14s;font-family:'Outfit',sans-serif}
.su-presetbtn:hover{border-color:var(--border3);color:var(--text2)}
.su-presetbtn.active{border-color:var(--blue);background:rgba(96,165,250,0.08);color:var(--blue)}

/* ── NOTICE ── */
.su-notice{display:flex;gap:9px;padding:11px 13px;border-radius:9px;background:rgba(245,158,11,0.07);border:1px solid rgba(245,158,11,0.18);font-size:12px;color:#fbbf24;line-height:1.5;margin-top:10px}
.su-notice.green{background:rgba(74,222,128,0.06);border-color:rgba(74,222,128,0.15);color:var(--accent)}

/* ── FORM FOOTER ── */
.su-form-footer{display:flex;align-items:center;justify-content:space-between;margin-top:48px;padding-top:26px;border-top:1px solid var(--border)}
.su-footer-note{font-size:12px;color:var(--text3)}

/* ── DATE INPUT ── */
input[type=date].su-input::-webkit-calendar-picker-indicator{filter:invert(0.4) sepia(1) hue-rotate(180deg);cursor:pointer;opacity:0.6}
</style>

<!-- ══ CANVAS CSS ══ -->
<style>
*,*::before,*::after{box-sizing:border-box;margin:0;padding:0}
:root{
  --bg:#0e1017;--surface:#161921;--surface2:#1c2030;--surface3:#222638;
  --border:#252a3a;--border2:#2e3448;
  --text:#e2e6f0;--text2:#8892aa;--text3:#4a5270;
  --accent:#4ade80;--accent2:#22c55e;

  /* Grid constants */
  --col-w:170px;   /* horizontal step between columns */
  --row-h:190px;   /* vertical step between branch rows — generous spacing */
  --node-w:96px;   /* node card width */
  --node-h:96px;   /* node card height */
}
html,body{height:100%;overflow:hidden;font-family:'Outfit',sans-serif;background:var(--bg);color:var(--text)}

/* ── LAYOUT: canvas takes maximum space ── */
.app{display:grid;grid-template-rows:44px 1fr 32px;grid-template-columns:260px 1fr;height:100vh}

/* ── TOPBAR ── */
.topbar{
  grid-column:1/-1;grid-row:1;
  background:var(--surface);border-bottom:1px solid var(--border);
  display:flex;align-items:center;padding:0 14px;gap:0;z-index:200;
}
.logo{display:flex;align-items:center;gap:7px;margin-right:18px;flex-shrink:0}
.logo-mark{width:26px;height:26px;border-radius:7px;background:linear-gradient(135deg,#22c55e,#16a34a);display:flex;align-items:center;justify-content:center;font-size:13px;font-weight:700;color:#fff;box-shadow:0 0 10px rgba(34,197,94,0.3)}
.logo-text{font-size:13px;font-weight:600;color:var(--text)}
.vsep{width:1px;height:24px;background:var(--border);margin:0 12px}
.campaign-name{font-size:13px;font-weight:500;color:var(--text);background:transparent;border:none;outline:none;border-bottom:1px solid transparent;padding:2px 4px;transition:border-color 0.2s;min-width:200px}
.campaign-name:focus{border-bottom-color:var(--accent)}
.topbar-status{display:flex;align-items:center;gap:5px;font-size:10px;font-family:'IBM Plex Mono',monospace;color:var(--text3);margin-left:8px}
.status-dot{width:6px;height:6px;border-radius:50%;background:#f59e0b;animation:pulse 2s infinite}
@keyframes pulse{0%,100%{opacity:1}50%{opacity:0.4}}
.topbar-actions{margin-left:auto;display:flex;align-items:center;gap:6px}
.btn{display:flex;align-items:center;gap:5px;padding:5px 11px;border-radius:6px;font-size:11px;font-weight:500;font-family:'Outfit',sans-serif;cursor:pointer;border:1px solid transparent;transition:all 0.15s;white-space:nowrap}
.btn-ghost{background:transparent;border-color:var(--border2);color:var(--text2)}
.btn-ghost:hover{background:var(--surface2);color:var(--text)}
.btn-primary{background:var(--accent2);border-color:var(--accent2);color:#fff;font-weight:600;box-shadow:0 0 14px rgba(34,197,94,0.2)}
.btn-primary:hover{background:#16a34a}
.btn-danger{background:transparent;border-color:var(--border2);color:#f87171}
.btn-danger:hover{background:rgba(239,68,68,0.08);border-color:#ef4444}
.icon-btn{width:30px;height:30px;border-radius:6px;background:transparent;border:1px solid var(--border2);color:var(--text2);cursor:pointer;display:flex;align-items:center;justify-content:center;font-size:13px;transition:all 0.15s}
.icon-btn:hover{background:var(--surface2);color:var(--text)}

/* ── LEFT PANEL ── */
.left-panel{grid-column:1;grid-row:2;background:var(--surface);border-right:1px solid var(--border);overflow-y:auto;overflow-x:hidden;display:flex;flex-direction:column}
.left-panel::-webkit-scrollbar{width:3px}
.left-panel::-webkit-scrollbar-thumb{background:var(--border2);border-radius:2px}
.panel-search{padding:10px 10px 6px}
.search-box{display:flex;align-items:center;gap:7px;background:var(--surface2);border:1px solid var(--border);border-radius:7px;padding:6px 9px}
.search-box input{background:transparent;border:none;outline:none;font-size:11px;color:var(--text);width:100%;font-family:'Outfit',sans-serif}
.search-box input::placeholder{color:var(--text3)}
.palette-section{padding:0 6px 4px}
.section-toggle{display:flex;align-items:center;gap:5px;padding:10px 6px 6px;cursor:pointer;font-size:11px;font-weight:700;letter-spacing:0.07em;text-transform:uppercase;color:var(--text3);user-select:none;transition:color 0.15s}
.section-toggle:hover{color:var(--text2)}
.section-arrow{font-size:9px;transition:transform 0.2s}
.section-arrow.open{transform:rotate(90deg)}
.node-item{display:flex;align-items:center;gap:12px;padding:11px 12px;border-radius:9px;margin-bottom:4px;cursor:grab;border:1px solid transparent;transition:all 0.15s;user-select:none}
.node-item:hover{background:var(--surface2);border-color:var(--border)}
.node-item:active{cursor:grabbing}
.ni-icon{width:42px;height:42px;border-radius:10px;display:flex;align-items:center;justify-content:center;font-size:20px;flex-shrink:0}
.ni-label{font-size:13px;font-weight:600;color:var(--text2);line-height:1.35}
.node-item:hover .ni-label{color:var(--text)}
.section-items.collapsed{display:none}

/* ── CANVAS AREA ── */
.canvas-wrap{
  grid-column:2;grid-row:2;
  position:relative;overflow:hidden;
  background:var(--bg);
  background-image:radial-gradient(circle at 1px 1px,rgba(255,255,255,0.035) 1px,transparent 0);
  background-size:24px 24px;
  cursor:default;
}
.canvas-viewport{position:absolute;inset:0;transform-origin:0 0}
.connections-svg{position:absolute;inset:0;width:100%;height:100%;pointer-events:none;overflow:visible}

/* ── NODE CARDS ── */
.canvas-node{position:absolute;display:flex;flex-direction:column;align-items:center;cursor:pointer;user-select:none;z-index:10}
.node-card{
  width:150px;
  border-radius:16px;border:2px solid rgba(255,255,255,0.06);
  display:flex;flex-direction:column;align-items:center;
  padding:18px 12px 14px;transition:all 0.18s;position:relative;
  box-shadow:0 4px 18px rgba(0,0,0,0.4);
}
.node-card:hover{border-color:rgba(255,255,255,0.16);transform:translateY(-2px);box-shadow:0 8px 28px rgba(0,0,0,0.5)}
.node-card.selected{border-color:rgba(255,255,255,0.5)!important;box-shadow:0 0 0 3px rgba(255,255,255,0.07),0 8px 28px rgba(0,0,0,0.5)}
/* Highlight when a connection wire is dragged over this node */
.canvas-node.connect-hover .node-card{
  border-color:var(--accent)!important;
  box-shadow:0 0 0 3px rgba(74,222,128,0.2), 0 8px 28px rgba(0,0,0,0.5)!important;
}
.node-card-icon{width:112px;height:112px;border-radius:22px;display:flex;align-items:center;justify-content:center;font-size:56px;margin-bottom:10px}
.node-card-label{font-size:13px;font-weight:700;text-align:center;line-height:1.35;color:rgba(255,255,255,0.95);max-width:110px;letter-spacing:0.01em}

/* Heat badge */
.heat-badge{position:absolute;top:-7px;right:-7px;background:var(--accent2);color:#fff;font-size:8px;font-weight:700;font-family:'IBM Plex Mono',monospace;padding:2px 5px;border-radius:9px;box-shadow:0 0 7px rgba(34,197,94,0.45);white-space:nowrap;z-index:20}

/* Node actions */
.node-actions{display:none;gap:3px;margin-top:5px}
.canvas-node:hover .node-actions{display:flex}
.na-btn{width:20px;height:20px;border-radius:4px;background:var(--surface2);border:1px solid var(--border2);color:var(--text3);font-size:9px;cursor:pointer;display:flex;align-items:center;justify-content:center;transition:all 0.15s}
.na-btn:hover{color:var(--text);background:var(--surface3)}
.na-btn.del:hover{color:#f87171;border-color:#ef4444;background:rgba(239,68,68,0.1)}

/* Output port — click to start connection */
.out-port{
  position:absolute;right:-10px;top:50%;transform:translateY(-50%);
  width:12px;height:12px;border-radius:50%;
  border:2px solid rgba(255,255,255,0.25);background:var(--surface2);
  cursor:crosshair;transition:all 0.15s;z-index:20;
  display:none;
}
.canvas-node:hover .out-port{display:block}
.out-port:hover{border-color:var(--accent);background:var(--accent);transform:translateY(-50%) scale(1.3)}
.out-port.connecting{display:block;border-color:var(--accent);background:var(--accent);animation:portPulse 0.8s infinite}
@keyframes portPulse{0%,100%{box-shadow:0 0 0 0 rgba(74,222,128,0.5)}50%{box-shadow:0 0 0 5px rgba(74,222,128,0)}}

/* Input port */
.in-port{
  position:absolute;left:-10px;top:50%;transform:translateY(-50%);
  width:12px;height:12px;border-radius:50%;
  border:2px solid rgba(255,255,255,0.1);background:var(--surface2);
  z-index:20;display:none;cursor:crosshair;transition:all 0.15s;
}
.canvas-node:hover .in-port{display:block}
.in-port.accepting{display:block;border-color:var(--accent)!important;background:rgba(74,222,128,0.2);animation:portPulse 0.6s infinite}

/* Placeholder node — base (fresh slot after fork) */
.placeholder-node{
  position:absolute;width:var(--node-w);height:var(--node-h);
  border-radius:13px;border:2px dashed rgba(255,255,255,0.1);
  display:flex;flex-direction:column;align-items:center;justify-content:center;
  gap:4px;cursor:pointer;transition:all 0.22s;z-index:5;
  background:transparent;
}
.placeholder-node:hover{
  border-color:var(--accent);
  background:rgba(74,222,128,0.04);
  box-shadow:0 0 0 1px rgba(74,222,128,0.12), 0 0 18px rgba(74,222,128,0.08);
}
.ph-plus{font-size:20px;color:var(--text3);transition:color 0.2s;line-height:1}
.ph-label{font-size:9px;color:var(--text3);font-family:'IBM Plex Mono',monospace;letter-spacing:0.05em;transition:color 0.2s;text-align:center;padding:0 4px}
.placeholder-node:hover .ph-plus,.placeholder-node:hover .ph-label{color:var(--accent)}

/* Ghost placeholder — left behind after deleting a node. More visible border, node-shaped */
.placeholder-node.ghost{
  border:2px dashed rgba(255,255,255,0.22);
  background:rgba(255,255,255,0.02);
}
.placeholder-node.ghost:hover{
  border-color:var(--accent);
  background:rgba(74,222,128,0.05);
}
/* Drag-over highlight — when dragging a palette node over a placeholder */
.placeholder-node.drag-over{
  border-color:var(--accent)!important;
  background:rgba(74,222,128,0.09)!important;
  box-shadow:0 0 0 2px rgba(74,222,128,0.25), 0 0 24px rgba(74,222,128,0.15)!important;
  transform:scale(1.04);
}

/* Drag ghost — the floating preview node following the cursor */
#dragGhost{
  position:fixed;pointer-events:none;z-index:1000;
  width:88px;display:flex;flex-direction:column;align-items:center;
  opacity:0.88;transform:translate(-50%,-50%);
  transition:none;display:none;
}
#dragGhost .dg-card{
  width:88px;border-radius:13px;border:2px solid rgba(255,255,255,0.18);
  display:flex;flex-direction:column;align-items:center;
  padding:13px 7px 9px;box-shadow:0 8px 32px rgba(0,0,0,0.6);
}
#dragGhost .dg-icon{width:34px;height:34px;border-radius:9px;display:flex;align-items:center;justify-content:center;font-size:17px;margin-bottom:7px}
#dragGhost .dg-label{font-size:9px;font-weight:600;text-align:center;color:rgba(255,255,255,0.9);max-width:72px;line-height:1.3}

/* ── TRIGGER GATE ── */
.trigger-gate{position:absolute;inset:0;display:flex;align-items:center;justify-content:center;background:rgba(14,16,23,0.88);backdrop-filter:blur(4px);z-index:150;transition:opacity 0.3s}
.trigger-card{background:var(--surface);border:1px solid var(--border2);border-radius:16px;padding:32px 40px;text-align:center;max-width:340px;box-shadow:0 20px 60px rgba(0,0,0,0.6)}
.trigger-card h2{font-size:16px;font-weight:600;color:var(--text);margin-bottom:6px}
.trigger-card p{font-size:11px;color:var(--text3);margin-bottom:26px;line-height:1.6}
.trigger-options{display:flex;gap:14px;justify-content:center}
.trigger-opt{display:flex;flex-direction:column;align-items:center;gap:9px;padding:18px 22px;border-radius:11px;border:2px solid var(--border2);background:var(--surface2);cursor:pointer;transition:all 0.2s;min-width:105px}
.trigger-opt:hover{transform:translateY(-3px);box-shadow:0 8px 22px rgba(0,0,0,0.4)}
.trigger-opt.realtime:hover{border-color:#22c55e;box-shadow:0 8px 22px rgba(34,197,94,0.18)}
.trigger-opt.schedule:hover{border-color:#3b82f6;box-shadow:0 8px 22px rgba(59,130,246,0.18)}
.trigger-opt-icon{width:48px;height:48px;border-radius:13px;display:flex;align-items:center;justify-content:center;font-size:22px}
.trigger-opt-label{font-size:12px;font-weight:600;color:var(--text)}
.trigger-opt-sub{font-size:9px;color:var(--text3)}

/* ── RIGHT PANEL (overlay, not grid column) ── */
.right-panel{
  position:fixed;top:44px;right:0;bottom:32px;
  width:268px;
  background:var(--surface);
  border-left:1px solid var(--border);
  display:flex;flex-direction:column;
  z-index:150;
  transform:translateX(100%);
  transition:transform 0.22s cubic-bezier(0.4,0,0.2,1);
  box-shadow:-8px 0 32px rgba(0,0,0,0.4);
}
.right-panel.open{transform:translateX(0)}
.rpanel-header{padding:13px 14px 10px;border-bottom:1px solid var(--border);display:flex;align-items:flex-start;justify-content:space-between;flex-shrink:0}
.rpanel-title{font-size:12px;font-weight:600;color:var(--text)}
.rpanel-subtitle{font-size:10px;color:var(--text3);margin-top:2px}
.rpanel-close{width:22px;height:22px;border-radius:4px;background:transparent;border:1px solid var(--border2);color:var(--text3);font-size:11px;cursor:pointer;display:flex;align-items:center;justify-content:center;transition:all 0.15s;flex-shrink:0;margin-top:1px}
.rpanel-close:hover{color:var(--text);background:var(--surface2)}
.rpanel-body{flex:1;overflow-y:auto;padding:14px}
.rpanel-body::-webkit-scrollbar{width:3px}
.rpanel-body::-webkit-scrollbar-thumb{background:var(--border2);border-radius:2px}
.field-group{margin-bottom:16px}
.field-label{font-size:9px;font-weight:600;letter-spacing:0.1em;text-transform:uppercase;color:var(--text3);margin-bottom:5px;display:block}
.field-input{width:100%;background:var(--surface2);border:1px solid var(--border2);border-radius:7px;padding:7px 10px;font-size:11px;color:var(--text);font-family:'Outfit',sans-serif;outline:none;transition:border-color 0.15s}
.field-input:focus{border-color:var(--accent)}
.field-input::placeholder{color:var(--text3)}
.field-textarea{resize:none;min-height:56px;line-height:1.5}
.field-select{width:100%;background:var(--surface2);border:1px solid var(--border2);border-radius:7px;padding:7px 10px;font-size:11px;color:var(--text);font-family:'Outfit',sans-serif;outline:none;cursor:pointer;appearance:none;background-image:url("data:image/svg+xml,%3Csvg width='10' height='6' viewBox='0 0 10 6' fill='none' xmlns='http://www.w3.org/2000/svg'%3E%3Cpath d='M1 1l4 4 4-4' stroke='%234a5270' stroke-width='1.5' stroke-linecap='round' stroke-linejoin='round'/%3E%3C/svg%3E");background-repeat:no-repeat;background-position:right 9px center}
.field-select:focus{border-color:var(--accent)}
.divider{height:1px;background:var(--border);margin:14px 0}

/* Event checkboxes */
.event-list{display:flex;flex-direction:column;gap:3px}
.event-check{display:flex;align-items:center;gap:8px;padding:7px 9px;border-radius:6px;cursor:pointer;transition:background 0.15s;border:1px solid transparent}
.event-check:hover{background:var(--surface2)}
.event-check.checked{background:rgba(34,197,94,0.06);border-color:rgba(34,197,94,0.18)}
.event-check input{accent-color:var(--accent);width:13px;height:13px;cursor:pointer}
.event-check-label{font-size:11px;color:var(--text2)}
.event-check.checked .event-check-label{color:var(--accent)}
.event-summary{margin-top:7px;padding:7px 9px;background:rgba(34,197,94,0.05);border:1px solid rgba(34,197,94,0.13);border-radius:7px;display:none}
.es-title{font-size:9px;color:var(--accent);font-weight:600;text-transform:uppercase;letter-spacing:0.08em;margin-bottom:4px}
.es-tags{display:flex;flex-wrap:wrap;gap:3px}
.es-tag{font-size:9px;padding:2px 7px;border-radius:4px;background:rgba(34,197,94,0.13);color:var(--accent);font-family:'IBM Plex Mono',monospace}

/* Condition builder */
.cond-row{background:var(--surface2);border:1px solid var(--border);border-radius:7px;padding:9px;margin-bottom:6px}
.cond-fields{display:flex;gap:5px;margin-bottom:5px;flex-wrap:wrap}
.cond-sel{flex:1;min-width:0;background:var(--surface3);border:1px solid var(--border2);border-radius:5px;padding:5px 7px;font-size:10px;color:var(--text);font-family:'Outfit',sans-serif;outline:none;appearance:none;cursor:pointer;min-width:60px}
.cond-footer{display:flex;justify-content:space-between;align-items:center}
.logic-tag{font-size:9px;font-weight:700;font-family:'IBM Plex Mono',monospace;padding:2px 7px;border-radius:4px;background:rgba(249,115,22,0.12);color:#fb923c;border:1px solid rgba(249,115,22,0.2);cursor:pointer}
.logic-tag:hover{background:rgba(249,115,22,0.22)}
.cond-remove{background:transparent;border:none;color:var(--text3);cursor:pointer;font-size:10px;transition:color 0.15s}
.cond-remove:hover{color:#f87171}
.add-cond-btn{display:flex;align-items:center;justify-content:center;gap:5px;padding:6px;border-radius:6px;background:transparent;border:1px dashed var(--border2);color:var(--text3);font-size:10px;cursor:pointer;width:100%;transition:all 0.15s;font-family:'Outfit',sans-serif}
.add-cond-btn:hover{border-color:var(--accent);color:var(--accent);background:rgba(74,222,128,0.04)}

/* Sub-fields for smart conditions */
.sub-field{margin-top:5px;padding-top:5px;border-top:1px solid var(--border)}

.rpanel-footer{padding:10px 14px;border-top:1px solid var(--border);flex-shrink:0}
.save-btn{width:100%;padding:9px;border-radius:8px;background:var(--accent2);border:none;font-size:12px;font-weight:600;color:#fff;cursor:pointer;font-family:'Outfit',sans-serif;box-shadow:0 0 14px rgba(34,197,94,0.2);transition:all 0.18s}
.save-btn:hover{background:#16a34a;box-shadow:0 0 22px rgba(34,197,94,0.35)}

/* ── CONTEXT MENU (placeholder click) ── */
.ctx-menu{
  position:fixed;z-index:500;
  background:var(--surface);border:1px solid var(--border2);
  border-radius:10px;padding:6px;
  box-shadow:0 8px 32px rgba(0,0,0,0.6);
  min-width:180px;display:none;
  animation:ctxIn 0.12s ease;
}
@keyframes ctxIn{from{opacity:0;transform:scale(0.95)}to{opacity:1;transform:scale(1)}}
.ctx-section{font-size:9px;color:var(--text3);font-weight:600;letter-spacing:0.1em;text-transform:uppercase;padding:4px 8px 3px;margin-top:3px}
.ctx-section:first-child{margin-top:0}
.ctx-item{display:flex;align-items:center;gap:8px;padding:7px 9px;border-radius:6px;cursor:pointer;transition:background 0.12s}
.ctx-item:hover{background:var(--surface2)}
.ctx-item-icon{width:24px;height:24px;border-radius:6px;display:flex;align-items:center;justify-content:center;font-size:12px;flex-shrink:0}
.ctx-item-label{font-size:11px;font-weight:500;color:var(--text2)}
.ctx-item:hover .ctx-item-label{color:var(--text)}

/* ── VALIDATION TOAST ── */
.val-toast{
  position:fixed;top:54px;left:50%;transform:translateX(-50%);
  background:var(--surface2);border:1px solid var(--border2);
  border-radius:8px;padding:0;min-width:300px;max-width:460px;
  box-shadow:0 8px 32px rgba(0,0,0,0.6);z-index:600;display:none;
  animation:toastIn 0.18s ease;
}
@keyframes toastIn{from{opacity:0;transform:translateX(-50%) translateY(-8px)}to{opacity:1;transform:translateX(-50%) translateY(0)}}
.val-toast-header{display:flex;align-items:center;gap:8px;padding:10px 14px;border-bottom:1px solid var(--border)}
.val-toast-title{font-size:12px;font-weight:600;color:var(--text);flex:1}
.val-toast-close{background:transparent;border:none;color:var(--text3);cursor:pointer;font-size:13px;line-height:1}
.val-toast-body{padding:10px 14px;display:flex;flex-direction:column;gap:5px}
.val-item{display:flex;align-items:center;gap:7px;font-size:11px;color:var(--text2)}
.val-item.error .val-dot{background:#f87171}
.val-item.warn .val-dot{background:#f59e0b}
.val-item.ok .val-dot{background:#4ade80}
.val-dot{width:6px;height:6px;border-radius:50%;flex-shrink:0}

/* ── CONNECTING LINE (live drag) ── */
#connectingSvg{position:fixed;inset:0;pointer-events:none;z-index:400;display:none}

/* ── ZOOM + MINIMAP ── */
.zoom-controls{position:absolute;right:14px;bottom:14px;display:flex;flex-direction:column;gap:3px;z-index:20}
.zoom-btn{width:28px;height:28px;border-radius:7px;background:var(--surface);border:1px solid var(--border2);color:var(--text2);font-size:13px;cursor:pointer;display:flex;align-items:center;justify-content:center;transition:all 0.15s}
.zoom-btn:hover{background:var(--surface2);color:var(--text)}
.zoom-level{background:var(--surface);border:1px solid var(--border2);border-radius:5px;padding:3px 5px;font-size:9px;font-family:'IBM Plex Mono',monospace;color:var(--text3);text-align:center}

.minimap{position:absolute;right:14px;top:14px;width:130px;height:82px;background:var(--surface);border:1px solid var(--border2);border-radius:9px;overflow:hidden;z-index:20}
.minimap-label{position:absolute;bottom:4px;left:7px;font-size:8px;font-family:'IBM Plex Mono',monospace;color:var(--text3);letter-spacing:0.06em;text-transform:uppercase}
.minimap-inner{width:100%;height:100%;position:relative;padding:7px}
.mm-node{position:absolute;border-radius:2px;width:8px;height:8px;transition:all 0.3s}
.mm-viewport{position:absolute;border:1px solid rgba(74,222,128,0.4);background:rgba(74,222,128,0.04);border-radius:2px;top:12%;left:6%;width:55%;height:55%;pointer-events:none}

/* ── BOTTOM BAR ── */
.bottom-bar{grid-column:1/-1;grid-row:3;background:var(--surface);border-top:1px solid var(--border);display:flex;align-items:center;padding:0 14px;z-index:100}
.bbar-seg{display:flex;align-items:center;gap:10px;padding:0 12px;border-right:1px solid var(--border)}
.bbar-seg:first-child{padding-left:0}
.bbar-seg:last-child{border-right:none;margin-left:auto;padding-right:0}
.bbar-stat{display:flex;align-items:center;gap:5px}
.bbar-dot{width:5px;height:5px;border-radius:50%}
.bbar-lbl{font-size:9px;font-family:'IBM Plex Mono',monospace;color:var(--text3)}
.bbar-val{font-size:10px;font-family:'IBM Plex Mono',monospace;color:var(--text);font-weight:500}
.hm-toggle{display:flex;align-items:center;gap:6px;font-size:9px;font-family:'IBM Plex Mono',monospace;color:var(--text3);cursor:pointer}
.toggle-sw{width:26px;height:14px;border-radius:7px;background:var(--accent2);position:relative;transition:background 0.2s}
.toggle-sw::after{content:'';position:absolute;top:2px;right:2px;width:10px;height:10px;border-radius:50%;background:#fff;transition:right 0.2s,left 0.2s}
.toggle-sw.off{background:var(--surface3)}
.toggle-sw.off::after{right:auto;left:2px}

/* ── ALERT ── */
.alert-bar{position:fixed;bottom:44px;left:50%;transform:translateX(-50%);background:var(--surface2);border:1px solid var(--border2);border-left:2px solid var(--accent);border-radius:7px;padding:7px 14px;font-size:11px;font-family:'IBM Plex Mono',monospace;color:var(--text);box-shadow:0 4px 18px rgba(0,0,0,0.5);z-index:700;display:none;white-space:nowrap}

/* ── CONFIRM DIALOG ── */
.confirm-overlay{position:fixed;inset:0;background:rgba(0,0,0,0.65);backdrop-filter:blur(4px);z-index:900;display:none;align-items:center;justify-content:center}
.confirm-overlay.open{display:flex}
.confirm-card{background:var(--surface);border:1px solid var(--border2);border-radius:14px;padding:28px 32px;max-width:380px;width:90%;box-shadow:0 24px 60px rgba(0,0,0,0.7);animation:ctxIn 0.15s ease}
.confirm-icon{font-size:28px;margin-bottom:12px}
.confirm-title{font-size:15px;font-weight:700;color:var(--text);margin-bottom:8px}
.confirm-body{font-size:12px;color:var(--text2);line-height:1.6;margin-bottom:24px}
.confirm-actions{display:flex;gap:10px;justify-content:flex-end}
.confirm-cancel{padding:8px 18px;border-radius:7px;background:transparent;border:1px solid var(--border2);color:var(--text2);font-size:12px;font-family:'Outfit',sans-serif;cursor:pointer;transition:all 0.15s}
.confirm-cancel:hover{background:var(--surface2);color:var(--text)}
.confirm-delete{padding:8px 18px;border-radius:7px;background:#dc2626;border:none;color:#fff;font-size:12px;font-weight:600;font-family:'Outfit',sans-serif;cursor:pointer;transition:all 0.15s}
.confirm-delete:hover{background:#b91c1c}

/* Node color classes */
.nc-trigger{background:linear-gradient(135deg,#15803d,#166534)!important;border-color:rgba(34,197,94,0.25)!important}
.nc-schedule{background:linear-gradient(135deg,#1d4ed8,#1e40af)!important;border-color:rgba(59,130,246,0.25)!important}
.nc-flow{background:linear-gradient(135deg,#ea580c,#c2410c)!important;border-color:rgba(249,115,22,0.25)!important}
.nc-split{background:linear-gradient(135deg,#d97706,#b45309)!important;border-color:rgba(245,158,11,0.25)!important}
.nc-activity{background:linear-gradient(135deg,#9333ea,#7e22ce)!important;border-color:rgba(168,85,247,0.25)!important}
.nc-comms{background:linear-gradient(135deg,#7c3aed,#6d28d9)!important;border-color:rgba(139,92,246,0.25)!important}
.nc-data{background:linear-gradient(135deg,#0e7490,#0c4a6e)!important;border-color:rgba(6,182,212,0.25)!important}
.nc-wait{background:linear-gradient(135deg,#0369a1,#0c4a6e)!important;border-color:rgba(56,189,248,0.25)!important}
.nc-end{background:linear-gradient(135deg,#dc2626,#991b1b)!important;border-color:rgba(239,68,68,0.25)!important}
.nc-pull{background:linear-gradient(135deg,#0f766e,#065f46)!important;border-color:rgba(20,184,166,0.25)!important}
.nc-cond{background:linear-gradient(135deg,#6d28d9,#5b21b6)!important;border-color:rgba(139,92,246,0.25)!important}
</style>

<!-- ══ FEATURE INDEX CSS ══ -->
<style>
@import url('https://fonts.googleapis.com/css2?family=DM+Mono:wght@400;500&family=Syne:wght@400;600;700;800&display=swap');

  @import url('https://fonts.googleapis.com/css2?family=DM+Mono:wght@400;500&family=Syne:wght@400;600;700;800&display=swap');
  *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

  :root {
    --bg: #0d0f14;
    --surface: #13161e;
    --surface2: #181b25;
    --border: #1e2330;
    --text: #e8eaf0;
    --muted: #4a5068;
    --accent: #c8f135;
    --c-canvas: #c8f135;
    --c-node: #38bdf8;
    --c-flow: #a78bfa;
    --c-activity: #f472b6;
    --c-comms: #fb923c;
    --c-data: #34d399;
    --c-condition: #facc15;
    --c-monitor: #f87171;
    --c-trigger: #818cf8;
    --c-setup: #22d3ee;
    --c-support: #f59e0b;
  }

  body {
    background: var(--bg);
    color: var(--text);
    font-family: 'Syne', sans-serif;
    min-height: 100vh;
    padding: 40px 32px 80px;
  }

  header {
    margin-bottom: 40px;
    display: flex;
    align-items: flex-end;
    justify-content: space-between;
    flex-wrap: wrap;
    gap: 16px;
  }

  .label {
    font-family: 'DM Mono', monospace;
    font-size: 11px;
    letter-spacing: 0.15em;
    color: var(--muted);
    text-transform: uppercase;
    margin-bottom: 8px;
  }

  h1 { font-size: 32px; font-weight: 800; letter-spacing: -0.02em; }
  h1 span { color: var(--accent); }

  .legend {
    display: flex;
    flex-wrap: wrap;
    gap: 10px;
    align-items: center;
  }

  .leg {
    display: flex;
    align-items: center;
    gap: 6px;
    font-family: 'DM Mono', monospace;
    font-size: 10px;
    color: var(--muted);
  }

  .leg-dot { width: 8px; height: 8px; border-radius: 50%; }

  .stats {
    display: flex;
    gap: 14px;
    margin-bottom: 32px;
    flex-wrap: wrap;
  }

  .stat-card {
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: 10px;
    padding: 14px 20px;
    flex: 1;
    min-width: 110px;
  }

  .stat-num { font-size: 28px; font-weight: 800; color: var(--text); }
  .stat-num.accent { color: var(--accent); }
  .stat-num.cyan { color: var(--c-setup); }
  .stat-num.amber { color: var(--c-support); }

  .stat-label {
    font-family: 'DM Mono', monospace;
    font-size: 10px;
    color: var(--muted);
    letter-spacing: 0.1em;
    text-transform: uppercase;
    margin-top: 4px;
  }

  .section { margin-bottom: 36px; }

  .section-header {
    display: flex;
    align-items: center;
    gap: 10px;
    margin-bottom: 12px;
    padding-bottom: 10px;
    border-bottom: 1px solid var(--border);
  }

  .section-color { width: 3px; height: 20px; border-radius: 2px; flex-shrink:0; }
  .section-title { font-size: 12px; font-weight: 700; letter-spacing: 0.1em; text-transform: uppercase; }
  .section-zone { font-family: 'DM Mono', monospace; font-size: 10px; color: var(--muted); margin-left: auto; }
  .section-count { font-family: 'DM Mono', monospace; font-size: 10px; background: var(--surface2); border: 1px solid var(--border); border-radius: 20px; padding: 2px 10px; color: var(--muted); }

  table { width: 100%; border-collapse: collapse; font-size: 13px; }
  thead tr { background: var(--surface2); }
  th {
    font-family: 'DM Mono', monospace; font-size: 10px; letter-spacing: 0.1em;
    text-transform: uppercase; color: var(--muted); text-align: left;
    padding: 10px 14px; border-bottom: 1px solid var(--border); font-weight: 500;
  }
  td { padding: 11px 14px; vertical-align: top; border-bottom: 1px solid rgba(30,35,48,0.7); }
  tr:hover td { background: rgba(255,255,255,0.015); }

  .feat-id { font-family: 'DM Mono', monospace; font-size: 10px; color: var(--muted); white-space: nowrap; }
  .feat-name { font-weight: 700; color: var(--text); white-space: nowrap; }
  .feat-desc { color: #8b92ae; font-size: 12px; line-height: 1.55; }
  .feat-ux { color: #636b8a; font-size: 11px; font-style: italic; line-height: 1.5; }

  .badge {
    display: inline-block; font-family: 'DM Mono', monospace; font-size: 9px;
    padding: 2px 8px; border-radius: 4px; letter-spacing: 0.06em; white-space: nowrap;
  }

  .b-mvp    { background: rgba(200,241,53,0.1);  color: var(--accent);   border: 1px solid rgba(200,241,53,0.25); }
  .b-built  { background: rgba(34,211,238,0.1);  color: var(--c-setup);  border: 1px solid rgba(34,211,238,0.25); }
  .b-phase2 { background: rgba(74,80,104,0.3);   color: var(--muted);    border: 1px solid var(--border); }
  .b-infra  { background: rgba(245,158,11,0.1);  color: var(--c-support);border: 1px solid rgba(245,158,11,0.25); }
  .b-ext    { background: rgba(167,139,250,0.1); color: #a78bfa;         border: 1px solid rgba(167,139,250,0.25); }

  .sub-items { margin-top: 4px; padding-left: 0; list-style: none; }
  .sub-items li { font-size: 11px; color: #636b8a; padding: 1px 0; }
  .sub-items li::before { content: '→ '; color: var(--muted); }

  /* support section rows get amber left border */
  .support-row td { border-left: 2px solid var(--c-support); }

  .divider {
    margin: 48px 0 36px;
    display: flex; align-items: center; gap: 14px;
  }
  .divider-line { flex:1; height:1px; background: var(--border); }
  .divider-label {
    font-family: 'DM Mono', monospace; font-size: 11px;
    letter-spacing: 0.12em; text-transform: uppercase;
    color: var(--muted); padding: 4px 14px;
    border: 1px solid var(--border); border-radius: 20px;
  }
</style>

</head>
<body style="background:var(--bg);margin:0;padding:0">

<!-- ══════════════════════════════════════
     PAGE: LAUNCHER (hub)
══════════════════════════════════════ -->
<div id="page-launcher">
  <div class="launcher-topbar">
    <div class="launcher-logo-mark">🫒</div>
    <span style="font-size:14px;font-weight:700;color:var(--text)">Olives Builder</span>
    <span style="font-size:9px;font-family:'IBM Plex Mono',monospace;color:var(--text3);background:var(--surface2);border:1px solid var(--border);padding:2px 7px;border-radius:4px">v2.1</span>
  </div>
  <div class="launcher-body">
    <div class="launcher-grid">

      <div class="lcard lcard-green lcard-wide" onclick="showPage('home')">
        <div class="lcard-icon">🏠</div>
        <div class="lcard-eye">Main Dashboard</div>
        <div class="lcard-title">Journey Manager</div>
        <div class="lcard-desc">Browse all campaigns — Active, In Design and Completed. Create new journeys, manage your full campaign library and track performance.</div>
        <div class="lcard-arrow">→ Open campaign list</div>
      </div>

      <div class="lcard lcard-blue" onclick="showPage('canvas')">
        <div class="lcard-icon">⚡</div>
        <div class="lcard-eye">Journey Builder</div>
        <div class="lcard-title">Canvas</div>
        <div class="lcard-desc">Drag-and-drop journey builder. Place nodes, connect branches, configure logic and publish campaigns.</div>
        <div class="lcard-arrow">→ Open empty canvas</div>
      </div>

      <div class="lcard lcard-blue" onclick="showPage('canvas', 'demo')">
        <div class="lcard-icon">🗺</div>
        <div class="lcard-eye">Journey Builder</div>
        <div class="lcard-title">Canvas — Demo</div>
        <div class="lcard-desc">Opens the canvas with a pre-built demo journey — two parallel branches, condition splits, random splits and comms nodes.</div>
        <div class="lcard-arrow">→ Open demo journey</div>
      </div>

      <div class="lcard lcard-cyan" onclick="showPage('home'); setTimeout(openSetup, 200);">
        <div class="lcard-icon">✦</div>
        <div class="lcard-eye">Pre-Canvas Setup</div>
        <div class="lcard-title">New Campaign</div>
        <div class="lcard-desc">Two-screen wizard to name and configure a campaign before building — category, timeframe, entry and re-entry rules.</div>
        <div class="lcard-arrow">→ Start setup wizard</div>
      </div>

      <div class="lcard lcard-pink" onclick="showPage('features')">
        <div class="lcard-icon">📋</div>
        <div class="lcard-eye">Documentation</div>
        <div class="lcard-title">Feature Index</div>
        <div class="lcard-desc">Full catalogue of all 49 builder features plus 9 supporting infrastructure items across all modules.</div>
        <div class="lcard-arrow">→ Open index</div>
      </div>

    </div>
  </div>
</div>

<!-- ══════════════════════════════════════
     PAGE: HOME (journey manager)
══════════════════════════════════════ -->
<div id="page-home">
<!-- TOPBAR -->
<header class="topbar">
  <div class="logo">
    <div class="logo-mark">🫒</div>
    <div class="logo-text">Olives Builder</div>
    <a href="#" onclick="showPage('features');return false;" class="btn btn-index">Feature Index</a>
    <span class="logo-version">v2.1</span>
  </div>
  <div class="vsep"></div>
  <nav class="nav-links">
    <button class="nav-link active">Journeys</button>
    <button class="nav-link">Analytics</button>
    <button class="nav-link">Players</button>
    <button class="nav-link">Settings</button>
  </nav>
  <div class="topbar-right">
    <button class="btn btn-ghost" onclick="openTemplates()">📋 From Template</button>
    <button class="btn btn-primary" onclick="createNew()">+ Create New</button>
  </div>
</header>

<!-- PAGE -->
<div class="page">

  <!-- PAGE HEADER -->
  <div class="page-header">
    <div class="page-header-left">
      <div class="page-eyebrow">Journey Manager</div>
      <div class="page-title">Campaigns</div>
      <div class="page-sub">Build, monitor and manage all player journey campaigns from one place.</div>
    </div>
  </div>

  <!-- STATS ROW -->
  <div class="stats-row">
    <div class="stat-card">
      <div class="stat-label">Active Campaigns</div>
      <div class="stat-value">8</div>
      <div class="stat-sub"><div class="stat-dot" style="background:var(--accent)"></div> 3 going live today</div>
    </div>
    <div class="stat-card">
      <div class="stat-label">Total Players in Journey</div>
      <div class="stat-value">24,391</div>
      <div class="stat-sub"><div class="stat-dot" style="background:var(--blue)"></div> +1,204 this week</div>
    </div>
    <div class="stat-card">
      <div class="stat-label">Completed (30d)</div>
      <div class="stat-value">12</div>
      <div class="stat-sub"><div class="stat-dot" style="background:var(--purple)"></div> 6 archived</div>
    </div>
    <div class="stat-card">
      <div class="stat-label">Avg. Conversion Rate</div>
      <div class="stat-value">34.7%</div>
      <div class="stat-sub"><div class="stat-dot" style="background:var(--amber)"></div> +2.1% vs last month</div>
    </div>
  </div>

  <!-- TOOLBAR -->
  <div class="toolbar">
    <div class="search-wrap">
      <span class="search-icon">🔍</span>
      <input type="text" placeholder="Search campaigns…" oninput="filterJourneys(this.value)" id="searchInput" />
    </div>
    <div class="filter-pills">
      <button class="filter-pill active" onclick="setFilter('all',this)">All</button>
      <button class="filter-pill" onclick="setFilter('active',this)">Active</button>
      <button class="filter-pill" onclick="setFilter('design',this)">In Design</button>
      <button class="filter-pill" onclick="setFilter('completed',this)">Completed</button>
    </div>
    <div class="toolbar-right">
      <select class="sort-select" onchange="sortJourneys(this.value)">
        <option value="updated">Last updated</option>
        <option value="name">Name A–Z</option>
        <option value="players">Most players</option>
        <option value="created">Date created</option>
      </select>
    </div>
  </div>

  <!-- ══ SECTION: ACTIVE ══ -->
  <div class="journey-section" id="section-active">
    <div class="section-header">
      <div class="section-title">
        🟢 Active
        <span class="section-badge badge-active" id="count-active">5</span>
      </div>
      <div class="section-line"></div>
    </div>
    <table class="journey-table" id="table-active">
      <thead>
        <tr>
          <th style="width:35%">Campaign</th>
          <th style="width:12%">Status</th>
          <th style="width:12%">Players</th>
          <th style="width:10%">Completed</th>
          <th style="width:10%">Conv. Rate</th>
          <th style="width:11%">Last Updated</th>
          <th style="width:10%"></th>
        </tr>
      </thead>
      <tbody id="tbody-active"></tbody>
    </table>
  </div>

  <!-- ══ SECTION: IN DESIGN ══ -->
  <div class="journey-section" id="section-design">
    <div class="section-header">
      <div class="section-title">
        🔵 In Design
        <span class="section-badge badge-design" id="count-design">4</span>
      </div>
      <div class="section-line"></div>
    </div>
    <table class="journey-table" id="table-design">
      <thead>
        <tr>
          <th style="width:35%">Campaign</th>
          <th style="width:12%">Status</th>
          <th style="width:12%">Players</th>
          <th style="width:10%">Nodes</th>
          <th style="width:10%">Progress</th>
          <th style="width:11%">Last Edited</th>
          <th style="width:10%"></th>
        </tr>
      </thead>
      <tbody id="tbody-design"></tbody>
    </table>
  </div>

  <!-- ══ SECTION: COMPLETED ══ -->
  <div class="journey-section" id="section-completed">
    <div class="section-header">
      <div class="section-title">
        ⚫ Completed
        <span class="section-badge badge-done" id="count-completed">3</span>
      </div>
      <div class="section-line"></div>
    </div>
    <table class="journey-table" id="table-completed">
      <thead>
        <tr>
          <th style="width:35%">Campaign</th>
          <th style="width:12%">Status</th>
          <th style="width:12%">Total Players</th>
          <th style="width:10%">Conversions</th>
          <th style="width:10%">Conv. Rate</th>
          <th style="width:11%">Ended</th>
          <th style="width:10%"></th>
        </tr>
      </thead>
      <tbody id="tbody-completed"></tbody>
    </table>
  </div>

</div><!-- /page -->

<!-- TEMPLATE MODAL -->
<div class="modal-overlay" id="templateModal" onclick="closeTemplates(event)">
  <div class="modal">
    <div class="modal-header">
      <div>
        <div class="modal-title">Start from a Template</div>
        <div class="modal-sub">Choose a pre-built journey structure to get started faster</div>
      </div>
      <button class="modal-close" onclick="closeTemplates()">✕</button>
    </div>
    <div class="modal-body">
      <div class="template-grid">
        <div class="template-card" onclick="useTemplate('Welcome Series')">
          <div class="tc-icon">👋</div>
          <div class="tc-name">Welcome Series</div>
          <div class="tc-desc">Onboard new registrants with a multi-touch welcome flow including a first-deposit bonus and guided tutorial.</div>
          <div class="tc-tags"><span class="tc-tag">Acquisition</span><span class="tc-tag">7 nodes</span></div>
        </div>
        <div class="template-card" onclick="useTemplate('Churn Prevention')">
          <div class="tc-icon">🔄</div>
          <div class="tc-name">Churn Prevention</div>
          <div class="tc-desc">Detect at-risk players by inactivity and trigger re-engagement sequences with personalised bonus offers.</div>
          <div class="tc-tags"><span class="tc-tag">Retention</span><span class="tc-tag">12 nodes</span></div>
        </div>
        <div class="template-card" onclick="useTemplate('VIP Upgrade')">
          <div class="tc-icon">⭐</div>
          <div class="tc-name">VIP Upgrade Path</div>
          <div class="tc-desc">Celebrate tier upgrades and reward players who cross VIP thresholds with exclusive bonuses and messaging.</div>
          <div class="tc-tags"><span class="tc-tag">Retention</span><span class="tc-tag">9 nodes</span></div>
        </div>
        <div class="template-card" onclick="useTemplate('Tournament Push')">
          <div class="tc-icon">🏆</div>
          <div class="tc-name">Tournament Push</div>
          <div class="tc-desc">Drive tournament participation with countdown reminders, rank-based messages and prize announcements.</div>
          <div class="tc-tags"><span class="tc-tag">Conversion</span><span class="tc-tag">10 nodes</span></div>
        </div>
        <div class="template-card" onclick="useTemplate('Reactivation')">
          <div class="tc-icon">💡</div>
          <div class="tc-name">Lapsed Player Reactivation</div>
          <div class="tc-desc">Bring back players dormant for 30+ days through a tiered incentive sequence across email, SMS and in-app.</div>
          <div class="tc-tags"><span class="tc-tag">Reactivation</span><span class="tc-tag">14 nodes</span></div>
        </div>
        <div class="template-card" onclick="useTemplate('Deposit Match')">
          <div class="tc-icon">💰</div>
          <div class="tc-name">Deposit Match Campaign</div>
          <div class="tc-desc">Trigger deposit match bonuses when players meet criteria, with follow-up sequences based on their response.</div>
          <div class="tc-tags"><span class="tc-tag">Conversion</span><span class="tc-tag">8 nodes</span></div>
        </div>
      </div>
    </div>
  </div>
</div>



<!-- ══════════════════════════════════════
     CAMPAIGN SETUP OVERLAY
══════════════════════════════════════ -->
<style>
/* ── OVERLAY SHELL ── */
#setupOverlay{
  position:fixed;inset:0;z-index:400;
  background:var(--bg);
  display:none;flex-direction:column;
  animation:none;
}
#setupOverlay.open{display:flex;animation:suSlideIn 0.28s ease}
@keyframes suSlideIn{from{opacity:0;transform:translateY(18px)}to{opacity:1;transform:translateY(0)}}

/* ── SETUP TOPBAR ── */
.su-topbar{
  height:54px;flex-shrink:0;
  background:rgba(22,25,33,0.97);backdrop-filter:blur(14px);
  border-bottom:1px solid var(--border);
  display:flex;align-items:center;padding:0 28px;gap:0;z-index:10;
}
.su-breadcrumb-wrap{display:flex;align-items:center;gap:8px;font-size:12px;color:var(--text3)}
.su-bc-item{color:var(--text2);cursor:pointer}
.su-bc-item:hover{color:var(--text)}
.su-bc-sep{color:var(--text3)}
.su-bc-active{color:var(--text)}
.su-topbar-right{margin-left:auto;display:flex;align-items:center;gap:8px}

/* ── SETUP BODY ── */
.su-shell{display:flex;flex:1;overflow:hidden}

/* ── SETUP SIDEBAR ── */
.su-sidebar{
  width:256px;flex-shrink:0;
  background:var(--surface);border-right:1px solid var(--border);
  padding:32px 22px;display:flex;flex-direction:column;
}
.su-sidebar-heading{font-size:10px;font-weight:700;letter-spacing:0.1em;text-transform:uppercase;color:var(--text3);margin-bottom:26px}
.su-step-list{display:flex;flex-direction:column}
.su-step-item{display:flex;align-items:flex-start;gap:13px;padding:13px 0;position:relative;cursor:pointer}
.su-step-item:not(:last-child)::after{content:'';position:absolute;left:14px;top:42px;width:2px;height:calc(100% - 14px);background:var(--border2)}
.su-step-item.done:not(:last-child)::after{background:var(--accent2)}
.su-step-dot{
  width:28px;height:28px;flex-shrink:0;border-radius:50%;
  border:2px solid var(--border2);background:var(--surface2);
  display:flex;align-items:center;justify-content:center;
  font-size:11px;font-weight:700;color:var(--text3);position:relative;z-index:1;transition:all 0.22s;
}
.su-step-item.active .su-step-dot{border-color:var(--accent);background:rgba(74,222,128,0.1);color:var(--accent);box-shadow:0 0 0 4px rgba(74,222,128,0.07)}
.su-step-item.done   .su-step-dot{border-color:var(--accent2);background:var(--accent2);color:#fff}
.su-step-title{font-size:13px;font-weight:600;color:var(--text3);padding-top:4px;transition:color 0.18s}
.su-step-sub{font-size:11px;color:var(--text3);margin-top:2px;line-height:1.4}
.su-step-item.active .su-step-title{color:var(--text)}
.su-step-item.done   .su-step-title{color:var(--text2)}

.su-sidebar-footer{margin-top:auto;padding:14px;background:var(--surface2);border:1px solid var(--border);border-radius:10px}
.su-sf-label{font-size:10px;font-weight:700;letter-spacing:0.08em;text-transform:uppercase;color:var(--text3);margin-bottom:5px}
.su-sf-val{font-size:12px;font-weight:600;color:var(--text2);font-family:'IBM Plex Mono',monospace}
.su-progress-bar{height:3px;background:var(--border2);border-radius:2px;margin-top:10px;overflow:hidden}
.su-progress-fill{height:100%;background:linear-gradient(90deg,var(--accent2),var(--accent));border-radius:2px;transition:width 0.38s ease}

/* ── SETUP CONTENT ── */
.su-content{flex:1;overflow-y:auto;overflow-x:hidden;padding:44px 56px;scroll-behavior:smooth}
.su-content::-webkit-scrollbar{width:4px}
.su-content::-webkit-scrollbar-thumb{background:var(--border2);border-radius:2px}

/* ── SCREENS ── */
.su-screen{display:none}
.su-screen.active{display:block;animation:suFadeIn 0.24s ease}
@keyframes suFadeIn{from{opacity:0;transform:translateX(14px)}to{opacity:1;transform:translateX(0)}}

/* ── PAGE HEADER ── */
.su-page-header{margin-bottom:44px}
.su-eyebrow{font-size:10px;font-weight:700;letter-spacing:0.12em;text-transform:uppercase;color:var(--accent);margin-bottom:8px;display:flex;align-items:center;gap:8px}
.su-eyebrow::before{content:'';width:18px;height:2px;background:var(--accent);border-radius:1px}
.su-title{font-size:26px;font-weight:800;color:var(--text);letter-spacing:-0.02em;margin-bottom:8px}
.su-desc{font-size:14px;color:var(--text2);line-height:1.6;max-width:540px}

/* ── FORM ── */
.su-section{margin-bottom:38px}
.su-section-label{font-size:10px;font-weight:700;letter-spacing:0.1em;text-transform:uppercase;color:var(--text3);margin-bottom:18px;padding-bottom:10px;border-bottom:1px solid var(--border)}
.su-field-row{display:grid;gap:18px;margin-bottom:18px}
.su-field-row.c2{grid-template-columns:1fr 1fr}
.su-field-row.c1{grid-template-columns:1fr}
.su-field-group{display:flex;flex-direction:column;gap:7px}
.su-label{font-size:12px;font-weight:600;color:var(--text2);display:flex;align-items:center;gap:8px}
.su-req{color:var(--accent);font-size:10px}
.su-hint{font-size:11px;color:var(--text3);line-height:1.5;margin-top:3px}
.su-char-count{font-size:10px;font-family:'IBM Plex Mono',monospace;color:var(--text3);margin-left:auto}
.su-char-count.warn{color:var(--amber)}
.su-char-count.over{color:var(--red)}

.su-input{
  background:var(--surface2);border:1px solid var(--border2);border-radius:9px;
  padding:11px 14px;font-size:13px;font-family:'Outfit',sans-serif;
  color:var(--text);outline:none;transition:all 0.17s;width:100%;
}
.su-input:focus{border-color:var(--accent);box-shadow:0 0 0 3px rgba(74,222,128,0.08)}
.su-input::placeholder{color:var(--text3)}
.su-input:disabled{opacity:0.4;cursor:not-allowed}
textarea.su-input{resize:vertical;min-height:110px;line-height:1.6}

.su-select{
  background:var(--surface2);border:1px solid var(--border2);border-radius:9px;
  padding:11px 14px;font-size:13px;font-family:'Outfit',sans-serif;
  color:var(--text);outline:none;transition:all 0.17s;width:100%;cursor:pointer;
  appearance:none;padding-right:36px;
  background-image:url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' viewBox='0 0 12 12'%3E%3Cpath fill='%234a5270' d='M6 8L1 3h10z'/%3E%3C/svg%3E");
  background-repeat:no-repeat;background-position:right 13px center;
}
.su-select:focus{border-color:var(--accent);box-shadow:0 0 0 3px rgba(74,222,128,0.08)}
.su-select option{background:var(--surface2)}

/* ── TOGGLE PILL ── */
.su-tp{display:inline-flex;background:var(--surface2);border:1px solid var(--border2);border-radius:9px;padding:3px;gap:2px}
.su-tpbtn{padding:8px 18px;border-radius:7px;font-size:12px;font-weight:600;font-family:'Outfit',sans-serif;border:none;cursor:pointer;color:var(--text3);background:transparent;transition:all 0.17s}
.su-tpbtn.active{background:var(--surface3);color:var(--text);box-shadow:0 1px 4px rgba(0,0,0,0.3)}
.su-tpbtn.active.yes{background:rgba(74,222,128,0.12);color:var(--accent)}
.su-tpbtn.active.no{background:rgba(248,113,113,0.1);color:var(--red)}

/* ── SEGMENT ── */
.su-seg{display:inline-flex;flex-wrap:wrap;background:var(--surface2);border:1px solid var(--border2);border-radius:9px;padding:3px;gap:2px}
.su-segbtn{padding:8px 14px;border-radius:7px;font-size:12px;font-weight:600;font-family:'Outfit',sans-serif;border:none;cursor:pointer;color:var(--text3);background:transparent;transition:all 0.17s;white-space:nowrap}
.su-segbtn.active{background:rgba(74,222,128,0.12);color:var(--accent);box-shadow:0 1px 4px rgba(0,0,0,0.25)}

/* ── DATE ROW ── */
.su-date-row{display:flex;align-items:flex-end;gap:12px;flex-wrap:wrap}
.su-date-col{display:flex;flex-direction:column;gap:5px;flex:1;min-width:150px}
.su-date-sublabel{font-size:10px;font-weight:700;letter-spacing:0.07em;text-transform:uppercase;color:var(--text3)}
.su-date-sep{font-size:13px;color:var(--text3);padding-bottom:12px}

/* ── ONGOING ── */
.su-ongoing{display:flex;align-items:center;gap:9px;padding:9px 13px;background:var(--surface2);border:1px solid var(--border2);border-radius:9px;cursor:pointer;user-select:none;transition:all 0.16s;align-self:flex-end;margin-bottom:0}
.su-ongoing:hover{border-color:var(--border3)}
.su-ongoing.active{border-color:var(--accent);background:rgba(74,222,128,0.06)}
.su-ot-sw{width:30px;height:17px;border-radius:9px;background:var(--surface3);position:relative;transition:background 0.2s;flex-shrink:0}
.su-ongoing.active .su-ot-sw{background:var(--accent2)}
.su-ot-sw::after{content:'';position:absolute;top:2.5px;left:2.5px;width:12px;height:12px;border-radius:50%;background:#fff;transition:left 0.2s}
.su-ongoing.active .su-ot-sw::after{left:15.5px}
.su-ot-lbl{font-size:12px;font-weight:600;color:var(--text2)}
.su-ongoing.active .su-ot-lbl{color:var(--accent)}

/* ── RULE CARD ── */
.su-rule-card{background:var(--surface);border:1px solid var(--border);border-radius:12px;padding:22px;margin-bottom:14px}
.su-rule-header{display:flex;align-items:center;justify-content:space-between;gap:16px;flex-wrap:wrap;gap:12px}
.su-rule-title{font-size:14px;font-weight:700;color:var(--text);display:flex;align-items:center;gap:9px}
.su-rule-icon{width:30px;height:30px;border-radius:8px;display:flex;align-items:center;justify-content:center;font-size:14px}
.su-rule-desc{font-size:11px;color:var(--text3);margin-top:3px;line-height:1.5}
.su-rule-body{margin-top:18px;padding-top:18px;border-top:1px solid var(--border);display:none}
.su-rule-body.open{display:block;animation:suFadeIn 0.18s ease}

/* ── NUM INPUT ── */
.su-num-wrap{display:flex;align-items:center;background:var(--surface2);border:1px solid var(--border2);border-radius:9px;overflow:hidden;transition:border-color 0.17s}
.su-num-wrap:focus-within{border-color:var(--accent);box-shadow:0 0 0 3px rgba(74,222,128,0.08)}
.su-num-wrap input{background:transparent;border:none;outline:none;padding:11px 13px;font-size:13px;font-family:'Outfit',sans-serif;color:var(--text);width:100%}
.su-num-wrap input::placeholder{color:var(--text3)}
.su-num-suffix{padding:0 13px;font-size:12px;font-weight:600;color:var(--text3);border-left:1px solid var(--border);background:var(--surface3);min-height:42px;display:flex;align-items:center;white-space:nowrap}

/* ── DAY PICKER ── */
.su-day-picker{display:flex;gap:5px;flex-wrap:wrap}
.su-daybtn{width:42px;height:42px;border-radius:9px;font-size:11px;font-weight:700;border:1px solid var(--border2);background:var(--surface2);color:var(--text3);cursor:pointer;transition:all 0.14s;font-family:'Outfit',sans-serif}
.su-daybtn:hover{border-color:var(--border3);color:var(--text2)}
.su-daybtn.active{border-color:var(--accent);background:rgba(74,222,128,0.1);color:var(--accent)}

.su-presets{display:flex;gap:7px;flex-wrap:wrap;margin-top:10px}
.su-presetbtn{padding:6px 13px;border-radius:7px;font-size:11px;font-weight:600;border:1px solid var(--border2);background:var(--surface2);color:var(--text3);cursor:pointer;transition:all 0.14s;font-family:'Outfit',sans-serif}
.su-presetbtn:hover{border-color:var(--border3);color:var(--text2)}
.su-presetbtn.active{border-color:var(--blue);background:rgba(96,165,250,0.08);color:var(--blue)}

/* ── NOTICE ── */
.su-notice{display:flex;gap:9px;padding:11px 13px;border-radius:9px;background:rgba(245,158,11,0.07);border:1px solid rgba(245,158,11,0.18);font-size:12px;color:#fbbf24;line-height:1.5;margin-top:10px}
.su-notice.green{background:rgba(74,222,128,0.06);border-color:rgba(74,222,128,0.15);color:var(--accent)}

/* ── FORM FOOTER ── */
.su-form-footer{display:flex;align-items:center;justify-content:space-between;margin-top:48px;padding-top:26px;border-top:1px solid var(--border)}
.su-footer-note{font-size:12px;color:var(--text3)}

/* ── DATE INPUT ── */
input[type=date].su-input::-webkit-calendar-picker-indicator{filter:invert(0.4) sepia(1) hue-rotate(180deg);cursor:pointer;opacity:0.6}
</style>

<div id="setupOverlay">
  <!-- TOPBAR -->
  <div class="su-topbar">
    <div class="logo">
      <div class="logo-mark">🫒</div>
      <div class="logo-text">Olives Builder</div>
    </div>
    <div style="width:1px;height:26px;background:var(--border);margin:0 18px"></div>
    <div class="su-breadcrumb-wrap">
      <span class="su-bc-item" onclick="closeSetup()">Campaigns</span>
      <span class="su-bc-sep">›</span>
      <span class="su-bc-item" onclick="closeSetup()">New Campaign</span>
      <span class="su-bc-sep">›</span>
      <span class="su-bc-active" id="su-breadcrumb">Campaign Info</span>
    </div>
    <div class="su-topbar-right">
      <button class="btn btn-ghost" onclick="closeSetup()">✕ Cancel</button>
      <button class="btn btn-primary" id="su-nextBtn" onclick="suNext()">Continue →</button>
    </div>
  </div>

  <!-- BODY -->
  <div class="su-shell">
    <!-- SIDEBAR -->
    <aside class="su-sidebar">
      <div class="su-sidebar-heading">Setup Steps</div>
      <div class="su-step-list">
        <div class="su-step-item active" id="su-step1" onclick="suGoTo(1)">
          <div class="su-step-dot" id="su-dot1">1</div>
          <div><div class="su-step-title">Campaign Info</div><div class="su-step-sub">Name, category & timeframe</div></div>
        </div>
        <div class="su-step-item" id="su-step2" onclick="suGoTo(2)">
          <div class="su-step-dot" id="su-dot2">2</div>
          <div><div class="su-step-title">Participation Rules</div><div class="su-step-sub">Entry, re-entry & scheduling</div></div>
        </div>
        <div class="su-step-item" id="su-step3">
          <div class="su-step-dot" id="su-dot3">3</div>
          <div><div class="su-step-title">Build Journey</div><div class="su-step-sub">Canvas — nodes & logic</div></div>
        </div>
      </div>
      <div class="su-sidebar-footer">
        <div class="su-sf-label">Completion</div>
        <div class="su-sf-val" id="su-progressLabel">Step 1 of 2</div>
        <div class="su-progress-bar"><div class="su-progress-fill" id="su-progressFill" style="width:0%"></div></div>
      </div>
    </aside>

    <!-- CONTENT -->
    <div class="su-content" id="su-content">

      <!-- ═══ SCREEN 1 ═══ -->
      <div class="su-screen active" id="su-screen1">
        <div class="su-page-header">
          <div class="su-eyebrow">Step 1</div>
          <div class="su-title">Campaign Information</div>
          <div class="su-desc">Define the core identity of your campaign — its name, purpose and time boundaries.</div>
        </div>

        <div class="su-section">
          <div class="su-section-label">Identity</div>
          <div class="su-field-row c1">
            <div class="su-field-group">
              <div class="su-label">Campaign Name <span class="su-req">required</span><span class="su-char-count" id="su-nameCount">0 / 250</span></div>
              <input class="su-input" type="text" id="su-campaignName" maxlength="250" placeholder="e.g. Summer Re-engagement Q3 2025" oninput="suCountChars('su-campaignName','su-nameCount',250)" autocomplete="off"/>
              <div class="su-hint">A clear, descriptive name helps your team identify this campaign.</div>
            </div>
          </div>
          <div class="su-field-row c2">
            <div class="su-field-group">
              <div class="su-label">Category <span class="su-req">required</span></div>
              <select class="su-select" id="su-campaignCategory">
                <option value="" disabled selected>Select a category…</option>
                <option value="acquisition">Acquisition — attract new players</option>
                <option value="conversion">Conversion — turn prospects into depositors</option>
                <option value="retention">Retention — keep active players engaged</option>
                <option value="reactivation">Reactivation — bring back lapsed players</option>
                <option value="general">General — no specific funnel stage</option>
              </select>
            </div>
            <div class="su-field-group">
              <div class="su-label">Demo Campaign?</div>
              <div class="su-tp">
                <button class="su-tpbtn active no" id="su-demoNo" onclick="suSetDemo(false)">No — Live</button>
                <button class="su-tpbtn" id="su-demoYes" onclick="suSetDemo(true)">Yes — Demo</button>
              </div>
              <div class="su-hint" id="su-demoHint">This campaign runs against live player data.</div>
            </div>
          </div>
        </div>

        <div class="su-section">
          <div class="su-section-label">Timeframe</div>
          <div class="su-field-group">
            <div class="su-label">Campaign Duration</div>
            <div class="su-date-row">
              <div class="su-date-col">
                <div class="su-date-sublabel">Start Date</div>
                <input class="su-input" type="date" id="su-startDate"/>
              </div>
              <div class="su-date-sep" id="su-dateSep">→</div>
              <div class="su-date-col" id="su-endDateWrap">
                <div class="su-date-sublabel">End Date</div>
                <input class="su-input" type="date" id="su-endDate"/>
              </div>
              <div class="su-ongoing" id="su-ongoingToggle" onclick="suToggleOngoing()" style="align-self:flex-end;margin-bottom:0">
                <div class="su-ot-sw"></div>
                <span class="su-ot-lbl">Ongoing</span>
              </div>
            </div>
            <div class="su-hint" id="su-dateHint">Campaign runs from start date to end date.</div>
          </div>
        </div>

        <div class="su-section">
          <div class="su-section-label">Notes</div>
          <div class="su-field-group">
            <div class="su-label">Campaign Notes <span class="su-char-count" id="su-wordCount">0 / 1000 words</span></div>
            <textarea class="su-input" id="su-comments" rows="5" placeholder="Add context, objectives, or notes for your team…" oninput="suCountWords('su-comments','su-wordCount',1000)"></textarea>
            <div class="su-hint">Describe the campaign goal, target audience, or any special rules.</div>
          </div>
        </div>

        <div class="su-form-footer">
          <div class="su-footer-note">Fields marked <span style="color:var(--accent)">required</span> must be filled to continue.</div>
          <button class="btn btn-primary" onclick="suNext()">Continue to Participation Rules →</button>
        </div>
      </div>

      <!-- ═══ SCREEN 2 ═══ -->
      <div class="su-screen" id="su-screen2">
        <div class="su-page-header">
          <div class="su-eyebrow">Step 2</div>
          <div class="su-title">Participation Rules</div>
          <div class="su-desc">Control who can enter, how many times, and when the campaign accepts participants.</div>
        </div>

        <!-- Entry Type -->
        <div class="su-section">
          <div class="su-section-label">Entry Mode</div>
          <div class="su-rule-card">
            <div class="su-rule-header">
              <div>
                <div class="su-rule-title"><div class="su-rule-icon" style="background:rgba(74,222,128,0.1)">🚪</div>Entry Type</div>
                <div class="su-rule-desc">Can a player enter this campaign once or multiple times?</div>
              </div>
              <div class="su-seg">
                <button class="su-segbtn active" id="su-entrySingle" onclick="suSetEntry('single')">Single Entry</button>
                <button class="su-segbtn" id="su-entryMulti" onclick="suSetEntry('multi')">Multi Entry</button>
              </div>
            </div>
            <div class="su-rule-body" id="su-entryBody">
              <div class="su-field-row c2">
                <div class="su-field-group">
                  <div class="su-label">Participant Cap</div>
                  <div class="su-num-wrap"><input type="number" id="su-entryCap" placeholder="No cap" min="1"/><div class="su-num-suffix">players max</div></div>
                  <div class="su-hint">Leave empty for unlimited. Once reached, new entries stop.</div>
                </div>
              </div>
              <div class="su-notice">⚠ When the cap is reached, existing participants continue unaffected.</div>
            </div>
          </div>
        </div>

        <!-- Re-entry -->
        <div class="su-section">
          <div class="su-section-label">Re-entry</div>
          <div class="su-rule-card">
            <div class="su-rule-header">
              <div>
                <div class="su-rule-title"><div class="su-rule-icon" style="background:rgba(96,165,250,0.1)">🔄</div>Allow Re-entry</div>
                <div class="su-rule-desc">Can a player who finished or exited the journey re-enter it?</div>
              </div>
              <div class="su-tp">
                <button class="su-tpbtn active no" id="su-reentryNo" onclick="suSetReentry(false)">No</button>
                <button class="su-tpbtn" id="su-reentryYes" onclick="suSetReentry(true)">Yes</button>
              </div>
            </div>
            <div class="su-rule-body" id="su-reentryBody">
              <div class="su-field-row c2">
                <div class="su-field-group">
                  <div class="su-label">Max Re-entries per Player</div>
                  <div class="su-num-wrap"><input type="number" id="su-reentryMax" placeholder="Unlimited" min="1"/><div class="su-num-suffix">times</div></div>
                  <div class="su-hint">Leave empty to allow unlimited re-entries.</div>
                </div>
              </div>
              <div class="su-notice green">✓ Useful for weekly bonuses, recurring missions or seasonal campaigns.</div>
            </div>
          </div>
        </div>

        <!-- Interval -->
        <div class="su-section">
          <div class="su-section-label">Campaign Interval</div>
          <div class="su-rule-card">
            <div class="su-rule-header">
              <div>
                <div class="su-rule-title"><div class="su-rule-icon" style="background:rgba(245,158,11,0.1)">📅</div>Active Window</div>
                <div class="su-rule-desc">When is this campaign open to new entries?</div>
              </div>
              <div class="su-seg">
                <button class="su-segbtn active" id="su-intAlways" onclick="suSetInterval('always')">Always Active</button>
                <button class="su-segbtn" id="su-intScheduled" onclick="suSetInterval('scheduled')">Scheduled Days</button>
              </div>
            </div>
            <div class="su-rule-body" id="su-intervalBody">
              <div style="margin-bottom:18px">
                <div class="su-label" style="margin-bottom:10px">Active Days</div>
                <div class="su-day-picker">
                  <button class="su-daybtn" data-day="Mon" onclick="suToggleDay(this)">Mon</button>
                  <button class="su-daybtn" data-day="Tue" onclick="suToggleDay(this)">Tue</button>
                  <button class="su-daybtn" data-day="Wed" onclick="suToggleDay(this)">Wed</button>
                  <button class="su-daybtn" data-day="Thu" onclick="suToggleDay(this)">Thu</button>
                  <button class="su-daybtn" data-day="Fri" onclick="suToggleDay(this)">Fri</button>
                  <button class="su-daybtn" data-day="Sat" onclick="suToggleDay(this)">Sat</button>
                  <button class="su-daybtn" data-day="Sun" onclick="suToggleDay(this)">Sun</button>
                </div>
                <div class="su-presets">
                  <button class="su-presetbtn" onclick="suApplyPreset('weekdays',event)">Weekdays only</button>
                  <button class="su-presetbtn" onclick="suApplyPreset('weekends',event)">Weekends only</button>
                  <button class="su-presetbtn" onclick="suApplyPreset('all',event)">Every day</button>
                </div>
              </div>
              <div style="padding-top:18px;border-top:1px solid var(--border)">
                <div class="su-label" style="margin-bottom:8px">Entry Cooldown</div>
                <div style="display:flex;gap:8px;align-items:center;flex-wrap:wrap">
                  <div class="su-seg">
                    <button class="su-segbtn" id="su-coolNone" onclick="suSetCooldown('none')">None</button>
                    <button class="su-segbtn" id="su-cool1d" onclick="suSetCooldown('1d')">1 Day</button>
                    <button class="su-segbtn active" id="su-cool1w" onclick="suSetCooldown('1w')">1 Week</button>
                    <button class="su-segbtn" id="su-cool1m" onclick="suSetCooldown('1m')">1 Month</button>
                    <button class="su-segbtn" id="su-coolCustom" onclick="suSetCooldown('custom')">Custom</button>
                  </div>
                  <div id="su-coolCustomWrap" style="display:none">
                    <div class="su-num-wrap" style="width:160px">
                      <input type="number" placeholder="e.g. 3" min="1"/>
                      <div class="su-num-suffix">
                        <select style="background:transparent;border:none;outline:none;color:var(--text3);font-family:Outfit,sans-serif;font-size:12px;cursor:pointer">
                          <option>days</option><option>weeks</option><option>months</option>
                        </select>
                      </div>
                    </div>
                  </div>
                </div>
                <div class="su-hint" style="margin-top:7px">Time a player must wait before they can enter again.</div>
              </div>
            </div>
          </div>
        </div>

        <div class="su-form-footer">
          <button class="btn btn-ghost" onclick="suPrev()">← Back</button>
          <button class="btn btn-primary" onclick="suLaunch()">Create Campaign & Build Journey →</button>
        </div>
      </div>

    </div><!-- /su-content -->
  </div><!-- /su-shell -->
</div><!-- /setupOverlay -->
</div>

<!-- ══════════════════════════════════════
     PAGE: CANVAS (journey builder)
══════════════════════════════════════ -->
<div id="page-canvas">
<div class="app" id="app">
<!-- TOPBAR -->
<header class="topbar">
  <div class="logo"><a href="#" onclick="showPage('home');return false;" style="display:flex;align-items:center;gap:7px;text-decoration:none" title="Back to Campaigns"><div class="logo-mark">🫒</div><div class="logo-text">Olives Builder</div></a><a href="#" onclick="showPage('features');return false;" style="font-size:10px;font-weight:600;font-family:Outfit,sans-serif;padding:3px 10px;border-radius:6px;background:rgba(219,112,147,0.12);border:1px solid rgba(219,112,147,0.35);color:#d4748f;text-decoration:none;margin-left:8px">Feature Index</a></div>
  <div class="vsep"></div>
  <input class="campaign-name" id="campaignName" value="Tournament Re-engagement Q3" />
  <div class="topbar-status"><div class="status-dot" id="statusDot"></div><span id="statusLabel">Draft</span></div>
  <div class="topbar-actions">
    <button class="icon-btn" title="Undo (Ctrl+Z)" onclick="undo()">↩</button>
    <button class="icon-btn" title="Redo (Ctrl+Y)" onclick="redo()">↪</button>
    <div class="vsep"></div>
    <button class="btn btn-ghost" onclick="showAlert('📥 Import ready')">📥 Import</button>
    <button class="btn btn-danger" onclick="clearCanvas()">🗑 Clear</button>
    <button class="btn btn-ghost" onclick="validateJourney()">✓ Validate</button>
    <button class="btn btn-primary" onclick="publishJourney()">▶ Publish</button>
  </div>
</header>

<!-- LEFT PANEL -->
<aside class="left-panel">
  <div class="panel-search">
    <div class="search-box">
      <span style="color:var(--text3);font-size:11px">🔍</span>
      <input type="text" placeholder="Search nodes…" oninput="filterNodes(this.value)"/>
    </div>
  </div>
  <div class="palette-section">
    <div class="section-toggle" onclick="toggleSec('flow')"><span class="section-arrow open" id="arr-flow">›</span> Flow</div>
    <div class="section-items" id="sec-flow">
      <div class="node-item" onmousedown="startPaletteDrag(event,'wait')"><div class="ni-icon nc-wait">🕐</div><span class="ni-label">Wait</span></div>
      <div class="node-item" onmousedown="startPaletteDrag(event,'random')"><div class="ni-icon nc-split">⚡</div><span class="ni-label">Random Split</span></div>
      <div class="node-item" onmousedown="startPaletteDrag(event,'event-split')"><div class="ni-icon nc-flow">⑂</div><span class="ni-label">Event Split</span></div>
      <div class="node-item" onmousedown="startPaletteDrag(event,'condition')"><div class="ni-icon nc-cond">◇</div><span class="ni-label">Condition Split</span></div>
      <div class="node-item" onmousedown="startPaletteDrag(event,'end')"><div class="ni-icon nc-end">⊗</div><span class="ni-label">End</span></div>
      <div class="node-item" onmousedown="startPaletteDrag(event,'pull')"><div class="ni-icon nc-pull">⬇</div><span class="ni-label">Pull Data</span></div>
    </div>
  </div>
  <div class="palette-section">
    <div class="section-toggle" onclick="toggleSec('act')"><span class="section-arrow open" id="arr-act">›</span> Activities</div>
    <div class="section-items" id="sec-act">
      <div class="node-item" onmousedown="startPaletteDrag(event,'bonus')"><div class="ni-icon nc-activity">🎁</div><span class="ni-label">Add Bonus</span></div>
      <div class="node-item" onmousedown="startPaletteDrag(event,'leaderboard')"><div class="ni-icon nc-activity">🏆</div><span class="ni-label">Add/Remove from Leaderboard</span></div>
      <div class="node-item" onmousedown="startPaletteDrag(event,'mission')"><div class="ni-icon nc-activity">🎯</div><span class="ni-label">Add/Remove from Mission</span></div>
      <div class="node-item" onmousedown="startPaletteDrag(event,'tournament')"><div class="ni-icon nc-activity">🥇</div><span class="ni-label">Add/Remove from Tournament</span></div>
      <div class="node-item" onmousedown="startPaletteDrag(event,'skin')"><div class="ni-icon nc-activity">🎮</div><span class="ni-label">Game Skin On/Off</span></div>
      <div class="node-item" onmousedown="startPaletteDrag(event,'coins')"><div class="ni-icon nc-activity">🪙</div><span class="ni-label">Add Betty Coins</span></div>
      <div class="node-item" onmousedown="startPaletteDrag(event,'shop')"><div class="ni-icon nc-activity">🛍</div><span class="ni-label">Go to Shop</span></div>
      <div class="node-item" onmousedown="startPaletteDrag(event,'esb')"><div class="ni-icon nc-activity">🌐</div><span class="ni-label">ESB Engagement Tools</span></div>
    </div>
  </div>
  <div class="palette-section">
    <div class="section-toggle" onclick="toggleSec('comms')"><span class="section-arrow open" id="arr-comms">›</span> Communications</div>
    <div class="section-items" id="sec-comms">
      <div class="node-item" onmousedown="startPaletteDrag(event,'rtmsg')"><div class="ni-icon nc-comms">💬</div><span class="ni-label">Player Real-Time Message</span></div>
      <div class="node-item" onmousedown="startPaletteDrag(event,'email')"><div class="ni-icon nc-comms">📧</div><span class="ni-label">Email</span></div>
      <div class="node-item" onmousedown="startPaletteDrag(event,'sms')"><div class="ni-icon nc-comms">📱</div><span class="ni-label">SMS</span></div>
      <div class="node-item" onmousedown="startPaletteDrag(event,'push')"><div class="ni-icon nc-comms">🔔</div><span class="ni-label">Push Notification</span></div>
      <div class="node-item" onmousedown="startPaletteDrag(event,'slack')"><div class="ni-icon nc-comms">💼</div><span class="ni-label">Slack (Internal)</span></div>
    </div>
  </div>
  <div class="palette-section">
    <div class="section-toggle" onclick="toggleSec('pdata')"><span class="section-arrow open" id="arr-pdata">›</span> Player Data</div>
    <div class="section-items" id="sec-pdata">
      <div class="node-item" onmousedown="startPaletteDrag(event,'tag')"><div class="ni-icon nc-data">🏷</div><span class="ni-label">Add/Remove Tag</span></div>
      <div class="node-item" onmousedown="startPaletteDrag(event,'vip')"><div class="ni-icon nc-data">⭐</div><span class="ni-label">Change VIP Level</span></div>
      <div class="node-item" onmousedown="startPaletteDrag(event,'status')"><div class="ni-icon nc-data">📊</div><span class="ni-label">Change Status Level</span></div>
    </div>
  </div>
</aside>

<!-- CANVAS -->
<main class="canvas-wrap" id="canvasWrap">
  <div class="canvas-viewport" id="viewport">
    <svg class="connections-svg" id="connSvg"></svg>
  </div>

  <!-- TRIGGER GATE -->
  <div class="trigger-gate" id="triggerGate">
    <div class="trigger-card">
      <h2>Choose your trigger type</h2>
      <p>Every journey starts with a trigger. Pick the type that matches your campaign goal — this determines the flow rules available to you.</p>
      <div class="trigger-options">
        <div class="trigger-opt realtime" onclick="selectTrigger('realtime')">
          <div class="trigger-opt-icon nc-trigger">⚡</div>
          <div class="trigger-opt-label">Real-time</div>
          <div class="trigger-opt-sub">Event-driven</div>
        </div>
        <div class="trigger-opt schedule" onclick="selectTrigger('schedule')">
          <div class="trigger-opt-icon nc-schedule">📅</div>
          <div class="trigger-opt-label">Schedule</div>
          <div class="trigger-opt-sub">Time-based</div>
        </div>
      </div>
    </div>
  </div>

  <!-- ZOOM -->
  <div class="zoom-controls">
    <button class="zoom-btn" onclick="doZoom(1.15)">+</button>
    <div class="zoom-level" id="zoomLbl">100%</div>
    <button class="zoom-btn" onclick="doZoom(0.87)">−</button>
    <button class="zoom-btn" title="Fit" onclick="fitCanvas()">⊞</button>
  </div>

  <!-- MINIMAP -->
  <div class="minimap">
    <div class="minimap-inner" id="mmInner"><div class="mm-viewport"></div></div>
    <div class="minimap-label">Minimap</div>
  </div>
</main>
</div>

<!-- RIGHT PANEL (overlay) -->
<aside class="right-panel" id="rightPanel">
  <div class="rpanel-header">
    <div><div class="rpanel-title" id="rpTitle">Properties</div><div class="rpanel-subtitle" id="rpSub"></div></div>
    <button class="rpanel-close" onclick="closePanel()">✕</button>
  </div>
  <div class="rpanel-body" id="rpBody"></div>
  <div class="rpanel-footer"><button class="save-btn" onclick="saveNode()">Save Changes</button></div>
</aside>

<!-- BOTTOM BAR -->
<footer class="bottom-bar">
  <div class="bbar-seg">
    <div class="bbar-stat"><div class="bbar-dot" style="background:#4ade80"></div><span class="bbar-lbl">Active</span><span class="bbar-val" id="bActive">1,247</span></div>
  </div>
  <div class="bbar-seg">
    <div class="bbar-stat"><div class="bbar-dot" style="background:#f97316"></div><span class="bbar-lbl">In journey</span><span class="bbar-val" id="bJourney">342</span></div>
  </div>
  <div class="bbar-seg">
    <div class="bbar-stat"><div class="bbar-dot" style="background:#38bdf8"></div><span class="bbar-lbl">Completed</span><span class="bbar-val" id="bDone">89</span></div>
  </div>
  <div class="bbar-seg">
    <div class="bbar-stat"><div class="bbar-dot" style="background:#a855f7"></div><span class="bbar-lbl">Nodes</span><span class="bbar-val" id="bNodes">0</span></div>
  </div>
  <div class="bbar-seg">
    <div class="hm-toggle" onclick="toggleHeatmap()">
      <div class="toggle-sw" id="hmSwitch"></div><span>Live Heatmap</span>
    </div>
  </div>
  <div class="bbar-seg"><span class="bbar-lbl" id="bStatus">Draft — unsaved</span></div>
</footer>

<!-- CONNECTING SVG (live drag line) -->
<svg id="connectingSvg"><line id="connectingLine" stroke="#4ade80" stroke-width="2" stroke-dasharray="6,3" opacity="0.7"/></svg>

<!-- CONTEXT MENU -->
<div class="ctx-menu" id="ctxMenu"></div>

<!-- VALIDATION TOAST -->
<div class="val-toast" id="valToast">
  <div class="val-toast-header">
    <span style="font-size:14px">🔍</span>
    <span class="val-toast-title">Journey Validation</span>
    <button class="val-toast-close" onclick="document.getElementById('valToast').style.display='none'">✕</button>
  </div>
  <div class="val-toast-body" id="valBody"></div>
</div>

<!-- CONFIRM DIALOG -->
<div class="confirm-overlay" id="confirmOverlay">
  <div class="confirm-card">
    <div class="confirm-icon">⚠️</div>
    <div class="confirm-title" id="confirmTitle">Delete branch?</div>
    <div class="confirm-body" id="confirmBody">This will remove the node and all downstream nodes connected to this branch. This cannot be undone.</div>
    <div class="confirm-actions">
      <button class="confirm-cancel" onclick="hideConfirm()">Cancel</button>
      <button class="confirm-delete" id="confirmBtn" onclick="confirmDeleteExecute()">Delete Branch</button>
    </div>
  </div>
</div>

<!-- ALERT -->
<div class="alert-bar" id="alertBar"></div>


<!-- DRAG GHOST -->
<div id="dragGhost"><div class="dg-card"><div class="dg-icon"></div><div class="dg-label"></div></div></div>
</div>

<!-- ══════════════════════════════════════
     PAGE: FEATURE INDEX
══════════════════════════════════════ -->
<div id="page-features" style="font-family:'Syne',sans-serif">
  <div style="padding:16px 24px;background:rgba(22,25,33,0.95);backdrop-filter:blur(12px);border-bottom:1px solid var(--border);display:flex;align-items:center;gap:12px;position:sticky;top:0;z-index:100">
    <button onclick="showPage('launcher')" style="background:var(--surface2);border:1px solid var(--border2);color:var(--text2);padding:6px 14px;border-radius:7px;font-size:12px;font-family:'Outfit',sans-serif;cursor:pointer;font-weight:600">← Back</button>
    <span style="font-size:13px;font-weight:700;color:var(--text)">Feature Index</span>
  </div>
<header>
  <div>
    <div class="label">Olives Builder · Master Feature Index v3 · Feb 2026</div>
    <h1>Full Feature <span>Index</span></h1>
  </div>
  <div class="legend">
    <div class="leg"><div class="leg-dot" style="background:var(--accent)"></div>MVP — first build</div>
    <div class="leg"><div class="leg-dot" style="background:var(--c-setup)"></div>Built today</div>
    <div class="leg"><div class="leg-dot" style="background:var(--muted)"></div>Phase 2</div>
    <div class="leg"><div class="leg-dot" style="background:var(--c-support)"></div>Supporting infrastructure</div>
  </div>
</header>

<div class="stats">
  <div class="stat-card"><div class="stat-num accent">49</div><div class="stat-label">Builder Features</div></div>
  <div class="stat-card"><div class="stat-num cyan">11</div><div class="stat-label">Built Today</div></div>
  <div class="stat-card"><div class="stat-num accent">22</div><div class="stat-label">MVP Scope</div></div>
  <div class="stat-card"><div class="stat-num amber">9</div><div class="stat-label">Supporting Dev Items</div></div>
  <div class="stat-card"><div class="stat-num">58</div><div class="stat-label">Total Items</div></div>
</div>


<!-- ══════════════════════════════════════════
     SECTION 0: CAMPAIGN SETUP (NEW TODAY)
══════════════════════════════════════════ -->
<div class="section">
  <div class="section-header">
    <div class="section-color" style="background:var(--c-setup)"></div>
    <span class="section-title" style="color:var(--c-setup)">Campaign Setup Flow</span>
    <span class="section-count">6 features</span>
    <span class="section-zone">Pre-canvas setup screens</span>
  </div>
  <table>
    <thead><tr><th>#</th><th>Feature</th><th>Description</th><th>UX Behaviour</th><th>Status</th></tr></thead>
    <tbody>
      <tr>
        <td class="feat-id">CS-01</td>
        <td class="feat-name">Journey Manager Homepage</td>
        <td class="feat-desc">Central dashboard listing all journeys organised into Active, In Design, and Completed sections. Gives the CRM team instant visibility of every campaign's status, player counts and conversion rates from one screen.</td>
        <td class="feat-ux">Three grouped table sections. Each row shows name, status badge, player count, conversion rate, sparkline and last-updated. Click row name or open via 3-dot menu to enter canvas. Stats summary cards at top.</td>
        <td><span class="badge b-built">BUILT</span> <span class="badge b-mvp">MVP</span></td>
      </tr>
      <tr>
        <td class="feat-id">CS-02</td>
        <td class="feat-name">Campaign Actions Menu</td>
        <td class="feat-desc">Per-row 3-dot menu giving operators quick access to all lifecycle actions on a journey without entering the canvas. Available actions are context-aware — only valid transitions are shown per current status.</td>
        <td class="feat-ux">3-dot button on every row opens a positioned dropdown. Actions: Open in Canvas, Activate, Pause/Resume, Mark Complete, Block, Duplicate, Delete. Dangerous actions (Delete) separated and coloured red.</td>
        <td><span class="badge b-built">BUILT</span> <span class="badge b-mvp">MVP</span></td>
      </tr>
      <tr>
        <td class="feat-id">CS-03</td>
        <td class="feat-name">Create Campaign — Screen 1 (Info)</td>
        <td class="feat-desc">First step of the two-screen campaign creation wizard. Captures the core identity fields required before a canvas can be built. Validates required fields before allowing progression to step 2.</td>
        <td class="feat-ux">Campaign name (250 char, live counter), category selector (Acquisition / Conversion / Retention / Reactivation / General), Demo/Live toggle, start/end date pickers with Ongoing toggle that disables end date, 1000-word notes field with live word counter.</td>
        <td><span class="badge b-built">BUILT</span> <span class="badge b-mvp">MVP</span></td>
      </tr>
      <tr>
        <td class="feat-id">CS-04</td>
        <td class="feat-name">Create Campaign — Screen 2 (Participation)</td>
        <td class="feat-desc">Second wizard step defining the rules that control how and when players can participate in the campaign. Each rule card expands when enabled, revealing relevant configuration.</td>
        <td class="feat-ux">Entry Type (Single/Multi — Multi reveals participant cap field), Re-entry toggle (reveals max re-entries field), Campaign Interval (Always Active / Scheduled Days — reveals day picker with Mon–Sun toggles, quick presets, and Entry Cooldown selector with None/1 Day/1 Week/1 Month/Custom options).</td>
        <td><span class="badge b-built">BUILT</span> <span class="badge b-mvp">MVP</span></td>
      </tr>
      <tr>
        <td class="feat-id">CS-05</td>
        <td class="feat-name">Start from Template</td>
        <td class="feat-desc">Allows admins to bootstrap a new campaign from a pre-built journey template. Template library covers common use-cases so the team doesn't start from a blank canvas for standard campaigns.</td>
        <td class="feat-ux">Modal opened by "From Template" button. Grid of 6 templates: Welcome Series, Churn Prevention, VIP Upgrade, Tournament Push, Lapsed Player Reactivation, Deposit Match Campaign. Each card shows icon, name, description and tags (category + node count). Selecting a template pre-fills campaign name and opens canvas with pre-built nodes.</td>
        <td><span class="badge b-built">BUILT</span> <span class="badge b-mvp">MVP</span></td>
      </tr>
      <tr>
        <td class="feat-id">CS-06</td>
        <td class="feat-name">Wizard Progress Sidebar</td>
        <td class="feat-desc">Persistent left sidebar during the setup flow showing the three-step progress (Campaign Info → Participation Rules → Build Journey). Keeps the admin oriented during multi-step setup and allows backwards navigation.</td>
        <td class="feat-ux">Connected dot-and-line step list. Active step glows green, completed steps show tick. Progress bar and step label in footer card. Breadcrumb in topbar updates per step. Back navigation allowed; forward only after validation passes.</td>
        <td><span class="badge b-built">BUILT</span> <span class="badge b-mvp">MVP</span></td>
      </tr>
    </tbody>
  </table>
</div>


<!-- ══════════════════════════════════════════
     SECTION 1: CANVAS WORKSPACE
══════════════════════════════════════════ -->
<div class="section">
  <div class="section-header">
    <div class="section-color" style="background:var(--c-canvas)"></div>
    <span class="section-title" style="color:var(--c-canvas)">Canvas Workspace</span>
    <span class="section-count">8 features</span>
    <span class="section-zone">Zone ② Main Canvas</span>
  </div>
  <table>
    <thead><tr><th>#</th><th>Feature</th><th>Description</th><th>UX Behaviour</th><th>Status</th></tr></thead>
    <tbody>
      <tr>
        <td class="feat-id">C-01</td>
        <td class="feat-name">Visual Canvas</td>
        <td class="feat-desc">The central drag-and-drop workspace where admins design, connect, and monitor journeys. Serves simultaneously as design board and live control room.</td>
        <td class="feat-ux">Infinite pan + zoom. Nodes snap to grid. Background dot-grid for alignment. Canvas opens empty — trigger gate shown on first open.</td>
        <td><span class="badge b-mvp">MVP</span></td>
      </tr>
      <tr>
        <td class="feat-id">C-02</td>
        <td class="feat-name">Zoom & Pan Controls</td>
        <td class="feat-desc">Allows admins to navigate large journey flows. Zoom in for detail, zoom out for overview. Mouse wheel + space-drag supported. Fit-all button centres all content.</td>
        <td class="feat-ux">Toolbar zoom buttons + scroll wheel. Space-bar hold activates pan mode. ⊞ Fit button auto-scales viewport to show all nodes. Zoom capped at 20%–200%.</td>
        <td><span class="badge b-mvp">MVP</span></td>
      </tr>
      <tr>
        <td class="feat-id">C-03</td>
        <td class="feat-name">Minimap Overview Panel</td>
        <td class="feat-desc">A thumbnail of the entire journey in the bottom corner. Shows current viewport position as a highlighted rectangle. Click-to-jump to any area of a large flow.</td>
        <td class="feat-ux">Always-visible corner widget. Highlighted viewport rectangle. Click anywhere on minimap to navigate.</td>
        <td><span class="badge b-mvp">MVP</span></td>
      </tr>
      <tr>
        <td class="feat-id">C-04</td>
        <td class="feat-name">Undo / Redo</td>
        <td class="feat-desc">Full snapshot-based action history allowing admins to reverse or reapply any canvas action — node additions, deletions, connections. Stack capped at 40 snapshots; any new action clears the redo stack.</td>
        <td class="feat-ux">Ctrl+Z / Ctrl+Y (or Ctrl+Shift+Z) keyboard shortcuts + toolbar buttons. Deep JSON clone of full state per snapshot.</td>
        <td><span class="badge b-built">BUILT</span> <span class="badge b-mvp">MVP</span></td>
      </tr>
      <tr>
        <td class="feat-id">C-05</td>
        <td class="feat-name">Drag-and-Drop Node Placement</td>
        <td class="feat-desc">Admins drag node types from the left palette onto placeholder slots on the canvas. A floating ghost card follows the cursor during drag; placeholder slots highlight on hover. Snap-to-nearest within 80px on release.</td>
        <td class="feat-ux">Mousedown on palette item → ghost card appears. Placeholder slots glow green on hover. Release on valid slot fills it instantly. Release outside valid zone shows hint. Drag-to-connect and palette drag use independent event paths to avoid conflict.</td>
        <td><span class="badge b-built">BUILT</span> <span class="badge b-mvp">MVP</span></td>
      </tr>
      <tr>
        <td class="feat-id">C-06</td>
        <td class="feat-name">Smart Fork Branch Spacing</td>
        <td class="feat-desc">When a fork node (condition, random split, event split) is placed, its branches are automatically spaced vertically centred on the fork with BRANCH_GAP=2 row-slots between siblings. A row-push algorithm shifts any conflicting downstream nodes down to prevent overlap.</td>
        <td class="feat-ux">Branches spread symmetrically around fork row. shiftSubtree() recursively moves entire downstream chains together. repack() acts as safety net only — never flattens intentional gaps.</td>
        <td><span class="badge b-built">BUILT</span> <span class="badge b-mvp">MVP</span></td>
      </tr>
      <tr>
        <td class="feat-id">C-07</td>
        <td class="feat-name">Node Deletion (All Types)</td>
        <td class="feat-desc">Every node including the trigger is deleteable. Regular nodes soft-delete to a ghost placeholder slot. Fork nodes show a confirm dialog listing downstream node count before hard-deleting the entire branch. Deleting the trigger resets the canvas to trigger-selection gate.</td>
        <td class="feat-ux">Trash icon on every node card. Confirm dialog for fork/trigger deletion. Soft-deleted slots remain visible with dashed border for re-use. Trigger deletion shows "Reset Journey" confirm with clear warning copy.</td>
        <td><span class="badge b-built">BUILT</span> <span class="badge b-mvp">MVP</span></td>
      </tr>
      <tr>
        <td class="feat-id">C-08</td>
        <td class="feat-name">Empty Canvas Default</td>
        <td class="feat-desc">Canvas opens blank with the trigger-type gate visible, ready for the admin to start building. Pre-built demo data is only loaded when a template journey is opened (via ?demo=1 URL param). Prevents confusion between a new empty campaign and an existing journey.</td>
        <td class="feat-ux">window.onload checks URL params. No demo nodes unless ?demo=1. Trigger gate shown immediately. Template journeys open with their pre-built node structure.</td>
        <td><span class="badge b-built">BUILT</span> <span class="badge b-mvp">MVP</span></td>
      </tr>
    </tbody>
  </table>
</div>


<!-- ══════════════════════════════════════════
     SECTION 2: TRIGGERS
══════════════════════════════════════════ -->
<div class="section">
  <div class="section-header">
    <div class="section-color" style="background:var(--c-trigger)"></div>
    <span class="section-title" style="color:var(--c-trigger)">Trigger Nodes</span>
    <span class="section-count">5 features</span>
    <span class="section-zone">Zone ② Node Palette</span>
  </div>
  <table>
    <thead><tr><th>#</th><th>Feature</th><th>Description</th><th>UX Behaviour</th><th>Status</th></tr></thead>
    <tbody>
      <tr>
        <td class="feat-id">T-01</td>
        <td class="feat-name">Real-Time Trigger</td>
        <td class="feat-desc">Starts a journey when a live player event fires. Reacts the moment the event occurs — login, deposit, bet, game round complete. Mutually exclusive with Schedule Trigger on the same journey.</td>
        <td class="feat-ux">Entry point node, always first. Deleteable with canvas-reset confirm. Highlighted in green when active.</td>
        <td><span class="badge b-mvp">MVP</span></td>
      </tr>
      <tr>
        <td class="feat-id">T-02</td>
        <td class="feat-name">Multi-Event Trigger (Branch Fork)</td>
        <td class="feat-desc">Admin selects up to 3 trigger events simultaneously. Each creates its own independent parallel branch. Journey executes the branch matching the event that fired.
          <ul class="sub-items">
            <li>2 events → 2 branches centred on trigger row, BRANCH_GAP=2 apart</li>
            <li>3 events → 3 branches, middle aligned with trigger, top/bottom offset by 2</li>
          </ul>
        </td>
        <td class="feat-ux">Checkbox selection in trigger config panel. Live branch preview as events are added/removed. Max 3 warning at limit. Branch labels update immediately on canvas.</td>
        <td><span class="badge b-mvp">MVP</span></td>
      </tr>
      <tr>
        <td class="feat-id">T-03</td>
        <td class="feat-name">Schedule Trigger</td>
        <td class="feat-desc">Starts a journey at a set date/time or on a repeating interval. Mutually exclusive with Real-Time Trigger. Single-cycle only — no event listening after action.</td>
        <td class="feat-ux">Calendar date picker + recurrence config. Greyed out if Real-Time is selected.</td>
        <td><span class="badge b-mvp">MVP</span></td>
      </tr>
      <tr>
        <td class="feat-id">T-04</td>
        <td class="feat-name">Manual Trigger</td>
        <td class="feat-desc">CRM team initiates the journey manually for a selected audience segment. Used for re-engagement, birthday campaigns, or ad-hoc outreach.</td>
        <td class="feat-ux">Audience selector + confirm launch button. Shows estimated reach count before confirming.</td>
        <td><span class="badge b-mvp">MVP</span></td>
      </tr>
      <tr>
        <td class="feat-id">T-05</td>
        <td class="feat-name">Page Move Event</td>
        <td class="feat-desc">Triggers or reacts when a player navigates to a specific page. Supports multi-select destinations — Web and App pages tracked separately.
          <ul class="sub-items">
            <li>Web: Homepage, Cashier, Promo, Games, Account Settings, Support</li>
            <li>App: Homepage, Cashier, Promo, Games, Profile Screen, Settings</li>
          </ul>
        </td>
        <td class="feat-ux">Checkbox list under event selector. Grouped by Web / App. Selected pages shown as summary chips.</td>
        <td><span class="badge b-mvp">MVP</span></td>
      </tr>
    </tbody>
  </table>
</div>


<!-- ══════════════════════════════════════════
     SECTION 3: FLOW CONTROL NODES
══════════════════════════════════════════ -->
<div class="section">
  <div class="section-header">
    <div class="section-color" style="background:var(--c-flow)"></div>
    <span class="section-title" style="color:var(--c-flow)">Flow Control Nodes</span>
    <span class="section-count">6 features</span>
    <span class="section-zone">Zone ② Node Palette → Flow</span>
  </div>
  <table>
    <thead><tr><th>#</th><th>Feature</th><th>Description</th><th>UX Behaviour</th><th>Status</th></tr></thead>
    <tbody>
      <tr>
        <td class="feat-id">F-01</td>
        <td class="feat-name">Condition Split</td>
        <td class="feat-desc">Evaluates a player attribute or event condition and routes to Yes or No branch. The primary logic gate in the journey. Uses the full Condition Builder.</td>
        <td class="feat-ux">Diamond node shape. Yes branch = green, No branch = red. Condition summary shown on node face.</td>
        <td><span class="badge b-mvp">MVP</span></td>
      </tr>
      <tr>
        <td class="feat-id">F-02</td>
        <td class="feat-name">Event Split</td>
        <td class="feat-desc">Listens for a specific player event and forks into Yes (event occurred) / No (timed out) branches. Combines Wait and Condition in one node.</td>
        <td class="feat-ux">Two output ports Yes / No. Timeout setting in config panel. Shows event name on node face.</td>
        <td><span class="badge b-mvp">MVP</span></td>
      </tr>
      <tr>
        <td class="feat-id">F-03</td>
        <td class="feat-name">Random Split</td>
        <td class="feat-desc">Divides the player audience randomly across 3 branches (default 33% each). Used for A/B/C testing and controlled experiments within a campaign.</td>
        <td class="feat-ux">3 output branches labelled with % weight. Weights editable and must sum to 100%.</td>
        <td><span class="badge b-mvp">MVP</span></td>
      </tr>
      <tr>
        <td class="feat-id">F-04</td>
        <td class="feat-name">Wait Node</td>
        <td class="feat-desc">Pauses the player's journey for a defined duration before proceeding. Can wait by fixed time or until a specific event occurs.</td>
        <td class="feat-ux">Clock icon node. Duration selector (minutes/hours/days). Goal event optional override field.</td>
        <td><span class="badge b-mvp">MVP</span></td>
      </tr>
      <tr>
        <td class="feat-id">F-05</td>
        <td class="feat-name">Pull Data Node</td>
        <td class="feat-desc">Fetches a specific data attribute for a player at that point in the journey — from real-time sources or historical DWH. Result available for downstream conditions and actions.</td>
        <td class="feat-ux">Database icon node. Source picker + field selector. Output labelled with field name for downstream use.</td>
        <td><span class="badge b-mvp">MVP</span></td>
      </tr>
      <tr>
        <td class="feat-id">F-06</td>
        <td class="feat-name">End Node</td>
        <td class="feat-desc">Terminates the journey for a player who reaches this point. A journey can have multiple End nodes to close different branches cleanly.</td>
        <td class="feat-ux">Red stop marker. Optional end-state label (e.g. "Converted", "Churned", "Timed Out"). Always available in Flow palette.</td>
        <td><span class="badge b-mvp">MVP</span></td>
      </tr>
    </tbody>
  </table>
</div>


<!-- ══════════════════════════════════════════
     SECTION 4: CONDITION BUILDER
══════════════════════════════════════════ -->
<div class="section">
  <div class="section-header">
    <div class="section-color" style="background:var(--c-condition)"></div>
    <span class="section-title" style="color:var(--c-condition)">Condition Builder</span>
    <span class="section-count">8 features</span>
    <span class="section-zone">Zone ③ Config Panel</span>
  </div>
  <table>
    <thead><tr><th>#</th><th>Feature</th><th>Description</th><th>UX Behaviour</th><th>Status</th></tr></thead>
    <tbody>
      <tr>
        <td class="feat-id">CB-01</td>
        <td class="feat-name">Condition Builder (Core)</td>
        <td class="feat-desc">Cascading logic builder for defining player eligibility rules. Each condition uses Field → Operator → Value structure. Multiple conditions combined with AND/OR logic.</td>
        <td class="feat-ux">Inline row-based builder. Add/remove condition rows. AND/OR toggle between rows. Live validation.</td>
        <td><span class="badge b-mvp">MVP</span></td>
      </tr>
      <tr>
        <td class="feat-id">CB-02</td>
        <td class="feat-name">Player Attribute Conditions</td>
        <td class="feat-desc">Conditions based on stored player profile fields: VIP level, total deposits, account age, country, preferred game category, registration date.</td>
        <td class="feat-ux">Field dropdown grouped by Attribute / Behaviour / Event. Operator changes based on field type (numeric vs string vs date).</td>
        <td><span class="badge b-mvp">MVP</span></td>
      </tr>
      <tr>
        <td class="feat-id">CB-03</td>
        <td class="feat-name">Behavioural Conditions</td>
        <td class="feat-desc">Conditions based on recent player behaviour: days since last login, number of sessions this week, bet frequency, deposit recency.</td>
        <td class="feat-ux">Time-window selector paired with behaviour metric. e.g. "Last login > 7 days ago".</td>
        <td><span class="badge b-mvp">MVP</span></td>
      </tr>
      <tr>
        <td class="feat-id">CB-04</td>
        <td class="feat-name">Event-Based Conditions</td>
        <td class="feat-desc">Conditions that evaluate whether a specific event occurred: has the player deposited, completed a tournament, triggered a specific page visit.</td>
        <td class="feat-ux">Event picker from catalogue. Count and recency qualifiers. "Has done / Has not done" pattern.</td>
        <td><span class="badge b-mvp">MVP</span></td>
      </tr>
      <tr>
        <td class="feat-id">CB-05</td>
        <td class="feat-name">Tag-Based Conditions</td>
        <td class="feat-desc">Conditions that check for the presence, absence or value of player tags set earlier in the same journey or from external systems.</td>
        <td class="feat-ux">Tag name autocomplete from existing tag catalogue. Has/Does Not Have operators. Value match for tagged values.</td>
        <td><span class="badge b-mvp">MVP</span></td>
      </tr>
      <tr>
        <td class="feat-id">CB-06</td>
        <td class="feat-name">Pulled Data Conditions</td>
        <td class="feat-desc">Conditions that reference data fetched by an upstream Pull Data Node in the same journey. Enables real-time data enrichment to drive routing decisions.</td>
        <td class="feat-ux">Field reference picker shows available pulled fields from upstream nodes. Clearly labelled with source node name.</td>
        <td><span class="badge b-mvp">MVP</span></td>
      </tr>
      <tr>
        <td class="feat-id">CB-07</td>
        <td class="feat-name">AND / OR Logic Groups</td>
        <td class="feat-desc">Conditions can be grouped with AND (all must be true) or OR (any must be true) logic. Groups can be nested for complex eligibility rules.</td>
        <td class="feat-ux">Toggle button between each row changes AND/OR. Visual indent for groups. Plain-language summary shown below builder.</td>
        <td><span class="badge b-phase2">Phase 2</span></td>
      </tr>
      <tr>
        <td class="feat-id">CB-08</td>
        <td class="feat-name">Condition Preview / Plain Language</td>
        <td class="feat-desc">Live plain-language summary of the condition logic built so far. Helps non-technical admins verify the rule reads as intended before saving.</td>
        <td class="feat-ux">Auto-generated sentence below builder. Updates in real time. e.g. "Player has deposited in the last 7 days AND VIP level is Gold or above".</td>
        <td><span class="badge b-phase2">Phase 2</span></td>
      </tr>
    </tbody>
  </table>
</div>


<!-- ══════════════════════════════════════════
     SECTION 5: ACTIVITY NODES
══════════════════════════════════════════ -->
<div class="section">
  <div class="section-header">
    <div class="section-color" style="background:var(--c-activity)"></div>
    <span class="section-title" style="color:var(--c-activity)">Activity Nodes</span>
    <span class="section-count">6 features</span>
    <span class="section-zone">Zone ② Node Palette → Activities</span>
  </div>
  <table>
    <thead><tr><th>#</th><th>Feature</th><th>Description</th><th>UX Behaviour</th><th>Status</th></tr></thead>
    <tbody>
      <tr>
        <td class="feat-id">A-01</td>
        <td class="feat-name">Bonus Award</td>
        <td class="feat-desc">Grants a bonus to the player at that point in the journey. Supports Free Spins, Deposit Match, Cash Bonus, and Loyalty Points. Configurable amount and expiry.</td>
        <td class="feat-ux">Bonus type picker + amount + expiry hours. Preview of bonus value shown on node face.</td>
        <td><span class="badge b-mvp">MVP</span></td>
      </tr>
      <tr>
        <td class="feat-id">A-02</td>
        <td class="feat-name">Leaderboard Enrol / Remove</td>
        <td class="feat-desc">Adds or removes the player from a specified leaderboard at that step. Enables dynamic leaderboard participation triggered by journey logic rather than manual batch enrolment.</td>
        <td class="feat-ux">Action picker (Add/Remove) + leaderboard name selector from existing catalogue.</td>
        <td><span class="badge b-mvp">MVP</span></td>
      </tr>
      <tr>
        <td class="feat-id">A-03</td>
        <td class="feat-name">Mission Enrol / Remove</td>
        <td class="feat-desc">Adds or removes the player from a specific mission. Lets journey logic gate mission access — e.g. only enrol VIP players who deposited this week.</td>
        <td class="feat-ux">Action picker + mission selector. Mission status shown on node face label.</td>
        <td><span class="badge b-mvp">MVP</span></td>
      </tr>
      <tr>
        <td class="feat-id">A-04</td>
        <td class="feat-name">Tournament Enrol / Remove</td>
        <td class="feat-desc">Adds or removes the player from a tournament. Enables conditional tournament enrolment as part of a larger campaign flow.</td>
        <td class="feat-ux">Action picker + tournament selector. Integration with tournament management system.</td>
        <td><span class="badge b-mvp">MVP</span></td>
      </tr>
      <tr>
        <td class="feat-id">A-05</td>
        <td class="feat-name">Player Tag Write</td>
        <td class="feat-desc">Writes or removes a custom data attribute on the player profile at runtime. Tags persist across sessions and are queryable by future journeys or analytics. No engineering changes needed.</td>
        <td class="feat-ux">Action (Add/Remove) + tag name input + optional tag value. Tag persists across sessions.</td>
        <td><span class="badge b-mvp">MVP</span></td>
      </tr>
      <tr>
        <td class="feat-id">A-06</td>
        <td class="feat-name">Game Skin Activation</td>
        <td class="feat-desc">Triggers a personalised game skin or theme for the player's session as part of the journey reward. Enhances the in-session experience contextually.</td>
        <td class="feat-ux">Skin selector from available catalogue. Preview thumbnail shown. Duration option (session only vs permanent).</td>
        <td><span class="badge b-phase2">Phase 2</span></td>
      </tr>
    </tbody>
  </table>
</div>


<!-- ══════════════════════════════════════════
     SECTION 6: COMMUNICATIONS
══════════════════════════════════════════ -->
<div class="section">
  <div class="section-header">
    <div class="section-color" style="background:var(--c-comms)"></div>
    <span class="section-title" style="color:var(--c-comms)">Communication Nodes</span>
    <span class="section-count">7 features</span>
    <span class="section-zone">Zone ② Node Palette → Comms</span>
  </div>
  <table>
    <thead><tr><th>#</th><th>Feature</th><th>Description</th><th>UX Behaviour</th><th>Status</th></tr></thead>
    <tbody>
      <tr>
        <td class="feat-id">CM-01</td>
        <td class="feat-name">Player Real-Time Message</td>
        <td class="feat-desc">Sends an in-product message to the player as the journey executes. Appears within the gaming session without interrupting play. Most immediate and contextual message type.</td>
        <td class="feat-ux">Presentation type picker: Overlay / Big Toast / Small Toast / Pic in Pic / Lobby Banner. Priority selector. Template picker.</td>
        <td><span class="badge b-mvp">MVP</span></td>
      </tr>
      <tr>
        <td class="feat-id">CM-02</td>
        <td class="feat-name">Email</td>
        <td class="feat-desc">Sends an email to the player. Template-based with dynamic personalisation fields populated from player data. Send timing configurable.</td>
        <td class="feat-ux">Template selector + subject preview + personalisation token list. Send-time config (immediate or delayed).</td>
        <td><span class="badge b-mvp">MVP</span></td>
      </tr>
      <tr>
        <td class="feat-id">CM-03</td>
        <td class="feat-name">SMS</td>
        <td class="feat-desc">Sends a text message to the player's registered mobile number. Short-form, high-urgency channel for time-sensitive offers or alerts.</td>
        <td class="feat-ux">Template selector + character count indicator. Opt-out compliance check automatic.</td>
        <td><span class="badge b-mvp">MVP</span></td>
      </tr>
      <tr>
        <td class="feat-id">CM-04</td>
        <td class="feat-name">Push Notification</td>
        <td class="feat-desc">Sends a mobile push to the player's device. Reaches players outside the active session. Supports deep-link routing to specific app pages.</td>
        <td class="feat-ux">Title + body fields. Deep-link destination picker. Preview of push on mock device.</td>
        <td><span class="badge b-mvp">MVP</span></td>
      </tr>
      <tr>
        <td class="feat-id">CM-05</td>
        <td class="feat-name">WhatsApp</td>
        <td class="feat-desc">Sends a WhatsApp message to the player using pre-approved template messages per platform compliance. High open-rate channel for key engagement moments.</td>
        <td class="feat-ux">Approved template picker only. Opt-in status check before node accepts placement.</td>
        <td><span class="badge b-phase2">Phase 2</span></td>
      </tr>
      <tr>
        <td class="feat-id">CM-06</td>
        <td class="feat-name">Slack (Internal Alert)</td>
        <td class="feat-desc">Sends an internal Slack notification to a business owner or team channel — not to the player. Used for operational alerts: VIP issues, offer refusal spikes, deposit failures.</td>
        <td class="feat-ux">Channel selector + message template + trigger condition summary. Clearly marked "Internal" with team icon.</td>
        <td><span class="badge b-mvp">MVP</span></td>
      </tr>
      <tr>
        <td class="feat-id">CM-07</td>
        <td class="feat-name">Communication Priority Matrix</td>
        <td class="feat-desc">Defines which presentation format takes priority when multiple messages compete for the player's attention simultaneously.
          <ul class="sub-items">
            <li>Sales (P1): Overlay → Big Toast → Lobby Banner</li>
            <li>Compliance (P1): Big Toast → Small Toast → Inbox</li>
            <li>Campaign Update (P2): Small Toast → Pic in Pic → Inbox</li>
            <li>Follow-up (P3): Overlay → Small Toast → Lobby Banner</li>
          </ul>
        </td>
        <td class="feat-ux">Priority selector per comms node. Conflict warning if two high-priority nodes could fire simultaneously.</td>
        <td><span class="badge b-phase2">Phase 2</span></td>
      </tr>
    </tbody>
  </table>
</div>


<!-- ══════════════════════════════════════════
     SECTION 7: PLAYER DATA NODES
══════════════════════════════════════════ -->
<div class="section">
  <div class="section-header">
    <div class="section-color" style="background:var(--c-data)"></div>
    <span class="section-title" style="color:var(--c-data)">Player Data Nodes</span>
    <span class="section-count">2 features</span>
    <span class="section-zone">Zone ② Node Palette → Player Data</span>
  </div>
  <table>
    <thead><tr><th>#</th><th>Feature</th><th>Description</th><th>UX Behaviour</th><th>Status</th></tr></thead>
    <tbody>
      <tr>
        <td class="feat-id">PD-01</td>
        <td class="feat-name">Add / Remove Player Tag</td>
        <td class="feat-desc">Writes or removes a custom data attribute on a player profile at that point in the journey. Tags created here are available as conditions in downstream nodes or future journeys.</td>
        <td class="feat-ux">Action (Add/Remove) + tag name input + optional value. Tag persists across sessions.</td>
        <td><span class="badge b-mvp">MVP</span></td>
      </tr>
      <tr>
        <td class="feat-id">PD-02</td>
        <td class="feat-name">Pull Data Node</td>
        <td class="feat-desc">Fetches a player data attribute at runtime — from real-time event stream or historical DWH. Makes the value available for conditions and personalisation in downstream nodes.</td>
        <td class="feat-ux">Source picker (Real-time / Historical) + field selector. Output port labelled with field name.</td>
        <td><span class="badge b-mvp">MVP</span></td>
      </tr>
    </tbody>
  </table>
</div>


<!-- ══════════════════════════════════════════
     SECTION 8: MONITORING & REPORTING
══════════════════════════════════════════ -->
<div class="section">
  <div class="section-header">
    <div class="section-color" style="background:var(--c-monitor)"></div>
    <span class="section-title" style="color:var(--c-monitor)">Monitoring & Reporting</span>
    <span class="section-count">4 features</span>
    <span class="section-zone">Zone ⑤ Monitoring Bar</span>
  </div>
  <table>
    <thead><tr><th>#</th><th>Feature</th><th>Description</th><th>UX Behaviour</th><th>Status</th></tr></thead>
    <tbody>
      <tr>
        <td class="feat-id">M-01</td>
        <td class="feat-name">Live Heat Map</td>
        <td class="feat-desc">Overlays real-time player counts on each canvas node — showing exactly how many players are at each step of the journey at any moment.</td>
        <td class="feat-ux">Number badge on each node. Colour intensity scales with volume. Toggle heat map on/off in toolbar.</td>
        <td><span class="badge b-mvp">MVP</span></td>
      </tr>
      <tr>
        <td class="feat-id">M-02</td>
        <td class="feat-name">Campaign Reporting</td>
        <td class="feat-desc">Detailed analytics: player counts per node, conversion rates per branch, time-in-step distribution, projected LTV impact.</td>
        <td class="feat-ux">Side drawer or dedicated report view. Per-node drill-down. Exportable.</td>
        <td><span class="badge b-phase2">Phase 2</span></td>
      </tr>
      <tr>
        <td class="feat-id">M-03</td>
        <td class="feat-name">Internal Alerts (Slack)</td>
        <td class="feat-desc">Automated Slack notifications when campaign anomalies are detected — VIP deposit failures, high offer refusal rates, system errors mid-journey.</td>
        <td class="feat-ux">Alert config in Slack node. Threshold setter (e.g. >20% refusal rate). Alert log in monitoring bar.</td>
        <td><span class="badge b-mvp">MVP</span></td>
      </tr>
      <tr>
        <td class="feat-id">M-04</td>
        <td class="feat-name">Import / Export Journey</td>
        <td class="feat-desc">Saves the full journey definition as a JSON file and allows re-importing it. Enables cross-environment migration, templates and version archiving.</td>
        <td class="feat-ux">Export button → downloads JSON. Import → file picker, canvas reloads with imported journey. Versioned filename with timestamp.</td>
        <td><span class="badge b-mvp">MVP</span></td>
      </tr>
    </tbody>
  </table>
</div>


<!-- ══════════════════════════════════════════
     DIVIDER: SUPPORTING DEVELOPMENTS
══════════════════════════════════════════ -->
<div class="divider">
  <div class="divider-line"></div>
  <div class="divider-label">Supporting Infrastructure & Platform Development</div>
  <div class="divider-line"></div>
</div>

<p style="font-family:'DM Mono',monospace;font-size:11px;color:var(--muted);margin-bottom:24px;line-height:1.7;max-width:760px">
  The items below are engineering and infrastructure work required to support the Olives Builder in production. These are platform-level developments — not features within the builder UI itself — but are required for the builder to function in a live environment.
</p>


<!-- ══════════════════════════════════════════
     SECTION 9: SUPPORTING DEVELOPMENTS
══════════════════════════════════════════ -->
<div class="section">
  <div class="section-header">
    <div class="section-color" style="background:var(--c-support)"></div>
    <span class="section-title" style="color:var(--c-support)">Supporting Infrastructure</span>
    <span class="section-count">9 items</span>
    <span class="section-zone">Platform Engineering</span>
  </div>
  <table>
    <thead><tr><th>#</th><th>Item</th><th>Description</th><th>Dependencies / Notes</th><th>Priority</th></tr></thead>
    <tbody>
      <tr class="support-row">
        <td class="feat-id">INF-01</td>
        <td class="feat-name">Kafka Broker Setup</td>
        <td class="feat-desc">Build and configure a Kafka message broker with the topics required to stream real-time player events into the journey engine. Topics needed: player.events (login, deposit, bet, game-round), player.page-views, player.session, system.alerts.</td>
        <td class="feat-ux">Required by: Real-Time Trigger (T-01), Event Split (F-02), Pull Data Node (F-05, PD-02). Must support consumer groups per journey instance. Retention: 7 days minimum.</td>
        <td><span class="badge b-infra">INFRA</span> <span class="badge b-mvp">MVP</span></td>
      </tr>
      <tr class="support-row">
        <td class="feat-id">INF-02</td>
        <td class="feat-name">Player Data API</td>
        <td class="feat-desc">Build an internal REST/GraphQL API that the journey engine calls to pull player profile data, behavioural history and segment membership at runtime. Must support low-latency reads for in-journey use.</td>
        <td class="feat-ux">Required by: Pull Data Node (F-05, PD-02), Condition Builder player attributes (CB-02, CB-03). Target SLA: &lt;100ms p99. Endpoints: /player/{id}/profile, /player/{id}/events, /player/{id}/tags.</td>
        <td><span class="badge b-infra">INFRA</span> <span class="badge b-mvp">MVP</span></td>
      </tr>
      <tr class="support-row">
        <td class="feat-id">INF-03</td>
        <td class="feat-name">Journey Execution Engine</td>
        <td class="feat-desc">Server-side engine that reads the journey graph (exported JSON), subscribes to relevant Kafka topics, and executes node logic per player in real time. Stateful — tracks each player's current position in the journey.</td>
        <td class="feat-ux">Required by all journey features. Must handle concurrent player instances per journey. State stored per player per journey. Supports pause/resume of individual journeys.</td>
        <td><span class="badge b-infra">INFRA</span> <span class="badge b-mvp">MVP</span></td>
      </tr>
      <tr class="support-row">
        <td class="feat-id">INF-04</td>
        <td class="feat-name">Journey Persistence API</td>
        <td class="feat-desc">API layer for saving, loading, versioning and publishing journey definitions. Stores the full node/edge graph and campaign metadata. Supports draft, active, paused and completed states.</td>
        <td class="feat-ux">Required by: Campaign Manager homepage (CS-01), Import/Export (M-04), Canvas save. Endpoints: POST /journeys, GET /journeys/{id}, PUT /journeys/{id}/publish, GET /journeys (list). Versioned — keeps history of published states.</td>
        <td><span class="badge b-infra">INFRA</span> <span class="badge b-mvp">MVP</span></td>
      </tr>
      <tr class="support-row">
        <td class="feat-id">INF-05</td>
        <td class="feat-name">Bonus Issuance Integration</td>
        <td class="feat-desc">Integration with the bonus management system to issue Free Spins, Deposit Match, Cash Bonus and Loyalty Points from within a journey. Journey engine calls the bonus API when a Bonus Award node executes.</td>
        <td class="feat-ux">Required by: Bonus Award node (A-01). Must handle duplicate-issue prevention. Callback/webhook when bonus is accepted or declined by the player (feeds into Event Split logic).</td>
        <td><span class="badge b-infra">INFRA</span> <span class="badge b-mvp">MVP</span></td>
      </tr>
      <tr class="support-row">
        <td class="feat-id">INF-06</td>
        <td class="feat-name">Communications Dispatch Service</td>
        <td class="feat-desc">Unified service that receives send-message instructions from the journey engine and dispatches them to the correct channel provider — ESP (email), SMS gateway, push notification service, in-product message bus, or Slack webhook.</td>
        <td class="feat-ux">Required by: All comms nodes (CM-01 to CM-06). Must handle channel opt-out checks, rate limiting, and deduplication within a session. Delivery receipts fed back to journey engine for event-based wait nodes.</td>
        <td><span class="badge b-infra">INFRA</span> <span class="badge b-mvp">MVP</span></td>
      </tr>
      <tr class="support-row">
        <td class="feat-id">INF-07</td>
        <td class="feat-name">Player Tag Write API</td>
        <td class="feat-desc">API endpoint that the journey engine calls to write, update or remove custom player tags on the player profile in real time. Tags must be immediately queryable by downstream journey conditions.</td>
        <td class="feat-ux">Required by: Player Tag Write node (A-05, PD-01). Endpoint: PUT /player/{id}/tags. Must be synchronous — condition evaluation happens in the same execution tick. Tag namespace per tenant.</td>
        <td><span class="badge b-infra">INFRA</span> <span class="badge b-mvp">MVP</span></td>
      </tr>
      <tr class="support-row">
        <td class="feat-id">INF-08</td>
        <td class="feat-name">Leaderboard / Mission / Tournament API</td>
        <td class="feat-desc">Integration APIs connecting the journey engine to the gamification management systems. Enables enrol/remove operations on leaderboards, missions and tournaments from within a journey execution.</td>
        <td class="feat-ux">Required by: Activity nodes A-02, A-03, A-04. Three separate integration points — each with enrol and remove endpoints. Must return confirmation of enrolment for use by downstream conditions.</td>
        <td><span class="badge b-infra">INFRA</span> <span class="badge b-phase2">Phase 2</span></td>
      </tr>
      <tr class="support-row">
        <td class="feat-id">INF-09</td>
        <td class="feat-name">Analytics & Metrics Pipeline</td>
        <td class="feat-desc">Data pipeline that collects per-node player counts, conversion events, and time-in-step metrics from the journey execution engine and makes them available for the live heat map and campaign reporting features.</td>
        <td class="feat-ux">Required by: Live Heat Map (M-01), Campaign Reporting (M-02). Real-time stream to live heat map (WebSocket or polling). Batch aggregation to reporting database. Retention: 90 days per campaign.</td>
        <td><span class="badge b-infra">INFRA</span> <span class="badge b-phase2">Phase 2</span></td>
      </tr>
    </tbody>
  </table>
</div>
</div>

<!-- ══════════════════════════════════════
     ROUTER SCRIPT
══════════════════════════════════════ -->
<script>
var currentPage = 'launcher';
var canvasMode = '';

function showPage(page, mode) {
  // Hide all
  ['launcher','home','canvas','features'].forEach(function(p) {
    var el = document.getElementById('page-' + p);
    if (el) el.classList.remove('active');
  });

  // Show target
  var target = document.getElementById('page-' + page);
  if (target) target.classList.add('active');
  currentPage = page;

  // Canvas init
  if (page === 'canvas') {
    canvasMode = mode || '';
    setTimeout(function() {
      if (typeof initCanvas === 'function') {
        initCanvas(canvasMode);
      }
    }, 50);
  }

  // Reset scroll for features
  if (page === 'features') {
    document.getElementById('page-features').scrollTop = 0;
  }
}

// Start on launcher
showPage('launcher');
</script>

<!-- ══ HOME JS ══ -->
<script>

// ── DATA ──
const JOURNEYS = [
  // ACTIVE
  {id:1, group:'active', name:'Summer Re-engagement Q3', category:'Reactivation', type:'realtime', status:'live',
   players:8420, completed:3102, conv:'36.8%', updated:'2 hours ago',
   spark:[30,45,60,55,70,85,90,75,88,95]},
  {id:2, group:'active', name:'VIP Tier Upgrade — Diamond', category:'Retention', type:'realtime', status:'live',
   players:1203, completed:441, conv:'36.7%', updated:'5 hours ago',
   spark:[20,25,30,28,40,52,48,60,55,70]},
  {id:3, group:'active', name:'First Deposit Welcome Flow', category:'Acquisition', type:'schedule', status:'live',
   players:5614, completed:2300, conv:'41.0%', updated:'1 day ago',
   spark:[60,65,70,68,75,80,78,82,85,90]},
  {id:4, group:'active', name:'Tournament Finals Push', category:'Conversion', type:'realtime', status:'paused',
   players:2890, completed:870, conv:'30.1%', updated:'3 days ago',
   spark:[80,75,70,65,60,55,50,48,45,40]},
  {id:5, group:'active', name:'Weekend Cashback Offer', category:'Retention', type:'schedule', status:'live',
   players:4120, completed:1654, conv:'40.1%', updated:'6 hours ago',
   spark:[40,50,60,70,65,80,75,85,90,88]},

  // IN DESIGN
  {id:6, group:'design', name:'Lapsed 60-Day Winback', category:'Reactivation', type:'realtime', status:'design',
   players:0, nodes:14, progress:'72%', updated:'Today, 11:42am'},
  {id:7, group:'design', name:'Mission Completion Bonus', category:'Retention', type:'schedule', status:'draft',
   players:0, nodes:7, progress:'40%', updated:'Yesterday'},
  {id:8, group:'design', name:'New Game Launch Campaign', category:'Conversion', type:'realtime', status:'design',
   players:0, nodes:11, progress:'85%', updated:'2 days ago'},
  {id:9, group:'design', name:'Referral Reward Journey', category:'Acquisition', type:'realtime', status:'draft',
   players:0, nodes:4, progress:'20%', updated:'4 days ago'},

  // COMPLETED
  {id:10, group:'completed', name:'Spring Tournament Series', category:'Conversion', type:'realtime', status:'done',
   players:11240, completed:4320, conv:'38.4%', updated:'Jun 30, 2025'},
  {id:11, group:'completed', name:'Easter Re-engagement Blast', category:'Reactivation', type:'schedule', status:'done',
   players:6780, completed:2103, conv:'31.0%', updated:'Apr 14, 2025'},
  {id:12, group:'completed', name:'January VIP Kickoff', category:'Retention', type:'realtime', status:'done',
   players:3410, completed:1560, conv:'45.7%', updated:'Jan 31, 2025'},
];

let activeFilter = 'all';
let searchQuery = '';

// ── CATEGORY COLOURS ──
const catColors = {
  Acquisition:'rgba(74,222,128,0.1)', Conversion:'rgba(96,165,250,0.1)',
  Retention:'rgba(167,139,250,0.1)',  Reactivation:'rgba(245,158,11,0.08)',
  General:'rgba(74,85,104,0.2)'
};
const catText = {
  Acquisition:'var(--accent)', Conversion:'var(--blue)',
  Retention:'var(--purple)',   Reactivation:'var(--amber)',
  General:'var(--text3)'
};
const typeIcon = {realtime:'⚡', schedule:'📅'};

// ── STATUS BADGES ──
function statusBadge(s) {
  const map = {
    live:    ['s-live',    '●', 'Live'],
    paused:  ['s-paused',  '●', 'Paused'],
    design:  ['s-design',  '●', 'In Design'],
    draft:   ['s-draft',   '●', 'Draft'],
    done:    ['s-done',    '●', 'Completed'],
    blocked: ['s-blocked', '●', 'Blocked'],
  };
  const [cls, dot, label] = map[s] || ['s-draft','●','Unknown'];
  return `<span class="status-badge ${cls}"><span class="status-dot"></span>${label}</span>`;
}

// ── SPARKLINE ──
function sparkline(data) {
  if (!data) return '';
  const max = Math.max(...data);
  return `<div class="sparkline">${data.map(v => {
    const h = Math.max(3, Math.round((v/max)*24));
    const opacity = 0.3 + (v/max)*0.7;
    return `<div class="spark-bar" style="height:${h}px;opacity:${opacity}"></div>`;
  }).join('')}</div>`;
}

// ── 3-DOT MENU HTML ──
function dotMenu(j) {
  const isLive   = j.status === 'live';
  const isPaused = j.status === 'paused';
  const isDone   = j.status === 'done';
  const isDesign = j.status === 'design' || j.status === 'draft';

  let items = `
    <button class="dot-menu-item" onclick="goToCanvas(${j.id})">
      <span class="mi-icon">🖊</span> Open in Canvas
    </button>`;

  if (isDesign) items += `
    <button class="dot-menu-item" onclick="activateJourney(${j.id})">
      <span class="mi-icon">▶</span> Activate
    </button>`;

  if (isLive) items += `
    <button class="dot-menu-item" onclick="pauseJourney(${j.id})">
      <span class="mi-icon">⏸</span> Pause
    </button>`;

  if (isPaused) items += `
    <button class="dot-menu-item" onclick="resumeJourney(${j.id})">
      <span class="mi-icon">▶</span> Resume
    </button>`;

  if (!isDone) items += `
    <button class="dot-menu-item" onclick="completeJourney(${j.id})">
      <span class="mi-icon">✓</span> Mark Complete
    </button>`;

  items += `
    <button class="dot-menu-item" onclick="duplicateJourney(${j.id})">
      <span class="mi-icon">⧉</span> Duplicate
    </button>`;

  if (!isDesign && !isDone) items += `
    <button class="dot-menu-item" onclick="blockJourney(${j.id})">
      <span class="mi-icon">🚫</span> Block
    </button>`;

  items += `<div class="dot-menu-sep"></div>
    <button class="dot-menu-item danger" onclick="deleteJourney(${j.id})">
      <span class="mi-icon">🗑</span> Delete
    </button>`;

  return `<div class="dot-menu-wrap">
    <button class="dot-btn" onclick="toggleMenu(event,${j.id})" id="dotbtn-${j.id}">•••</button>
    <div class="dot-menu" id="menu-${j.id}">${items}</div>
  </div>`;
}

// ── RENDER ROW (active/completed) ──
function renderActiveRow(j) {
  const icon = typeIcon[j.type] || '⚡';
  return `
  <tr class="journey-row" id="row-${j.id}">
    <td><div class="row-cell">
      <div class="journey-name-cell">
        <div class="journey-type-icon" style="background:${catColors[j.category]}">
          <span style="color:${catText[j.category]}">${icon}</span>
        </div>
        <div class="journey-info">
          <span class="journey-name" onclick="goToCanvas(${j.id})">${j.name}</span>
          <div class="journey-meta">
            <span class="journey-cat" style="background:${catColors[j.category]};color:${catText[j.category]}">${j.category}</span>
          </div>
        </div>
      </div>
    </div></td>
    <td><div class="row-cell">${statusBadge(j.status)}</div></td>
    <td><div class="row-cell">
      <div class="stat-cell">
        ${j.players.toLocaleString()}
        <span class="sub">in journey</span>
      </div>
    </div></td>
    <td><div class="row-cell">
      <div class="stat-cell">
        ${j.completed.toLocaleString()}
        <span class="sub">finished</span>
      </div>
    </div></td>
    <td><div class="row-cell">
      <div class="stat-cell" style="color:var(--accent)">${j.conv}</div>
    </div></td>
    <td><div class="row-cell">
      <div style="display:flex;flex-direction:column;gap:6px">
        <div style="font-size:11px;color:var(--text3)">${j.updated}</div>
        ${sparkline(j.spark)}
      </div>
    </div></td>
    <td><div class="row-cell" style="justify-content:flex-end">${dotMenu(j)}</div></td>
  </tr>
  <tr class="journey-row-spacer"><td colspan="7"></td></tr>`;
}

function renderDesignRow(j) {
  const icon = typeIcon[j.type] || '⚡';
  const pct = parseInt(j.progress);
  return `
  <tr class="journey-row" id="row-${j.id}">
    <td><div class="row-cell">
      <div class="journey-name-cell">
        <div class="journey-type-icon" style="background:${catColors[j.category]}">
          <span style="color:${catText[j.category]}">${icon}</span>
        </div>
        <div class="journey-info">
          <span class="journey-name" onclick="goToCanvas(${j.id})">${j.name}</span>
          <div class="journey-meta">
            <span class="journey-cat" style="background:${catColors[j.category]};color:${catText[j.category]}">${j.category}</span>
          </div>
        </div>
      </div>
    </div></td>
    <td><div class="row-cell">${statusBadge(j.status)}</div></td>
    <td><div class="row-cell"><div class="stat-cell" style="color:var(--text3)">—<span class="sub">not live yet</span></div></div></td>
    <td><div class="row-cell"><div class="stat-cell">${j.nodes}<span class="sub">nodes built</span></div></div></td>
    <td><div class="row-cell">
      <div style="display:flex;flex-direction:column;gap:5px;width:80px">
        <div style="font-size:11px;color:var(--text2);font-weight:600">${j.progress}</div>
        <div style="height:4px;background:var(--border2);border-radius:2px;overflow:hidden">
          <div style="height:100%;width:${pct}%;background:linear-gradient(90deg,var(--blue),var(--accent));border-radius:2px"></div>
        </div>
      </div>
    </div></td>
    <td><div class="row-cell"><div style="font-size:11px;color:var(--text3)">${j.updated}</div></div></td>
    <td><div class="row-cell" style="justify-content:flex-end">${dotMenu(j)}</div></td>
  </tr>
  <tr class="journey-row-spacer"><td colspan="7"></td></tr>`;
}

function renderCompletedRow(j) {
  return renderActiveRow(j); // same structure
}

// ── RENDER ALL ──
function renderAll() {
  const q = searchQuery.toLowerCase();
  const f = activeFilter;

  const groups = {active:[], design:[], completed:[]};
  JOURNEYS.forEach(j => {
    if (q && !j.name.toLowerCase().includes(q)) return;
    if (f !== 'all' && j.group !== f) return;
    groups[j.group].push(j);
  });

  ['active','design','completed'].forEach(g => {
    const tbody = document.getElementById('tbody-' + g);
    const section = document.getElementById('section-' + g);
    const countEl = document.getElementById('count-' + g);
    const list = groups[g];

    section.style.display = (f === 'all' || f === g) ? '' : 'none';
    countEl.textContent = list.length;

    if (list.length === 0) {
      tbody.innerHTML = `<tr><td colspan="7">
        <div class="empty-state">
          <div class="empty-icon">${g==='active'?'📭':g==='design'?'✏️':'📦'}</div>
          <div class="empty-title">No ${g==='active'?'active':g==='design'?'in-design':'completed'} campaigns</div>
          <div class="empty-sub">${g==='design'?'Start building a new journey using the button above.':'No campaigns in this state yet.'}</div>
        </div>
      </td></tr>`;
      return;
    }

    tbody.innerHTML = list.map(j =>
      g === 'design' ? renderDesignRow(j) : renderActiveRow(j)
    ).join('');
  });
}

// ── FILTERS ──
function setFilter(f, btn) {
  activeFilter = f;
  document.querySelectorAll('.filter-pill').forEach(p => p.classList.remove('active'));
  btn.classList.add('active');
  renderAll();
}

function filterJourneys(q) {
  searchQuery = q;
  renderAll();
}

function sortJourneys(by) {
  if (by === 'name') JOURNEYS.sort((a,b) => a.name.localeCompare(b.name));
  else if (by === 'players') JOURNEYS.sort((a,b) => (b.players||0) - (a.players||0));
  renderAll();
}

// ── 3-DOT MENU ──
let openMenuId = null;

function toggleMenu(e, id) {
  e.stopPropagation();
  const menu = document.getElementById('menu-' + id);
  const btn  = document.getElementById('dotbtn-' + id);
  if (openMenuId && openMenuId !== id) closeAllMenus();
  const isOpen = menu.classList.contains('open');
  closeAllMenus();
  if (!isOpen) {
    menu.classList.add('open');
    btn.classList.add('open');
    openMenuId = id;
  }
}

function closeAllMenus() {
  document.querySelectorAll('.dot-menu').forEach(m => m.classList.remove('open'));
  document.querySelectorAll('.dot-btn').forEach(b => b.classList.remove('open'));
  openMenuId = null;
}
document.addEventListener('click', closeAllMenus);

// ── ACTIONS ──
function goToCanvas(id) {
  closeAllMenus();
  const j = JOURNEYS.find(x => x.id === id);
  if (!j) return;
  // Templates open with demo data; regular journeys open empty canvas
  const isTemplate = j.fromTemplate;
  showPage('canvas', isTemplate ? 'demo' : '');
}

function activateJourney(id) {
  closeAllMenus();
  const j = JOURNEYS.find(x => x.id === id);
  if (!j) return;
  if (confirm(`Activate "${j.name}"?\nThis will move it to Active and start accepting players.`)) {
    j.group = 'active'; j.status = 'live'; j.players = 0; j.completed = 0; j.conv = '—';
    j.updated = 'Just now'; j.spark = [10,10,10,10,10,10,10,10,10,10];
    renderAll(); toast('✓ Campaign activated and now live');
  }
}

function pauseJourney(id) {
  closeAllMenus();
  const j = JOURNEYS.find(x => x.id === id);
  if (j) { j.status = 'paused'; j.updated = 'Just now'; renderAll(); toast('⏸ Campaign paused'); }
}

function resumeJourney(id) {
  closeAllMenus();
  const j = JOURNEYS.find(x => x.id === id);
  if (j) { j.status = 'live'; j.updated = 'Just now'; renderAll(); toast('▶ Campaign resumed'); }
}

function completeJourney(id) {
  closeAllMenus();
  const j = JOURNEYS.find(x => x.id === id);
  if (!j) return;
  if (confirm(`Mark "${j.name}" as completed? It will move to the Completed section.`)) {
    j.group = 'completed'; j.status = 'done'; j.updated = new Date().toLocaleDateString();
    renderAll(); toast('✓ Campaign marked complete');
  }
}

function blockJourney(id) {
  closeAllMenus();
  const j = JOURNEYS.find(x => x.id === id);
  if (!j) return;
  if (confirm(`Block "${j.name}"?\nThis will immediately stop all player entries and pause the journey.`)) {
    j.status = 'blocked'; j.updated = 'Just now'; renderAll(); toast('🚫 Campaign blocked');
  }
}

function duplicateJourney(id) {
  closeAllMenus();
  const j = JOURNEYS.find(x => x.id === id);
  if (!j) return;
  const copy = {...j, id: Date.now(), name: j.name + ' (Copy)', status:'draft', group:'design', players:0, nodes: j.nodes||8, progress:'10%', updated:'Just now'};
  JOURNEYS.push(copy);
  renderAll(); toast('⧉ Campaign duplicated — find it in In Design');
}

function deleteJourney(id) {
  closeAllMenus();
  const j = JOURNEYS.find(x => x.id === id);
  if (!j) return;
  if (confirm(`Delete "${j.name}"?\n\nThis cannot be undone.`)) {
    const idx = JOURNEYS.findIndex(x => x.id === id);
    if (idx !== -1) JOURNEYS.splice(idx, 1);
    renderAll(); toast('🗑 Campaign deleted');
  }
}

function createNew() { openSetup(); }

// ── TEMPLATE MODAL ──
function openTemplates() {
  document.getElementById('templateModal').classList.add('open');
}
function closeTemplates(e) {
  if (!e || e.target === document.getElementById('templateModal')) {
    document.getElementById('templateModal').classList.remove('open');
  }
}
function useTemplate(name) {
  document.getElementById('templateModal').classList.remove('open');
  openSetup(name, true);
}

// ══════════════════════════════════════════════════
//  CAMPAIGN SETUP OVERLAY
// ══════════════════════════════════════════════════
let setupFromTemplate = false;

function openSetup(templateName, fromTemplate) {
  setupFromTemplate = !!fromTemplate;
  document.getElementById('setupOverlay').classList.add('open');
  document.body.style.overflow = 'hidden';
  setupStep = 1;
  setupUpdateUI();
  const today = new Date().toISOString().split('T')[0];
  document.getElementById('su-startDate').value = today;
  if (templateName) {
    document.getElementById('su-campaignName').value = templateName + ' Campaign';
    suCountChars('su-campaignName','su-nameCount',250);
  } else {
    document.getElementById('su-campaignName').value = '';
    suCountChars('su-campaignName','su-nameCount',250);
  }
}
function closeSetup() {
  document.getElementById('setupOverlay').classList.remove('open');
  document.body.style.overflow = '';
}

// ── SETUP STATE ──
let setupStep = 1;
let suOngoing = false, suDemo = false;
let suEntryType = 'single', suReentry = false, suInterval = 'always', suCooldown = '1w';
let suActiveDays = new Set();

function setupUpdateUI() {
  // screens
  document.querySelectorAll('.su-screen').forEach((s,i) => s.classList.toggle('active', i+1 === setupStep));
  // sidebar dots
  for (let i = 1; i <= 3; i++) {
    const el  = document.getElementById('su-step'+i);
    const dot = document.getElementById('su-dot'+i);
    el.classList.remove('active','done');
    if (i < setupStep)       { el.classList.add('done');   dot.textContent = '✓'; }
    else if (i === setupStep){ el.classList.add('active'); dot.textContent = i;   }
    else                     { dot.textContent = i; }
  }
  // progress
  const pct = Math.round(((setupStep-1)/2)*100);
  document.getElementById('su-progressFill').style.width = pct + '%';
  document.getElementById('su-progressLabel').textContent = `Step ${Math.min(setupStep,2)} of 2`;
  // breadcrumb
  const labels = ['Campaign Info','Participation Rules','Journey Canvas'];
  document.getElementById('su-breadcrumb').textContent = labels[setupStep-1] || 'New Campaign';
  // next button
  const nb = document.getElementById('su-nextBtn');
  nb.style.display = setupStep === 1 ? '' : 'none';
  // scroll to top
  const content = document.getElementById('su-content');
  if (content) content.scrollTop = 0;
}

function suNext() {
  if (setupStep === 1) {
    if (!suValidate1()) return;
    setupStep = 2; setupUpdateUI();
  }
}
function suPrev() { if (setupStep > 1) { setupStep--; setupUpdateUI(); } }
function suGoTo(n) { if (n < setupStep) { setupStep = n; setupUpdateUI(); } }

function suValidate1() {
  const name = document.getElementById('su-campaignName').value.trim();
  const cat  = document.getElementById('su-campaignCategory').value;
  if (!name) { suHighlight('su-campaignName'); return false; }
  if (!cat)  { suHighlight('su-campaignCategory'); return false; }
  return true;
}
function suHighlight(id) {
  const el = document.getElementById(id);
  el.style.borderColor = 'var(--red)';
  el.style.boxShadow   = '0 0 0 3px rgba(248,113,113,0.12)';
  el.focus();
  setTimeout(() => { el.style.borderColor=''; el.style.boxShadow=''; }, 2000);
}

function suCountChars(inputId, countId, max) {
  const el = document.getElementById(inputId);
  const c  = document.getElementById(countId);
  if (!el||!c) return;
  const len = el.value.length;
  c.textContent = `${len} / ${max}`;
  c.className = 'su-char-count' + (len >= max ? ' over' : len > max*0.9 ? ' warn' : '');
}
function suCountWords(inputId, countId, max) {
  const el = document.getElementById(inputId);
  const c  = document.getElementById(countId);
  if (!el||!c) return;
  const words = el.value.trim() ? el.value.trim().split(/\s+/).length : 0;
  c.textContent = `${words} / ${max} words`;
  c.className = 'su-char-count' + (words >= max ? ' over' : words > max*0.9 ? ' warn' : '');
  if (words > max) el.value = el.value.trim().split(/\s+/).slice(0,max).join(' ');
}

function suSetDemo(val) {
  suDemo = val;
  document.getElementById('su-demoYes').className = 'su-tpbtn' + (val  ? ' active yes' : '');
  document.getElementById('su-demoNo').className  = 'su-tpbtn' + (!val ? ' active no'  : '');
  document.getElementById('su-demoHint').textContent = val
    ? 'Demo mode — test data only, no live players affected.'
    : 'This campaign runs against live player data.';
}
function suToggleOngoing() {
  suOngoing = !suOngoing;
  document.getElementById('su-ongoingToggle').classList.toggle('active', suOngoing);
  const ew = document.getElementById('su-endDateWrap');
  ew.style.opacity       = suOngoing ? '0.35' : '1';
  ew.style.pointerEvents = suOngoing ? 'none'  : '';
  document.getElementById('su-endDate').disabled = suOngoing;
  document.getElementById('su-dateSep').style.opacity = suOngoing ? '0.3' : '1';
  document.getElementById('su-dateHint').textContent  = suOngoing
    ? 'Campaign runs indefinitely from the start date.'
    : 'Campaign runs from start date to end date.';
}
function suSetEntry(type) {
  suEntryType = type;
  document.getElementById('su-entrySingle').className = 'su-segbtn' + (type==='single' ? ' active' : '');
  document.getElementById('su-entryMulti').className  = 'su-segbtn' + (type==='multi'  ? ' active' : '');
  document.getElementById('su-entryBody').classList.toggle('open', type === 'multi');
}
function suSetReentry(val) {
  suReentry = val;
  document.getElementById('su-reentryYes').className = 'su-tpbtn' + (val  ? ' active yes' : '');
  document.getElementById('su-reentryNo').className  = 'su-tpbtn' + (!val ? ' active no'  : '');
  document.getElementById('su-reentryBody').classList.toggle('open', val);
}
function suSetInterval(type) {
  suInterval = type;
  document.getElementById('su-intAlways').className    = 'su-segbtn' + (type==='always'    ? ' active' : '');
  document.getElementById('su-intScheduled').className = 'su-segbtn' + (type==='scheduled' ? ' active' : '');
  document.getElementById('su-intervalBody').classList.toggle('open', type === 'scheduled');
}
function suToggleDay(btn) {
  const d = btn.dataset.day;
  suActiveDays.has(d) ? (suActiveDays.delete(d), btn.classList.remove('active'))
                       : (suActiveDays.add(d),    btn.classList.add('active'));
}
function suApplyPreset(preset, e) {
  const all=['Mon','Tue','Wed','Thu','Fri','Sat','Sun'];
  const target = preset==='weekdays' ? new Set(['Mon','Tue','Wed','Thu','Fri'])
               : preset==='weekends' ? new Set(['Sat','Sun']) : new Set(all);
  suActiveDays = target;
  document.querySelectorAll('.su-daybtn').forEach(b => b.classList.toggle('active', suActiveDays.has(b.dataset.day)));
  document.querySelectorAll('.su-presetbtn').forEach(b => b.classList.remove('active'));
  if (e?.target) e.target.classList.add('active');
}
function suSetCooldown(val) {
  suCooldown = val;
  ['su-coolNone','su-cool1d','su-cool1w','su-cool1m','su-coolCustom'].forEach(id => {
    const el = document.getElementById(id);
    if (el) el.classList.remove('active');
  });
  const idMap = {none:'su-coolNone','1d':'su-cool1d','1w':'su-cool1w','1m':'su-cool1m','custom':'su-coolCustom'};
  const el = document.getElementById(idMap[val]);
  if (el) el.classList.add('active');
  document.getElementById('su-coolCustomWrap').style.display = val === 'custom' ? 'flex' : 'none';
}
function suLaunch() {
  const name = document.getElementById('su-campaignName').value.trim() || 'Untitled Campaign';
  const catEl = document.getElementById('su-campaignCategory');
  const cat = catEl.options[catEl.selectedIndex]?.text?.split(' —')[0] || 'General';
  const newId = Date.now();
  closeSetup();
  JOURNEYS.unshift({
    id: newId, group:'design', name, status:'draft',
    category: cat, type:'realtime',
    players:0, nodes:0, progress:'0%', updated:'Just now',
    fromTemplate: setupFromTemplate
  });
  renderAll();
  // Navigate directly to canvas — template opens with demo, blank campaign opens empty
  showPage('canvas', setupFromTemplate ? 'demo' : '');
}

// ── TOAST ──
let toastTimer;
function toast(msg) {
  let bar = document.getElementById('toastBar');
  if (!bar) {
    bar = document.createElement('div');
    bar.id = 'toastBar';
    bar.style.cssText = `position:fixed;bottom:28px;left:50%;transform:translateX(-50%);
      background:var(--surface2);border:1px solid var(--border2);border-left:2px solid var(--accent);
      border-radius:8px;padding:9px 18px;font-size:12px;font-family:IBM Plex Mono,monospace;
      color:var(--text);box-shadow:0 6px 24px rgba(0,0,0,0.5);z-index:1000;white-space:nowrap;
      animation:fadeUp 0.2s ease`;
    document.body.appendChild(bar);
  }
  bar.textContent = msg;
  bar.style.display = 'block';
  clearTimeout(toastTimer);
  toastTimer = setTimeout(() => bar.style.display = 'none', 2800);
}

// ── INIT ──
renderAll();

// Auto-open setup if redirected from index "New Campaign" card
if (sessionStorage.getItem('openSetup') === '1') {
  sessionStorage.removeItem('openSetup');
  setTimeout(openSetup, 100);
}

</script>

<!-- ══ CANVAS JS ══ -->
<script>

// ══════════════════════════════════════════════════
//  CONSTANTS — canvas grid
// ══════════════════════════════════════════════════
const COL_W = 170;   // px between column centres
const ROW_H = 140;   // px between branch row centres
const NODE_W = 88;
const NODE_H = 88;
const START_X = 60;
const START_Y = 300;

// ══════════════════════════════════════════════════
//  STATE
// ══════════════════════════════════════════════════
let nodes = [];         // {id, type, col, row, label, config, branchLabel}
let edges = [];         // {from, to, label, color}
let selectedId = null;
let triggerType = null;
let heatmapOn = true;
let scale = 1;
let pan = {x:0, y:0};
let nc = 0;

// ── UNDO STACK ──
const UNDO_LIMIT = 40;
let undoStack = [];   // array of snapshots {nodes, edges, nc}
let redoStack = [];

function snapshot() {
  undoStack.push({
    nodes: JSON.parse(JSON.stringify(nodes)),
    edges: JSON.parse(JSON.stringify(edges)),
    nc
  });
  if (undoStack.length > UNDO_LIMIT) undoStack.shift();
  redoStack = [];  // any new action clears redo
}

function undo() {
  if (undoStack.length === 0) { showAlert('Nothing to undo'); return; }
  // Save current state to redo
  redoStack.push({
    nodes: JSON.parse(JSON.stringify(nodes)),
    edges: JSON.parse(JSON.stringify(edges)),
    nc
  });
  const prev = undoStack.pop();
  nodes = prev.nodes; edges = prev.edges; nc = prev.nc;
  closePanel();
  render(); updateStats();
  showAlert('↩ Undone');
}

function redo() {
  if (redoStack.length === 0) { showAlert('Nothing to redo'); return; }
  undoStack.push({
    nodes: JSON.parse(JSON.stringify(nodes)),
    edges: JSON.parse(JSON.stringify(edges)),
    nc
  });
  const next = redoStack.pop();
  nodes = next.nodes; edges = next.edges; nc = next.nc;
  closePanel();
  render(); updateStats();
  showAlert('↪ Redone');
}

// ══════════════════════════════════════════════════
//  NODE DEFINITIONS
// ══════════════════════════════════════════════════
const DEFS = {
  trigger:    {label:'Real-time Trigger', icon:'⚡', cls:'nc-trigger',  color:'#22c55e', fork:true},
  schedule:   {label:'Schedule Trigger',  icon:'📅', cls:'nc-schedule', color:'#3b82f6', fork:false},
  wait:       {label:'Wait',              icon:'🕐', cls:'nc-wait',     color:'#38bdf8', fork:false},
  random:     {label:'Random Split',      icon:'⚡', cls:'nc-split',    color:'#f59e0b', fork:true},
  'event-split':{label:'Event Split',     icon:'⑂', cls:'nc-flow',     color:'#f97316', fork:true},
  condition:  {label:'Condition Split',   icon:'◇', cls:'nc-cond',     color:'#8b5cf6', fork:true},
  end:        {label:'End',               icon:'⊗', cls:'nc-end',      color:'#ef4444', fork:false},
  pull:       {label:'Pull Data',         icon:'⬇', cls:'nc-pull',     color:'#06b6d4', fork:false},
  bonus:      {label:'Add Bonus',         icon:'🎁', cls:'nc-activity', color:'#a855f7', fork:false},
  leaderboard:{label:'Leaderboard',       icon:'🏆', cls:'nc-activity', color:'#a855f7', fork:false},
  mission:    {label:'Mission',           icon:'🎯', cls:'nc-activity', color:'#a855f7', fork:false},
  tournament: {label:'Tournament',        icon:'🥇', cls:'nc-activity', color:'#a855f7', fork:false},
  skin:       {label:'Game Skin',         icon:'🎮', cls:'nc-activity', color:'#a855f7', fork:false},
  coins:      {label:'Betty Coins',       icon:'🪙', cls:'nc-activity', color:'#a855f7', fork:false},
  shop:       {label:'Go to Shop',        icon:'🛍', cls:'nc-activity', color:'#a855f7', fork:false},
  esb:        {label:'ESB Tools',         icon:'🌐', cls:'nc-activity', color:'#a855f7', fork:false},
  rtmsg:      {label:'Real-Time Msg',     icon:'💬', cls:'nc-comms',    color:'#8b5cf6', fork:false},
  email:      {label:'Email',             icon:'📧', cls:'nc-comms',    color:'#8b5cf6', fork:false},
  sms:        {label:'SMS',               icon:'📱', cls:'nc-comms',    color:'#8b5cf6', fork:false},
  push:       {label:'Push',              icon:'🔔', cls:'nc-comms',    color:'#8b5cf6', fork:false},
  slack:      {label:'Slack (Internal)',  icon:'💼', cls:'nc-comms',    color:'#8b5cf6', fork:false},
  tag:        {label:'Add/Remove Tag',    icon:'🏷', cls:'nc-data',     color:'#06b6d4', fork:false},
  vip:        {label:'Change VIP',        icon:'⭐', cls:'nc-data',     color:'#06b6d4', fork:false},
  status:     {label:'Change Status',     icon:'📊', cls:'nc-data',     color:'#06b6d4', fork:false},
  placeholder:{label:'Add node',          icon:'+',  cls:'',            color:'#2e3448', fork:false},
};

// ══════════════════════════════════════════════════
//  COORDINATE HELPERS (col/row → px)
// ══════════════════════════════════════════════════
function colRowToXY(col, row) {
  return {
    x: START_X + col * COL_W,
    y: START_Y + row * ROW_H - ROW_H/2
  };
}

// ══════════════════════════════════════════════════
//  TRIGGER SELECTION
// ══════════════════════════════════════════════════
function selectTrigger(type) {
  triggerType = type;
  const gate = document.getElementById('triggerGate');
  gate.style.opacity = '0'; gate.style.pointerEvents = 'none';

  const nodeType = type === 'realtime' ? 'trigger' : 'schedule';
  const id = newId();
  nodes.push({id, type:nodeType, col:0, row:0, label:DEFS[nodeType].label, config:{events:[]}, branchLabel:''});

  // Single placeholder to the right
  const phId = newId();
  nodes.push({id:phId, type:'placeholder', col:1, row:0, label:'', config:{}, branchLabel:'', parentId:id});
  edges.push({from:id, to:phId, label:'', color:DEFS[nodeType].color});

  render(); openProperties(nodes[0]);
}

// ══════════════════════════════════════════════════
//  PALETTE DRAG-AND-DROP
// ══════════════════════════════════════════════════
let paletteDrag = null;   // { type, ghost }
let hoveredPhId = null;   // placeholder we're hovering over

function startPaletteDrag(e, type) {
  if (!triggerType) { showAlert('⚡ Choose a trigger type first'); return; }
  e.preventDefault();

  const def = DEFS[type];
  const ghost = document.getElementById('dragGhost');
  ghost.querySelector('.dg-card').className = 'dg-card ' + def.cls;
  ghost.querySelector('.dg-icon').textContent = def.icon;
  ghost.querySelector('.dg-label').textContent = def.label;
  ghost.style.display = 'block';
  ghost.style.left = e.clientX + 'px';
  ghost.style.top  = e.clientY + 'px';

  paletteDrag = { type };
  document.body.style.userSelect = 'none';
  document.body.style.cursor = 'grabbing';
}

document.addEventListener('mousemove', e => {
  if (!paletteDrag) return;

  // Move ghost
  const ghost = document.getElementById('dragGhost');
  ghost.style.left = e.clientX + 'px';
  ghost.style.top  = e.clientY + 'px';

  // Hit-test placeholder nodes
  const prev = hoveredPhId;
  hoveredPhId = null;

  // Temporarily hide ghost so elementFromPoint sees what's underneath
  ghost.style.display = 'none';
  const el = document.elementFromPoint(e.clientX, e.clientY);
  ghost.style.display = 'block';

  const phEl = el?.closest('.placeholder-node');
  if (phEl) hoveredPhId = phEl.dataset.phid;

  // Update highlight classes
  document.querySelectorAll('.placeholder-node').forEach(p => p.classList.remove('drag-over'));
  if (hoveredPhId) {
    document.querySelector(`.placeholder-node[data-phid="${hoveredPhId}"]`)?.classList.add('drag-over');
  }
}, true);

document.addEventListener('mouseup', e => {
  if (!paletteDrag) return;
  const type = paletteDrag.type;

  // Cleanup
  document.getElementById('dragGhost').style.display = 'none';
  document.querySelectorAll('.placeholder-node').forEach(p => p.classList.remove('drag-over'));
  document.body.style.userSelect = '';
  document.body.style.cursor = '';
  paletteDrag = null;

  if (hoveredPhId) {
    // Dropped onto a placeholder — fill it
    fillPlaceholder(hoveredPhId, type);
    hoveredPhId = null;
  } else {
    // Dropped on canvas — check if we're over the canvas area
    const canvasRect = document.getElementById('canvasWrap').getBoundingClientRect();
    const onCanvas = e.clientX >= canvasRect.left && e.clientX <= canvasRect.right &&
                     e.clientY >= canvasRect.top  && e.clientY <= canvasRect.bottom;
    if (onCanvas) {
      // Find nearest placeholder (within 80px in canvas coords)
      const cx = (e.clientX - canvasRect.left - pan.x) / scale;
      const cy = (e.clientY - canvasRect.top  - pan.y) / scale;
      const phs = nodes.filter(n => n.type === 'placeholder');
      let nearest = null, nearestDist = 80;
      phs.forEach(ph => {
        const {x, y} = colRowToXY(ph.col, ph.row);
        const pcx = x + NODE_W / 2;
        const pcy = y + NODE_H / 2;
        const dist = Math.hypot(cx - pcx, cy - pcy);
        if (dist < nearestDist) { nearestDist = dist; nearest = ph; }
      });
      if (nearest) {
        fillPlaceholder(nearest.id, type);
      } else {
        showAlert('↖ Drop onto a + placeholder to place the node');
      }
    }
  }
}, true);

// Keep clickAddNode as fallback (shouldn't be called now but kept for safety)
function clickAddNode(type) {
  if (!triggerType) { showAlert('⚡ Choose a trigger type first'); return; }
  const ph = nodes.find(n => n.type === 'placeholder');
  if (ph) { fillPlaceholder(ph.id, type); return; }
  showAlert('ℹ No available slot.');
}

function fillPlaceholder(phId, type) {
  const ph = getNode(phId);
  if (!ph) return;
  snapshot();  // save before mutation

  ph.type = type;
  ph.label = DEFS[type].label;
  ph.config = {};
  delete ph.ghost;  // no longer a ghost slot

  // Remove parentId reference
  delete ph.parentId;

  // Update edge colour
  const inEdge = edges.find(e => e.to === phId);
  if (inEdge) inEdge.color = DEFS[type].color;

  // If fork node → add branch placeholders; else add one placeholder
  if (DEFS[type].fork && type !== 'trigger' && type !== 'schedule') {
    addForkBranches(ph);
  } else if (type !== 'end') {
    addPlaceholderAfter(ph);
  }

  render(); selectNode(phId); updateStats(); showAlert('✓ ' + DEFS[type].label + ' added');
}

function addPlaceholderAfter(node) {
  const phId = newId();
  nodes.push({id:phId, type:'placeholder', col:node.col+1, row:node.row, label:'', config:{}, branchLabel:'', parentId:node.id});
  edges.push({from:node.id, to:phId, label:'', color:'#2e3448'});
}

// ══════════════════════════════════════════════════
//  FORK BRANCH LAYOUT
//  When a fork node is placed, its branches spread
//  above and below it.  Any existing nodes that would
//  collide are pushed downward to make room.
// ══════════════════════════════════════════════════
const BRANCH_GAP = 2;   // row-slots between sibling branches

function addForkBranches(forkNode) {
  let branches = [];
  if (forkNode.type === 'condition')
    branches = [{l:'Yes', c:'#4ade80'}, {l:'No', c:'#f87171'}];
  else if (forkNode.type === 'event-split')
    branches = [{l:'Event', c:'#4ade80'}, {l:'Timeout', c:'#f87171'}];
  else if (forkNode.type === 'random')
    branches = [{l:'33%', c:'#fb923c'}, {l:'33%', c:'#fb923c'}, {l:'33%', c:'#fb923c'}];
  else
    branches = [{l:'', c:'#4ade80'}, {l:'', c:'#4ade80'}];

  const n      = branches.length;
  const span   = (n - 1) * BRANCH_GAP;          // total rows needed
  const anchorRow = forkNode.row;
  const firstRow  = anchorRow - Math.floor(span / 2);  // centre branches on the fork node

  // Collect rows we WANT to use
  const desiredRows = branches.map((_, i) => firstRow + i * BRANCH_GAP);

  // Push down any existing nodes in cols > forkNode.col that would overlap
  pushDownConflicts(forkNode.col + 1, desiredRows);

  // Place the placeholder branches
  branches.forEach((b, i) => {
    const phId = newId();
    nodes.push({
      id: phId, type: 'placeholder',
      col: forkNode.col + 1,
      row: desiredRows[i],
      label: '', config: {}, branchLabel: b.l, parentId: forkNode.id
    });
    edges.push({from: forkNode.id, to: phId, label: b.l, color: b.c});
  });
}

/**
 * For all nodes in columns >= startCol whose row falls within
 * any of the desiredRows or between them, shift them down
 * enough to open up exactly those rows.
 */
function pushDownConflicts(startCol, desiredRows) {
  if (desiredRows.length === 0) return;
  const minRow = Math.min(...desiredRows);
  const maxRow = Math.max(...desiredRows);

  // How many slots are needed in this row range?
  const slotsNeeded = desiredRows.length;
  // How many slots currently exist in [minRow..maxRow] for startCol?
  const existing = nodes.filter(n => n.col >= startCol && n.row >= minRow && n.row <= maxRow);

  if (existing.length === 0) return; // no conflict

  // Push every node at col>=startCol and row>=minRow down by the overflow amount
  const overflow = slotsNeeded; // shift down by one full branch-set worth
  nodes.forEach(n => {
    if (n.col >= startCol && n.row >= minRow) {
      n.row += overflow * BRANCH_GAP;
    }
  });
}

// ══════════════════════════════════════════════════
//  REPACK — only used as a safety net to eliminate
//  exact row duplicates within the same column.
//  Does NOT collapse the intentional spacing.
// ══════════════════════════════════════════════════
function repack() {
  // Group by col
  const byCol = {};
  nodes.forEach(n => {
    if (!byCol[n.col]) byCol[n.col] = [];
    byCol[n.col].push(n);
  });

  Object.values(byCol).forEach(colNodes => {
    colNodes.sort((a, b) => a.row - b.row);
    // Walk through and ensure no two nodes share the same row.
    // If they do, bump the later one down by BRANCH_GAP.
    for (let i = 1; i < colNodes.length; i++) {
      if (colNodes[i].row <= colNodes[i-1].row) {
        const bump = colNodes[i-1].row + BRANCH_GAP;
        const diff = bump - colNodes[i].row;
        // Shift this node AND all downstream nodes in same branch
        shiftSubtree(colNodes[i].id, diff);
        colNodes[i].row = bump;
      }
    }
  });
}

/**
 * Recursively shift a node and all nodes reachable from it
 * downward by `delta` rows, staying in columns > node.col.
 */
function shiftSubtree(nodeId, delta) {
  const visited = new Set();
  const queue = [nodeId];
  while (queue.length) {
    const id = queue.shift();
    if (visited.has(id)) continue;
    visited.add(id);
    const n = getNode(id);
    if (n) n.row += delta;
    edges.filter(e => e.from === id).forEach(e => queue.push(e.to));
  }
}

// ══════════════════════════════════════════════════
//  CONTEXT MENU on placeholder click
// ══════════════════════════════════════════════════
function showCtxMenu(phId, screenX, screenY) {
  const menu = document.getElementById('ctxMenu');

  const sections = [
    {title:'Flow', items:['wait','event-split','condition','random','end','pull']},
    {title:'Activities', items:['bonus','leaderboard','mission','tournament','skin','coins']},
    {title:'Communications', items:['rtmsg','email','sms','push','slack']},
    {title:'Player Data', items:['tag','vip','status']},
  ];

  let html = '';
  sections.forEach(s => {
    html += `<div class="ctx-section">${s.title}</div>`;
    s.items.forEach(t => {
      const d = DEFS[t];
      html += `<div class="ctx-item" onclick="fillPlaceholder('${phId}','${t}');hideCtx()">
        <div class="ctx-item-icon ${d.cls}">${d.icon}</div>
        <span class="ctx-item-label">${d.label}</span>
      </div>`;
    });
  });

  menu.innerHTML = html;
  menu.style.display = 'block';
  // Position, keep in viewport
  const vw = window.innerWidth, vh = window.innerHeight;
  let x = screenX + 8, y = screenY - 10;
  menu.style.left = x + 'px'; menu.style.top = y + 'px';
  // Check overflow
  requestAnimationFrame(() => {
    const r = menu.getBoundingClientRect();
    if (r.right > vw) menu.style.left = (x - r.width - 16) + 'px';
    if (r.bottom > vh) menu.style.top = (y - r.height + 20) + 'px';
  });
}

function hideCtx() { document.getElementById('ctxMenu').style.display = 'none'; }
document.addEventListener('click', e => {
  if (!e.target.closest('#ctxMenu')) hideCtx();
});

// ══════════════════════════════════════════════════
//  DRAG-TO-CONNECT (port → node)
//  Drag from right-side output port to any other node
// ══════════════════════════════════════════════════
let connectingFrom = null;
let mousePos = {x:0, y:0};

function startConnect(e, fromId) {
  // Don't start if palette drag is active
  if (paletteDrag) return;
  e.stopPropagation();
  e.preventDefault();
  connectingFrom = fromId;
  document.getElementById('connectingSvg').style.display = 'block';
  // Show all input ports glowing
  document.querySelectorAll('.in-port').forEach(p => p.classList.add('accepting'));
}

// Single mousemove handler (not capture, avoids palette conflict)
document.addEventListener('mousemove', e => {
  mousePos = {x: e.clientX, y: e.clientY};
  if (!connectingFrom) return;

  // Draw the live line from the out-port position
  const portEl = document.querySelector(`#cn-${connectingFrom} .out-port`);
  if (!portEl) { cancelConnect(); return; }
  const r = portEl.getBoundingClientRect();
  const line = document.getElementById('connectingLine');
  line.setAttribute('x1', r.left + r.width / 2);
  line.setAttribute('y1', r.top  + r.height / 2);
  line.setAttribute('x2', e.clientX);
  line.setAttribute('y2', e.clientY);

  // Highlight the node we're hovering — hide svg overlay first so it doesn't intercept
  const svg = document.getElementById('connectingSvg');
  svg.style.pointerEvents = 'none';   // already none but be explicit
  const ghost = document.getElementById('dragGhost');
  const gDisp = ghost.style.display;
  ghost.style.display = 'none';
  const el = document.elementFromPoint(e.clientX, e.clientY);
  ghost.style.display = gDisp;

  // Clear previous hover
  document.querySelectorAll('.canvas-node.connect-hover').forEach(n => n.classList.remove('connect-hover'));
  const targetWrap = el?.closest('.canvas-node');
  if (targetWrap && targetWrap.id !== `cn-${connectingFrom}`) {
    targetWrap.classList.add('connect-hover');
  }
});

document.addEventListener('mouseup', e => {
  if (!connectingFrom) return;

  // Find target — hide ghost to allow clean hit test
  const ghost = document.getElementById('dragGhost');
  const gDisp = ghost.style.display;
  ghost.style.display = 'none';
  const el = document.elementFromPoint(e.clientX, e.clientY);
  ghost.style.display = gDisp;

  const targetWrap = el?.closest('.canvas-node');
  if (targetWrap) {
    const toId = targetWrap.id.replace('cn-', '');
    if (toId && toId !== connectingFrom) connectNodes(connectingFrom, toId);
  }

  cancelConnect();
});

function cancelConnect() {
  connectingFrom = null;
  document.getElementById('connectingSvg').style.display = 'none';
  document.querySelectorAll('.in-port').forEach(p => p.classList.remove('accepting'));
  document.querySelectorAll('.canvas-node.connect-hover').forEach(n => n.classList.remove('connect-hover'));
}

function connectNodes(fromId, toId) {
  const fromNode = getNode(fromId);
  const toNode   = getNode(toId);
  if (!fromNode || !toNode) return;
  if (toNode.type === 'placeholder') return;
  if (toNode.type === 'trigger' || toNode.type === 'schedule') {
    showAlert('⛔ Cannot connect into a trigger node'); return;
  }
  if (toNode.col <= fromNode.col) {
    showAlert('⛔ Connections must flow left → right'); return;
  }
  if (edges.find(e => e.from === fromId && e.to === toId)) return;
  snapshot();
  edges.push({from: fromId, to: toId, label: '', color: DEFS[fromNode.type]?.color || '#60a5fa'});
  render();
  showAlert('✓ Nodes connected');
}

// ══════════════════════════════════════════════════
//  TRIGGER multi-event branch update
// ══════════════════════════════════════════════════
function updateTriggerBranches(trigNode) {
  const events = trigNode.config.events || [];

  // ── Step 1: Remove ONLY placeholder branches off the trigger
  //    Real nodes (already placed by user) are kept untouched
  const phEdges = edges.filter(e => e.from === trigNode.id && getNode(e.to)?.type === 'placeholder');
  phEdges.forEach(e => {
    nodes = nodes.filter(n => n.id !== e.to);
  });
  edges = edges.filter(e => !(e.from === trigNode.id && getNode(e.to) === undefined));
  // Clean up any dangling edges to removed nodes
  edges = edges.filter(e => getNode(e.from) && getNode(e.to));

  // ── Step 2: Count existing real branches (non-placeholder) off trigger
  const existingRealEdges = edges.filter(e => e.from === trigNode.id);
  const existingCount = existingRealEdges.length;

  // ── Step 3: Add a placeholder per event that doesn't already have a real branch
  //    Use rows spread BELOW existingCount to avoid collision
  const STEP = 2;
  const newEvents = events.slice(existingCount); // only add for events beyond what's already built

  // All events → one placeholder per event not already connected
  // We rebuild ALL placeholder branches to match current event list
  const totalNeeded = events.length;
  const placeholdersNeeded = Math.max(0, totalNeeded - existingCount);

  // Place new placeholders below all existing nodes
  const usedRows = new Set(nodes.map(n => n.row));
  let nextRow = trigNode.row;
  for (let i = 0; i < placeholdersNeeded; i++) {
    // Find a free row
    while (usedRows.has(nextRow)) nextRow++;
    const phId = newId();
    const ev = events[existingCount + i] || '';
    nodes.push({
      id: phId, type: 'placeholder',
      col: trigNode.col + 1, row: nextRow,
      label: '', config: {}, branchLabel: ev, parentId: trigNode.id
    });
    edges.push({from: trigNode.id, to: phId, label: ev, color: '#4ade80'});
    usedRows.add(nextRow);
    nextRow += STEP;
  }

  // Update labels on existing real branch edges to match event names
  existingRealEdges.forEach((e, i) => {
    e.label = events[i] || e.label;
  });

  render();
}

// ══════════════════════════════════════════════════
//  RENDER
// ══════════════════════════════════════════════════
function render() {
  renderNodes();
  renderEdges();
  renderMinimap();
}

function nodeXY(node) {
  return colRowToXY(node.col, node.row);
}

function renderNodes() {
  const vp = document.getElementById('viewport');
  vp.querySelectorAll('.canvas-node,.placeholder-node').forEach(el => el.remove());

  nodes.forEach(node => {
    const {x, y} = nodeXY(node);

    if (node.type === 'placeholder') {
      const el = document.createElement('div');
      // ghost = slot left behind after deleting a real node (has no parentId but has an incoming edge)
      const isGhost = !!node.ghost;
      el.className = 'placeholder-node' + (isGhost ? ' ghost' : '');
      el.style.left = x + 'px'; el.style.top = y + 'px';
      el.dataset.phid = node.id;   // needed for palette drag hit-test
      el.innerHTML = `<div class="ph-plus">+</div><div class="ph-label">${node.branchLabel || 'Add node'}</div>`;
      el.onclick = ev => { ev.stopPropagation(); showCtxMenu(node.id, ev.clientX, ev.clientY); };
      vp.appendChild(el);
      return;
    }

    const def = DEFS[node.type];
    if (!def) return;

    const wrap = document.createElement('div');
    wrap.className = 'canvas-node';
    wrap.id = 'cn-' + node.id;
    wrap.style.left = x + 'px'; wrap.style.top = y + 'px';
    wrap.onclick = ev => { ev.stopPropagation(); selectNode(node.id); };

    // Input port (left side)
    if (node.type !== 'trigger' && node.type !== 'schedule') {
      const inp = document.createElement('div');
      inp.className = 'in-port';
      inp.title = 'Input';
      wrap.appendChild(inp);
    }

    // Card
    const card = document.createElement('div');
    card.className = 'node-card ' + def.cls;
    if (node.id === selectedId) card.classList.add('selected');

    if (heatmapOn && node.type !== 'end' && node.type !== 'placeholder') {
      const badge = document.createElement('div');
      badge.className = 'heat-badge';
      badge.textContent = Math.floor(Math.random()*200+5).toLocaleString();
      card.appendChild(badge);
    }

    card.innerHTML += `<div class="node-card-icon">${def.icon}</div><div class="node-card-label">${node.label||def.label}</div>`;
    wrap.appendChild(card);

    // Output port (right side)
    if (node.type !== 'end') {
      const outp = document.createElement('div');
      outp.className = 'out-port';
      outp.title = 'Drag to connect';
      outp.onmousedown = ev => startConnect(ev, node.id);
      wrap.appendChild(outp);
    }

    // Actions
    const acts = document.createElement('div');
    acts.className = 'node-actions';
    acts.innerHTML = `
      <button class="na-btn" title="Edit" onclick="event.stopPropagation();selectNode('${node.id}')">✏</button>
      <button class="na-btn del" title="Delete" onclick="event.stopPropagation();deleteNode('${node.id}')">🗑</button>
    `;
    wrap.appendChild(acts);
    vp.appendChild(wrap);
  });
}

function renderEdges() {
  const svg = document.getElementById('connSvg');
  svg.innerHTML = '';

  edges.forEach(edge => {
    const fn = getNode(edge.from);
    const tn = getNode(edge.to);
    if (!fn || !tn) return;

    const fp = nodeXY(fn);
    const tp = nodeXY(tn);

    // Source: right-center of from node
    const fx = fp.x + NODE_W;
    const fy = fp.y + NODE_H/2;
    // Target: left-center of to node
    const tx = tp.x;
    const ty = tp.y + NODE_H/2;

    const color = edge.color || '#60a5fa';
    const isPlaceholder = tn.type === 'placeholder';

    // Orthogonal routing for fork edges (same row vs different row)
    let pathD;
    if (fn.row === tn.row) {
      // Same row — simple bezier
      const cx = fx + (tx-fx)*0.5;
      pathD = `M${fx},${fy} C${cx},${fy} ${cx},${ty} ${tx},${ty}`;
    } else {
      // Fork — route with 90° elbows
      const midX = fx + COL_W * 0.45;
      pathD = `M${fx},${fy} H${midX} V${ty} H${tx}`;
    }

    const path = document.createElementNS('http://www.w3.org/2000/svg','path');
    path.setAttribute('d', pathD);
    path.setAttribute('stroke', color);
    path.setAttribute('stroke-width', isPlaceholder ? '1.5' : '2');
    path.setAttribute('fill','none');
    path.setAttribute('opacity', isPlaceholder ? '0.35' : '0.8');
    if (isPlaceholder) path.setAttribute('stroke-dasharray','5,4');
    svg.appendChild(path);

    // Dots
    [{ cx:fx, cy:fy, r:3 },{ cx:tx, cy:ty, r:3.5 }].forEach(({cx,cy,r})=>{
      const c = document.createElementNS('http://www.w3.org/2000/svg','circle');
      c.setAttribute('cx',cx); c.setAttribute('cy',cy);
      c.setAttribute('r',r); c.setAttribute('fill',color);
      c.setAttribute('opacity', isPlaceholder ? '0.3' : '0.85');
      svg.appendChild(c);
    });

    // Edge label
    if (edge.label) {
      const mx = (fx + tx) / 2;
      const my = Math.min(fy,ty) - 9;
      const lbl = document.createElementNS('http://www.w3.org/2000/svg','text');
      lbl.setAttribute('x',mx); lbl.setAttribute('y',my);
      lbl.setAttribute('text-anchor','middle');
      lbl.setAttribute('fill',color); lbl.setAttribute('font-size','9');
      lbl.setAttribute('font-family','IBM Plex Mono, monospace');
      lbl.setAttribute('font-weight','600');
      lbl.setAttribute('opacity','0.85');
      lbl.textContent = edge.label;
      svg.appendChild(lbl);
    }
  });
}

// ══════════════════════════════════════════════════
//  MINIMAP
// ══════════════════════════════════════════════════
function renderMinimap() {
  const inner = document.getElementById('mmInner');
  inner.querySelectorAll('.mm-node').forEach(el => el.remove());
  if (nodes.length === 0) return;

  const xs = nodes.map(n => colRowToXY(n.col,n.row).x);
  const ys = nodes.map(n => colRowToXY(n.col,n.row).y);
  const minX = Math.min(...xs), maxX = Math.max(...xs)+NODE_W;
  const minY = Math.min(...ys), maxY = Math.max(...ys)+NODE_H;
  const rangeX = maxX-minX || 400, rangeY = maxY-minY || 300;

  nodes.forEach(n => {
    if (n.type === 'placeholder') return;
    const def = DEFS[n.type];
    const {x,y} = colRowToXY(n.col,n.row);
    const dot = document.createElement('div');
    dot.className = 'mm-node';
    dot.style.background = def?.color || '#4a5270';
    dot.style.left = ((x-minX)/rangeX * 110 + 7) + 'px';
    dot.style.top  = ((y-minY)/rangeY * 62 + 7) + 'px';
    inner.appendChild(dot);
  });
}

// ══════════════════════════════════════════════════
//  PROPERTIES PANEL
// ══════════════════════════════════════════════════
function selectNode(id) {
  selectedId = id;
  const node = getNode(id);
  if (!node || node.type === 'placeholder') { closePanel(); return; }
  render();
  openProperties(node);
}

function openProperties(node) {
  const panel = document.getElementById('rightPanel');
  panel.classList.add('open');
  const def = DEFS[node.type];
  document.getElementById('rpTitle').textContent = node.label || def?.label || 'Node';
  document.getElementById('rpSub').textContent = getCat(node.type);
  document.getElementById('rpBody').innerHTML = buildProps(node);
}

function closePanel() {
  document.getElementById('rightPanel').classList.remove('open');
  selectedId = null;
  render();
}

function getCat(type) {
  if (['trigger','schedule'].includes(type)) return 'Trigger Node';
  if (['wait','random','event-split','condition','end','pull'].includes(type)) return 'Flow Control';
  if (['bonus','leaderboard','mission','tournament','skin','coins','shop','esb'].includes(type)) return 'Activity Node';
  if (['rtmsg','email','sms','push','slack'].includes(type)) return 'Communication Node';
  return 'Player Data Node';
}

function buildProps(node) {
  let h = `
    <div class="field-group">
      <label class="field-label">Label</label>
      <input class="field-input" id="pLabel" value="${node.label||''}" oninput="liveLabel(this.value)"/>
    </div>
    <div class="field-group">
      <label class="field-label">Description</label>
      <textarea class="field-input field-textarea" id="pDesc" placeholder="Notes for your team…">${node.config.description||''}</textarea>
    </div>
    <div class="divider"></div>
  `;

  if (node.type === 'trigger') {
    const evs = ['Login','Deposit','Game Round Complete','Level Up','Daily Check-in','Page Move','Tournament Start','Near Miss','Achievement Unlocked','Balance Low'];
    h += `
      <div class="field-group">
        <label class="field-label">Trigger Events <span style="color:var(--text3)">(max 3 — each creates a branch)</span></label>
        <div class="event-list">
          ${evs.map(ev => {
            const chk = (node.config.events||[]).includes(ev);
            return `<label class="event-check ${chk?'checked':''}" id="evl_${ev.replace(/\W/g,'_')}">
              <input type="checkbox" ${chk?'checked':''} onchange="toggleEv('${ev}',this)"/>
              <span class="event-check-label">${ev}</span>
            </label>`;
          }).join('')}
        </div>
        <div class="event-summary" id="evSummary" style="${(node.config.events||[]).length?'display:block':''}">
          <div class="es-title">Creates ${(node.config.events||[]).length} branch${(node.config.events||[]).length!==1?'es':''}</div>
          <div class="es-tags" id="esTags">${(node.config.events||[]).map(e=>`<span class="es-tag">${e}</span>`).join('')}</div>
        </div>
      </div>
      <div class="divider"></div>
      <div class="field-group">
        <label class="field-label">Entry Conditions</label>
        <div id="condList"></div>
        <button class="add-cond-btn" onclick="addCond()">+ Add Condition</button>
      </div>
    `;
  }

  if (node.type === 'schedule') {
    h += `
      <div class="field-group"><label class="field-label">Start Date & Time</label><input type="datetime-local" class="field-input"/></div>
      <div class="field-group"><label class="field-label">Recurrence</label>
        <select class="field-select"><option>One-time</option><option>Daily</option><option>Weekly</option><option>Monthly</option></select>
      </div>
    `;
  }

  if (node.type === 'wait') {
    h += `
      <div class="field-group"><label class="field-label">Duration</label>
        <div style="display:flex;gap:6px">
          <input class="field-input" type="number" value="24" style="width:72px"/>
          <select class="field-select"><option>Minutes</option><option selected>Hours</option><option>Days</option></select>
        </div>
      </div>
      <div class="field-group"><label class="field-label">Or Wait For Event</label>
        <select class="field-select"><option value="">Time only</option><option>Next Login</option><option>Next Deposit</option><option>Game Round Complete</option></select>
      </div>
    `;
  }

  if (node.type === 'condition') {
    h += `
      <div class="field-group">
        <label class="field-label">Condition Rules</label>
        <div id="condList">
          ${buildCondRow()}
        </div>
        <button class="add-cond-btn" onclick="addCond()">+ Add Condition</button>
      </div>
    `;
  }

  if (node.type === 'event-split') {
    h += `
      <div class="field-group"><label class="field-label">Listen For Event</label>
        <select class="field-select"><option>Next Login</option><option>Next Deposit</option><option>Game Round Complete</option><option>Tournament Rank Change</option></select>
      </div>
      <div class="field-group"><label class="field-label">Timeout</label>
        <div style="display:flex;gap:6px">
          <input class="field-input" type="number" value="48" style="width:72px"/>
          <select class="field-select"><option>Minutes</option><option selected>Hours</option><option>Days</option></select>
        </div>
      </div>
    `;
  }

  if (node.type === 'random') {
    h += `
      <div class="field-group"><label class="field-label">Branch Weights</label>
        <div style="display:flex;flex-direction:column;gap:5px">
          ${['Branch A','Branch B','Branch C'].map((b,i)=>`
            <div style="display:flex;align-items:center;gap:7px">
              <span style="font-size:10px;color:var(--text3);min-width:56px">${b}</span>
              <input class="field-input" type="number" value="33" style="width:56px" min="0" max="100"/>
              <span style="font-size:10px;color:var(--text3)">%</span>
            </div>`).join('')}
        </div>
      </div>
    `;
  }

  if (['rtmsg','email','sms','push'].includes(node.type)) {
    h += `
      <div class="field-group"><label class="field-label">Template</label>
        <select class="field-select"><option>Welcome Email</option><option>Deposit Confirmation</option><option>Tournament Invite</option><option>Bonus Awarded</option><option>VIP Upgrade</option><option>Re-engagement</option></select>
      </div>
    `;
    if (node.type === 'rtmsg') {
      h += `
        <div class="field-group"><label class="field-label">Presentation Type</label>
          <select class="field-select"><option>Overlay</option><option>Big Toast</option><option>Small Toast</option><option>Pic in Pic</option><option>Lobby Banner</option></select>
        </div>
        <div class="field-group"><label class="field-label">Priority</label>
          <select class="field-select"><option>Sales (P1)</option><option>Compliance (P1)</option><option>Campaign Update (P2)</option><option>Follow-up (P3)</option></select>
        </div>
      `;
    }
    if (node.type === 'sms' || node.type === 'email') {
      h += `<div class="field-group"><label class="field-label">Send Timing</label>
        <select class="field-select"><option>Immediately</option><option>After 10 min</option><option>After 1 hour</option><option>Next day 10am</option></select>
      </div>`;
    }
  }

  if (node.type === 'bonus') {
    h += `
      <div class="field-group"><label class="field-label">Bonus Type</label>
        <select class="field-select"><option>Free Spins</option><option>Deposit Match</option><option>Cash Bonus</option><option>Loyalty Points</option></select>
      </div>
      <div class="field-group"><label class="field-label">Amount</label><input class="field-input" type="number" placeholder="e.g. 20"/></div>
      <div class="field-group"><label class="field-label">Expiry (hours)</label><input class="field-input" type="number" placeholder="e.g. 72"/></div>
    `;
  }

  if (node.type === 'pull') {
    h += `
      <div class="field-group"><label class="field-label">Data Source</label>
        <select class="field-select"><option>Real-time event stream</option><option>Historical DWH</option><option>Player profile</option></select>
      </div>
      <div class="field-group"><label class="field-label">Field to Pull</label>
        <select class="field-select"><option>Total Bets Amount</option><option>Last Login Date</option><option>VIP Level</option><option>Current Balance</option><option>Tournament Rank</option></select>
      </div>
    `;
  }

  if (['leaderboard','mission','tournament'].includes(node.type)) {
    h += `
      <div class="field-group"><label class="field-label">Action</label>
        <select class="field-select"><option>Add to</option><option>Remove from</option></select>
      </div>
      <div class="field-group"><label class="field-label">${DEFS[node.type].label} Name</label>
        <select class="field-select"><option>Spring Tournament</option><option>Weekend Warriors</option><option>VIP Exclusive</option></select>
      </div>
    `;
  }

  if (node.type === 'tag') {
    h += `
      <div class="field-group"><label class="field-label">Action</label>
        <select class="field-select"><option>Add Tag</option><option>Remove Tag</option></select>
      </div>
      <div class="field-group"><label class="field-label">Tag Name</label><input class="field-input" placeholder="e.g. high_value_churned"/></div>
      <div class="field-group"><label class="field-label">Tag Value (optional)</label><input class="field-input" placeholder="e.g. true"/></div>
    `;
  }

  if (node.type === 'vip' || node.type === 'status') {
    h += `
      <div class="field-group"><label class="field-label">New Level</label>
        <select class="field-select"><option>Level 1 — Bronze</option><option>Level 2 — Silver</option><option>Level 3 — Gold</option><option>Level 4 — Platinum</option><option>Level 5 — Diamond</option></select>
      </div>
    `;
  }

  return h;
}

function buildCondRow(label) {
  return `<div class="cond-row">
    <div class="cond-fields">
      <select class="cond-sel" onchange="condFieldChange(this)">
        <option>VIP Level</option><option>Balance</option><option>Country</option>
        <option>Opted In</option><option>Tournament Rank Position</option>
        <option>Message Sent</option><option>Player Tag</option>
      </select>
      <select class="cond-sel" style="max-width:76px"><option>= Equals</option><option>&gt; Greater</option><option>&lt; Less</option><option>Has</option></select>
      <input class="cond-sel" placeholder="Value" style="border:1px solid var(--border2);background:var(--surface3);color:var(--text);border-radius:5px;padding:5px 7px;font-family:Outfit,sans-serif;outline:none"/>
    </div>
    <div class="sub-field" id="condSubField" style="display:none"></div>
    <div class="cond-footer">
      <span class="logic-tag" onclick="toggleLogic(this)">AND</span>
      <button class="cond-remove" onclick="this.closest('.cond-row').remove()">✕ remove</button>
    </div>
  </div>`;
}

function condFieldChange(sel) {
  const row = sel.closest('.cond-row');
  const sub = row.querySelector('.sub-field');
  const val = sel.value;
  if (val === 'Opted In') {
    sub.style.display='block';
    sub.innerHTML=`
      <select class="cond-sel" style="width:100%;margin-bottom:4px"><option>Opted In</option><option>Not Opted In</option></select>
      <select class="cond-sel" style="width:100%"><option>Spring Promotion 2024</option><option>Summer Bonus</option><option>VIP Exclusive</option><option>Welcome Series</option><option>Weekend Warriors</option></select>
    `;
  } else if (val === 'Tournament Rank Position') {
    sub.style.display='block';
    sub.innerHTML=`<input class="cond-sel" type="number" placeholder="Rank position e.g. 10" style="width:100%;border:1px solid var(--border2);background:var(--surface3);color:var(--text);border-radius:5px;padding:5px 7px;font-family:Outfit,sans-serif;outline:none"/>`;
  } else if (val === 'Message Sent') {
    sub.style.display='block';
    sub.innerHTML=`
      <select class="cond-sel" style="width:100%;margin-bottom:4px"><option>Message Sent</option><option>Message Not Sent</option></select>
      <select class="cond-sel" style="width:100%"><option>Welcome Email</option><option>Deposit Confirmation</option><option>Withdrawal Notification</option><option>Bonus Awarded</option><option>VIP Upgrade</option><option>Re-engagement</option></select>
    `;
  } else {
    sub.style.display='none'; sub.innerHTML='';
  }
}

function addCond() {
  const list = document.getElementById('condList');
  if (!list) return;
  list.insertAdjacentHTML('beforeend', buildCondRow());
}

function toggleLogic(el) {
  el.textContent = el.textContent === 'AND' ? 'OR' : 'AND';
}

function liveLabel(val) {
  if (!selectedId) return;
  const node = getNode(selectedId);
  if (node) { node.label = val; renderNodes(); }
}

function saveNode() {
  if (!selectedId) return;
  const node = getNode(selectedId);
  if (!node) return;
  const lbl = document.getElementById('pLabel');
  const desc = document.getElementById('pDesc');
  if (lbl) node.label = lbl.value;
  if (desc) node.config.description = desc.value;
  render(); showAlert('✓ Node saved');
}

// ══════════════════════════════════════════════════
//  EVENT CHECKBOXES (trigger)
// ══════════════════════════════════════════════════
function toggleEv(ev, cb) {
  const node = getNode(selectedId);
  if (!node) return;
  if (!node.config.events) node.config.events = [];
  if (cb.checked) {
    if (node.config.events.length >= 3) { cb.checked=false; showAlert('⚠ Max 3 events'); return; }
    node.config.events.push(ev);
    cb.closest('.event-check').classList.add('checked');
  } else {
    node.config.events = node.config.events.filter(e => e !== ev);
    cb.closest('.event-check').classList.remove('checked');
  }
  const sum = document.getElementById('evSummary');
  const tags = document.getElementById('esTags');
  const count = node.config.events.length;
  if (count > 0) {
    sum.style.display='block';
    sum.querySelector('.es-title').textContent = `Creates ${count} branch${count!==1?'es':''}`;
    tags.innerHTML = node.config.events.map(e=>`<span class="es-tag">${e}</span>`).join('');
  } else { sum.style.display='none'; }
  updateTriggerBranches(node);
}

// ══════════════════════════════════════════════════
//  DELETE NODE — confirm for fork nodes, soft-delete others
// ══════════════════════════════════════════════════
let pendingDeleteId = null;

function deleteNode(id) {
  const node = getNode(id);
  if (!node) return;
  snapshot();  // save before any mutation

  const isTrigger = node.type === 'trigger' || node.type === 'schedule';
  const isFork    = DEFS[node.type]?.fork;

  if (isTrigger || isFork) {
    const downstream = getDownstream(id);
    const count = downstream.filter(n => n.type !== 'placeholder').length;
    pendingDeleteId = id;

    if (isTrigger) {
      document.getElementById('confirmTitle').textContent = `Delete the trigger and reset journey?`;
      document.getElementById('confirmBody').textContent =
        `This will remove the trigger node and all ${count} connected nodes, clearing the entire canvas. You'll be able to choose a new trigger type.`;
      document.getElementById('confirmBtn').textContent = `Reset Journey`;
    } else {
      document.getElementById('confirmTitle').textContent = `Delete "${node.label}" and its branch?`;
      document.getElementById('confirmBody').textContent =
        `This will remove this node${count > 0 ? ` and ${count} downstream node${count !== 1 ? 's' : ''}` : ''} on this branch. ` +
        `To swap the event type instead, use the event selector in the properties panel.`;
      document.getElementById('confirmBtn').textContent = count > 0 ? `Delete Branch (${count + 1} nodes)` : 'Delete Node';
    }
    document.getElementById('confirmOverlay').classList.add('open');
    return;
  }

  // All other nodes: soft-delete — convert to placeholder in same slot
  executeSoftDelete(id);
}

function confirmDeleteExecute() {
  if (!pendingDeleteId) return;
  const node = getNode(pendingDeleteId);
  const isTrigger = node?.type === 'trigger' || node?.type === 'schedule';
  hideConfirm();
  executeHardDelete(pendingDeleteId);
  pendingDeleteId = null;
  // If it was the trigger, reset to gate so user picks a new trigger type
  if (isTrigger) {
    nodes = []; edges = []; nc = 0; triggerType = null;
    closePanel();
    const gate = document.getElementById('triggerGate');
    gate.style.opacity = '1'; gate.style.pointerEvents = 'all';
    render(); updateStats();
    showAlert('Canvas reset — choose a new trigger');
  }
}

function hideConfirm() {
  document.getElementById('confirmOverlay').classList.remove('open');
  pendingDeleteId = null;
}

function executeSoftDelete(id) {
  const node = getNode(id);
  if (!node) return;
  if (node.type === 'end') {
    nodes = nodes.filter(n => n.id !== id);
    edges = edges.filter(e => e.from !== id && e.to !== id);
    if (selectedId === id) closePanel();
    render(); updateStats(); showAlert('🗑 End node removed');
    return;
  }
  const inEdge = edges.find(e => e.to === id);
  const branchLabel = inEdge?.label || '';
  const outEdges = edges.filter(e => e.from === id);
  outEdges.forEach(e => {
    if (getNode(e.to)?.type === 'placeholder') nodes = nodes.filter(n => n.id !== e.to);
  });
  edges = edges.filter(e => e.from !== id);
  if (inEdge) inEdge.color = '#2e3448';
  node.type = 'placeholder';
  node.label = '';
  node.config = {};
  node.branchLabel = branchLabel;
  node.ghost = true;   // marks this as a deleted-node slot, not a fresh branch placeholder
  if (selectedId === id) closePanel();
  render(); updateStats(); showAlert('🗑 Node removed — slot kept open');
}

function executeHardDelete(id) {
  const downstream = getDownstream(id);
  const toRemove = new Set([id, ...downstream.map(n => n.id)]);
  nodes = nodes.filter(n => !toRemove.has(n.id));
  edges = edges.filter(e => !toRemove.has(e.from) && !toRemove.has(e.to));
  if (selectedId && toRemove.has(selectedId)) closePanel();
  render(); updateStats();
  showAlert(`🗑 Branch deleted — ${toRemove.size} node${toRemove.size !== 1 ? 's' : ''} removed`);
}

function getDownstream(startId) {
  const visited = new Set();
  const queue = [startId];
  while (queue.length) {
    const cur = queue.shift();
    edges.filter(e => e.from === cur).forEach(e => {
      if (!visited.has(e.to)) { visited.add(e.to); queue.push(e.to); }
    });
  }
  return nodes.filter(n => visited.has(n.id));
}

// ══════════════════════════════════════════════════
//  CLEAR
// ══════════════════════════════════════════════════
function clearCanvas() {
  snapshot();
  nodes=[]; edges=[]; selectedId=null; triggerType=null; nc=0;
  closePanel();
  const gate = document.getElementById('triggerGate');
  gate.style.opacity='1'; gate.style.pointerEvents='all';
  render(); updateStats(); showAlert('🗑 Canvas cleared');
}

// ══════════════════════════════════════════════════
//  VALIDATE
// ══════════════════════════════════════════════════
function validateJourney() {
  const issues = [];
  const real = nodes.filter(n => n.type !== 'placeholder');

  if (real.length < 2) { issues.push({t:'error', msg:'Journey needs at least 2 nodes'}); }

  // Disconnected non-trigger, non-placeholder nodes
  real.forEach(n => {
    if (n.type === 'trigger' || n.type === 'schedule') return;
    const hasIncoming = edges.some(e => e.to === n.id);
    if (!hasIncoming) issues.push({t:'warn', msg:`"${n.label}" has no incoming connection`});
  });

  // Fork nodes with no outgoing real connections
  real.filter(n => DEFS[n.type]?.fork).forEach(n => {
    const realOut = edges.filter(e => e.from === n.id && getNode(e.to)?.type !== 'placeholder');
    if (realOut.length === 0) issues.push({t:'warn', msg:`"${n.label}" has no connected branches yet`});
  });

  // No End node
  if (!real.some(n => n.type === 'end')) issues.push({t:'warn', msg:'No End node — some branches may be open-ended'});

  const body = document.getElementById('valBody');
  if (issues.length === 0) {
    body.innerHTML = `<div class="val-item ok"><div class="val-dot"></div>Journey looks good — ready to publish</div>`;
  } else {
    body.innerHTML = issues.map(i => `<div class="val-item ${i.t}"><div class="val-dot"></div>${i.msg}</div>`).join('');
  }
  document.getElementById('valToast').style.display = 'block';
}

// ══════════════════════════════════════════════════
//  PUBLISH
// ══════════════════════════════════════════════════
function publishJourney() {
  validateJourney();
  const toast = document.getElementById('valToast');
  const hasErrors = document.querySelectorAll('.val-item.error').length > 0;
  if (hasErrors) { showAlert('⛔ Fix errors before publishing'); return; }
  document.getElementById('statusDot').style.background = '#22c55e';
  document.getElementById('statusLabel').textContent = 'Live';
  document.getElementById('bStatus').textContent = 'Published — live';
  toast.style.display = 'none';
  showAlert('🚀 Journey published!');
}

// ══════════════════════════════════════════════════
//  CANVAS INTERACTION — pan + zoom
//  Pan: click+drag on background OR hold Space + drag anywhere
//  Zoom: scroll wheel (toward cursor)
// ══════════════════════════════════════════════════
const canvasWrap = document.getElementById('canvasWrap');
let isPanning = false;
let panStart = {x:0, y:0};
let panOrigin = {x:0, y:0};
let spaceDown = false;
let didPan = false;  // track if we actually moved (to suppress click)

// Space bar enables pan mode anywhere on canvas
document.addEventListener('keydown', e => {
  // Undo / Redo
  if ((e.ctrlKey || e.metaKey) && e.code === 'KeyZ' && !e.shiftKey) {
    e.preventDefault(); undo(); return;
  }
  if ((e.ctrlKey || e.metaKey) && (e.code === 'KeyY' || (e.code === 'KeyZ' && e.shiftKey))) {
    e.preventDefault(); redo(); return;
  }
  if (e.code === 'Space' && !e.target.closest('input,textarea,select')) {
    e.preventDefault();
    spaceDown = true;
    canvasWrap.style.cursor = 'grab';
  }
  // Delete selected node with Delete/Backspace key
  if ((e.code === 'Delete' || e.code === 'Backspace') && selectedId && !e.target.closest('input,textarea,select')) {
    deleteNode(selectedId);
  }
});
document.addEventListener('keyup', e => {
  if (e.code === 'Space') {
    spaceDown = false;
    if (!isPanning) canvasWrap.style.cursor = 'default';
  }
});

// Mousedown — start pan if: space held, middle button, or clicking empty canvas
canvasWrap.addEventListener('mousedown', e => {
  // Middle mouse button always pans
  const isMiddle = e.button === 1;
  // Left click on empty canvas (not on a node/placeholder/button)
  const onEmpty = e.button === 0 && (
    e.target === canvasWrap ||
    e.target === document.getElementById('viewport') ||
    e.target === document.getElementById('connSvg') ||
    e.target.classList.contains('connections-svg')
  );
  // Left click anywhere when space is held
  const spaceClick = e.button === 0 && spaceDown;

  if (isMiddle || onEmpty || spaceClick) {
    e.preventDefault();
    isPanning = true;
    didPan = false;
    panStart = {x: e.clientX, y: e.clientY};
    panOrigin = {x: pan.x, y: pan.y};
    canvasWrap.style.cursor = 'grabbing';
  }
});

document.addEventListener('mousemove', e => {
  if (!isPanning) return;
  const dx = e.clientX - panStart.x;
  const dy = e.clientY - panStart.y;
  // Only flag as "did pan" if moved more than 3px (prevents accidental deselect)
  if (Math.abs(dx) > 3 || Math.abs(dy) > 3) didPan = true;
  pan.x = panOrigin.x + dx;
  pan.y = panOrigin.y + dy;
  applyTransform();
});

document.addEventListener('mouseup', e => {
  if (!isPanning) return;
  isPanning = false;
  canvasWrap.style.cursor = spaceDown ? 'grab' : 'default';
  // If we barely moved — treat as a deselect click on empty canvas
  if (!didPan && (
    e.target === canvasWrap ||
    e.target === document.getElementById('viewport') ||
    e.target === document.getElementById('connSvg') ||
    e.target.classList.contains('connections-svg')
  )) {
    closePanel();
  }
});

// ── ZOOM — wheel toward cursor ──
canvasWrap.addEventListener('wheel', e => {
  e.preventDefault();
  // Normalise delta across devices (trackpad sends small floats, mouse wheel sends 100+)
  const rawDelta = e.deltaY;
  // Map to a consistent zoom factor regardless of device speed
  const zoomSpeed = 0.001;
  const factor = Math.pow(2, -rawDelta * zoomSpeed);  // smooth exponential
  const clampedFactor = Math.min(Math.max(factor, 0.85), 1.2); // max 20% per event

  const rect = canvasWrap.getBoundingClientRect();
  const mx = e.clientX - rect.left;
  const my = e.clientY - rect.top;

  const newScale = Math.min(Math.max(scale * clampedFactor, 0.15), 4);
  const actualFactor = newScale / scale;

  pan.x = mx - (mx - pan.x) * actualFactor;
  pan.y = my - (my - pan.y) * actualFactor;
  scale = newScale;
  applyTransform();
}, {passive: false});

function doZoom(f) {
  const rect = canvasWrap.getBoundingClientRect();
  const mx = rect.width / 2, my = rect.height / 2;
  const newScale = Math.min(Math.max(scale * f, 0.15), 4);
  const actual = newScale / scale;
  pan.x = mx - (mx - pan.x) * actual;
  pan.y = my - (my - pan.y) * actual;
  scale = newScale;
  applyTransform();
}

function fitCanvas() {
  const allNodes = nodes.filter(n => n.type !== 'placeholder' || edges.some(e => e.to === n.id));
  if (allNodes.length === 0) { scale = 1; pan = {x: 120, y: 80}; applyTransform(); return; }

  // Get actual pixel positions of all nodes
  const positions = allNodes.map(n => colRowToXY(n.col, n.row));
  const PADDING = 60;

  const minX = Math.min(...positions.map(p => p.x)) - PADDING;
  const minY = Math.min(...positions.map(p => p.y)) - PADDING;
  const maxX = Math.max(...positions.map(p => p.x)) + NODE_W + PADDING;
  const maxY = Math.max(...positions.map(p => p.y)) + NODE_H + PADDING;

  const contentW = maxX - minX;
  const contentH = maxY - minY;

  const rect = document.getElementById('canvasWrap').getBoundingClientRect();
  const scaleX = rect.width  / contentW;
  const scaleY = rect.height / contentH;
  const newScale = Math.min(scaleX, scaleY, 1.2);  // never zoom in beyond 120%

  // Centre the content in the viewport
  const newPanX = (rect.width  - contentW * newScale) / 2 - minX * newScale;
  const newPanY = (rect.height - contentH * newScale) / 2 - minY * newScale;

  scale = newScale;
  pan = {x: newPanX, y: newPanY};
  applyTransform();
}

function applyTransform() {
  document.getElementById('viewport').style.transform =
    `translate(${pan.x}px, ${pan.y}px) scale(${scale})`;
  document.getElementById('zoomLbl').textContent = Math.round(scale * 100) + '%';
}

// ══════════════════════════════════════════════════
//  SECTION TOGGLE
// ══════════════════════════════════════════════════
function toggleSec(id) {
  const el = document.getElementById('sec-'+id);
  const arr = document.getElementById('arr-'+id);
  el.classList.toggle('collapsed');
  arr.classList.toggle('open');
}

// ══════════════════════════════════════════════════
//  SEARCH FILTER
// ══════════════════════════════════════════════════
function filterNodes(q) {
  document.querySelectorAll('.node-item').forEach(el => {
    el.style.display = el.querySelector('.ni-label').textContent.toLowerCase().includes(q.toLowerCase()) ? '' : 'none';
  });
}

// ══════════════════════════════════════════════════
//  HEATMAP
// ══════════════════════════════════════════════════
function toggleHeatmap() {
  heatmapOn = !heatmapOn;
  document.getElementById('hmSwitch').className = 'toggle-sw' + (heatmapOn ? '' : ' off');
  render(); showAlert(heatmapOn ? '🟢 Heatmap on' : '⭕ Heatmap off');
}

// ══════════════════════════════════════════════════
//  UTILS
// ══════════════════════════════════════════════════
function newId() { return 'n' + (++nc); }
function getNode(id) { return nodes.find(n => n.id === id); }
function updateStats() { document.getElementById('bNodes').textContent = nodes.filter(n=>n.type!=='placeholder').length; }

let alertTimer;
function showAlert(msg) {
  const bar = document.getElementById('alertBar');
  bar.textContent = msg; bar.style.display = 'block';
  clearTimeout(alertTimer);
  alertTimer = setTimeout(()=>bar.style.display='none', 2600);
}

// ══════════════════════════════════════════════════
//  DEMO LOAD
// ══════════════════════════════════════════════════
function loadDemo() {
  triggerType = 'realtime';
  const gate = document.getElementById('triggerGate');
  gate.style.opacity='0'; gate.style.pointerEvents='none';

  // Layout: BRANCH_GAP=2 between every sibling branch
  // Trigger at row 5 (midpoint between deposit-branch rows 2 and game-branch rows 8)
  // Deposit branch centred at row 2: event-split forks to rows 1 (Yes) and 3 (No)
  // Game round branch centred at row 8: random splits to rows 6, 8, 10
  const demoNodes = [
    {id:'n1',  type:'trigger',     col:0, row:5,  label:'Real-time Trigger',  config:{events:['Deposit','Game Round']}},
    // ── Deposit branch ──
    {id:'n2',  type:'rtmsg',       col:1, row:2,  label:'Player Message',     config:{}},
    {id:'n3',  type:'event-split', col:2, row:2,  label:'Event Split',        config:{}},
    {id:'n4',  type:'bonus',       col:3, row:1,  label:'Add Bonus',          config:{}},
    {id:'n5',  type:'wait',        col:4, row:1,  label:'Wait 24h',           config:{}},
    {id:'n6',  type:'end',         col:5, row:1,  label:'End',                config:{}},
    {id:'n7',  type:'end',         col:3, row:3,  label:'End',                config:{}},
    // ── Game Round branch ──
    {id:'n8',  type:'rtmsg',       col:1, row:8,  label:'Player Message',     config:{}},
    {id:'n9',  type:'random',      col:2, row:8,  label:'Random Split',       config:{}},
    {id:'n10', type:'pull',        col:3, row:6,  label:'Pull Data',          config:{}},
    {id:'n11', type:'rtmsg',       col:4, row:6,  label:'Player Message',     config:{}},
    {id:'n12', type:'end',         col:5, row:6,  label:'End',                config:{}},
    {id:'n13', type:'bonus',       col:3, row:8,  label:'Add Bonus',          config:{}},
    {id:'n14', type:'wait',        col:4, row:8,  label:'Wait',               config:{}},
    {id:'n15', type:'end',         col:5, row:8,  label:'End',                config:{}},
    {id:'n16', type:'skin',        col:3, row:10, label:'Game Skin On',       config:{}},
    {id:'n17', type:'rtmsg',       col:4, row:10, label:'Player Message',     config:{}},
    {id:'n18', type:'end',         col:5, row:10, label:'End',                config:{}},
  ];

  const demoEdges = [
    {from:'n1', to:'n2',  label:'Deposit',     color:'#4ade80'},
    {from:'n1', to:'n8',  label:'Game Round',  color:'#4ade80'},
    {from:'n2', to:'n3',  label:'',            color:'#60a5fa'},
    {from:'n3', to:'n4',  label:'Yes',         color:'#4ade80'},
    {from:'n3', to:'n7',  label:'No',          color:'#f87171'},
    {from:'n4', to:'n5',  label:'',            color:'#60a5fa'},
    {from:'n5', to:'n6',  label:'',            color:'#60a5fa'},
    {from:'n8', to:'n9',  label:'',            color:'#60a5fa'},
    {from:'n9', to:'n10', label:'33%',         color:'#fb923c'},
    {from:'n9', to:'n13', label:'33%',         color:'#fb923c'},
    {from:'n9', to:'n16', label:'33%',         color:'#fb923c'},
    {from:'n10',to:'n11', label:'',            color:'#60a5fa'},
    {from:'n11',to:'n12', label:'',            color:'#60a5fa'},
    {from:'n13',to:'n14', label:'',            color:'#60a5fa'},
    {from:'n14',to:'n15', label:'',            color:'#60a5fa'},
    {from:'n16',to:'n17', label:'',            color:'#60a5fa'},
    {from:'n17',to:'n18', label:'',            color:'#60a5fa'},
  ];

  nodes = demoNodes; edges = demoEdges; nc = 20;
  pan = {x:30, y:30}; scale = 0.9;
  applyTransform(); render(); updateStats();
}

// ══════════════════════════════════════════════════
//  INIT
// ══════════════════════════════════════════════════
function initCanvas(mode) {
  if (mode === 'demo') {
    loadDemo();
  } else {
    nodes = []; edges = []; nc = 0; triggerType = null;
    const gate = document.getElementById('triggerGate');
    if (gate) { gate.style.opacity = '1'; gate.style.pointerEvents = 'all'; }
    render(); updateStats();
  }
}
window.onload = () => {
  setInterval(() => {
    if (!triggerType) return;
    document.getElementById('bActive').textContent = (1200+Math.floor(Math.random()*100)).toLocaleString();
    document.getElementById('bJourney').textContent = (300+Math.floor(Math.random()*80)).toLocaleString();
    document.getElementById('bDone').textContent = (80+Math.floor(Math.random()*20)).toLocaleString();
  }, 3500);
};

</script>

</body>
</html>
